
برای تأیید اینکه برنامه‌ها و سرویس‌ها به درستی کار می‌کنند، می‌توانید از الگوی Health Endpoint Monitoring استفاده کنید. این الگو استفاده از بررسی های عملکردی را در یک برنامه مشخص می کند. ابزارهای خارجی می توانند در فواصل زمانی منظم از طریق نقاط پایانی در معرض دید به این بررسی ها دسترسی داشته باشند.

## Context and problem

نظارت بر برنامه‌های کاربردی وب و سرویس‌های بک‌اند تمرین خوبی است. نظارت کمک می کند تا اطمینان حاصل شود که برنامه ها و خدمات در دسترس هستند و به درستی کار می کنند. الزامات تجاری اغلب شامل نظارت است.  
  
گاهی اوقات نظارت بر سرویس های ابری نسبت به سرویس های داخلی دشوارتر است. یک دلیل این است که شما کنترل کاملی بر محیط میزبانی ندارید. مورد دیگر این است که خدمات معمولاً به خدمات دیگری بستگی دارد که فروشندگان پلت فرم و دیگران ارائه می دهند.  
  
عوامل زیادی بر برنامه های میزبانی ابری تأثیر می گذارد. به عنوان مثال می توان به تأخیر شبکه، عملکرد و در دسترس بودن سیستم های محاسباتی و ذخیره سازی اساسی و پهنای باند شبکه بین آنها اشاره کرد. یک سرویس می تواند به طور کامل یا جزئی به دلیل هر یک از این عوامل شکست بخورد. برای اطمینان از سطح مورد نیاز در دسترس بودن، باید در فواصل زمانی منظم بررسی کنید که خدمات شما به درستی انجام می شود. قرارداد سطح خدمات شما (SLA) ممکن است سطحی را که باید رعایت کنید مشخص کند.

## Solution

نظارت بر سلامت را با ارسال درخواست ها به نقطه پایانی در برنامه خود اجرا کنید. برنامه باید بررسی های لازم را انجام دهد و سپس وضعیت خود را نشان دهد.  
  
* چک پایش سلامت معمولاً دو عامل را ترکیب می کند:  
  
* بررسی هایی (در صورت وجود) که برنامه یا سرویس در پاسخ به درخواست به نقطه پایانی تأیید سلامت انجام می دهد  

تجزیه و تحلیل نتایج توسط ابزار یا چارچوبی که بررسی تأیید سلامت را انجام می دهد  

کد پاسخ وضعیت برنامه را نشان می دهد. به صورت اختیاری، کد پاسخ همچنین وضعیت اجزا و خدماتی را که برنامه استفاده می کند ارائه می دهد. ابزار یا چارچوب مانیتورینگ بررسی تأخیر یا زمان پاسخ را انجام می دهد.  
  
شکل زیر نمای کلی الگو را نشان می دهد.

![[Pasted image 20231205110002.png]]

کد نظارت بر سلامت در برنامه همچنین ممکن است بررسی های دیگری را برای تعیین موارد زیر انجام دهد:  
  
* در دسترس بودن و زمان پاسخگویی فضای ذخیره سازی ابری یا پایگاه داده.  
* وضعیت سایر منابع یا خدماتی که برنامه از آنها استفاده می کند. این منابع و خدمات ممکن است در برنامه یا خارج از آن باشند.  
سرویس‌ها و ابزارهایی در دسترس هستند که برنامه‌های وب را با ارسال درخواست به مجموعه‌ای از نقاط پایانی قابل تنظیم نظارت می‌کنند. این سرویس ها و ابزارها سپس نتایج را بر اساس مجموعه ای از قوانین قابل تنظیم ارزیابی می کنند. ایجاد یک نقطه پایانی سرویس تنها با هدف انجام برخی آزمایشات عملکردی روی یک سیستم نسبتاً آسان است.  
  
بررسی‌های معمولی که ابزارهای نظارت انجام می‌دهند عبارتند از:

* اعتبار سنجی کد پاسخ به عنوان مثال، پاسخ HTTP 200 (OK) نشان می دهد که برنامه بدون خطا پاسخ داده است. سیستم نظارت همچنین ممکن است کدهای پاسخ دیگر را برای ارائه نتایج جامع تر بررسی کند.  
* بررسی محتوای پاسخ برای تشخیص خطا، حتی زمانی که کد وضعیت 200 باشد (OK). با بررسی محتوا، می توانید خطاهایی را شناسایی کنید که فقط بر بخشی از صفحه وب برگشتی یا پاسخ سرویس تأثیر می گذارد. به عنوان مثال، ممکن است عنوان یک صفحه را بررسی کنید یا به دنبال عبارت خاصی بگردید که نشان می دهد برنامه صفحه صحیح را برگردانده است.  
* اندازه گیری زمان پاسخگویی این مقدار شامل تأخیر شبکه و زمانی است که برنامه برای صدور درخواست صرف کرده است. افزایش مقدار می تواند نشان دهنده یک مشکل در حال ظهور در برنامه یا شبکه باشد.  
* بررسی منابع یا خدماتی که خارج از برنامه قرار دارند. یک مثال یک شبکه تحویل محتوا است که برنامه از آن برای ارائه محتوا از حافظه پنهان جهانی استفاده می کند.  
* بررسی انقضای گواهینامه های TLS.  
* اندازه گیری زمان پاسخ جستجوی DNS برای URL برنامه. این بررسی تاخیر DNS و خرابی های DNS را اندازه گیری می کند.  
* اعتبار سنجی URL که جستجوی DNS برمی گرداند. با اعتبارسنجی، می توانید از صحیح بودن ورودی ها اطمینان حاصل کنید. همچنین می توانید از تغییر مسیر درخواست های مخربی که ممکن است پس از حمله به سرور DNS شما ایجاد شود، کمک کنید.

در صورت امکان، اجرای این بررسی‌ها از محل‌های مختلف داخلی یا مکان‌های میزبانی شده و سپس مقایسه زمان‌های پاسخ نیز مفید است. در حالت ایده‌آل، شما باید برنامه‌های کاربردی را از مکان‌هایی که نزدیک به مشتریان هستند نظارت کنید. سپس دید دقیقی از عملکرد از هر مکان دریافت می کنید. این عمل مکانیزم بررسی قوی تری را فراهم می کند. نتایج همچنین می تواند به شما در تصمیم گیری های زیر کمک کند:  
  
* کجا برنامه خود را مستقر کنید  
* اینکه آیا آن را در بیش از یک مرکز داده مستقر کنیم  

برای اطمینان از اینکه برنامه شما برای همه مشتریان به درستی کار می کند، آزمایش هایی را بر روی تمام نمونه های خدماتی که مشتریان استفاده می کنند، اجرا کنید. برای مثال، اگر فضای ذخیره‌سازی مشتری در بیش از یک حساب ذخیره‌سازی توزیع شده باشد، فرآیند نظارت باید هر حساب را بررسی کند.


-------------
p1
-------------

## Issues and considerations

هنگام تصمیم گیری در مورد نحوه اجرای این الگو به نکات زیر توجه کنید:  
  
* به این فکر کنید که چگونه پاسخ را تأیید کنید. به عنوان مثال، تعیین کنید که آیا یک کد وضعیت 200 (OK) برای تأیید درستی کارکرد برنامه کافی است یا خیر. بررسی کد وضعیت حداقل اجرای این الگو است. کد وضعیت یک معیار اساسی از در دسترس بودن برنامه را ارائه می دهد. اما یک کد اطلاعات کمی در مورد عملیات، روندها و مشکلات احتمالی آینده در برنامه ارائه می دهد.  
  
* تعداد نقاط پایانی برای نمایش یک برنامه را تعیین کنید. یک رویکرد این است که حداقل یک نقطه پایانی برای سرویس‌های اصلی که برنامه استفاده می‌کند و دیگری برای سرویس‌های با اولویت پایین‌تر در معرض نمایش قرار گیرد. با این رویکرد، می توانید سطوح مختلفی از اهمیت را به هر نتیجه مانیتورینگ اختصاص دهید. همچنین افشای نقاط پایانی اضافی را در نظر بگیرید. می‌توانید برای هر سرویس اصلی، یکی را در معرض دید قرار دهید تا جزئیات نظارت را افزایش دهید. برای مثال، یک بررسی تأیید سلامت ممکن است پایگاه داده، فضای ذخیره‌سازی و یک سرویس کدگذاری جغرافیایی خارجی را که یک برنامه از آن استفاده می‌کند، بررسی کند. هر کدام ممکن است به سطح متفاوتی از زمان کار و زمان پاسخ نیاز داشته باشند. ممکن است سرویس رمزگذاری جغرافیایی یا برخی کارهای پس زمینه دیگر برای چند دقیقه در دسترس نباشد. اما ممکن است برنامه هنوز سالم باشد.  
  
* تصمیم بگیرید که آیا از همان نقطه پایانی برای نظارت و دسترسی عمومی استفاده کنید یا خیر. می‌توانید از یک نقطه پایانی برای هر دو استفاده کنید، اما مسیر خاصی را برای بررسی تأیید سلامت طراحی کنید. به عنوان مثال، می توانید از /health در نقطه پایانی دسترسی عمومی استفاده کنید. با این رویکرد، ابزارهای نظارتی می توانند برخی از تست های عملکردی را در برنامه اجرا کنند. به عنوان مثال می توان به ثبت نام کاربر جدید، ورود به سیستم و ثبت سفارش آزمایشی اشاره کرد. در همان زمان، همچنین می توانید تأیید کنید که نقطه پایانی دسترسی عمومی در دسترس است.  
  
* نوع اطلاعات جمع آوری شده در سرویس را در پاسخ به درخواست های نظارتی تعیین کنید. همچنین باید نحوه بازگرداندن این اطلاعات را تعیین کنید. اکثر ابزارها و چارچوب‌های موجود فقط به کد وضعیت HTTP که نقطه پایانی برمی‌گرداند نگاه می‌کنند. برای بازگرداندن و تأیید اعتبار اطلاعات اضافی، ممکن است لازم باشد یک ابزار یا سرویس نظارتی سفارشی ایجاد کنید.  
  
* مشخص کنید چه مقدار اطلاعات باید جمع آوری کنید. انجام پردازش بیش از حد در حین بررسی می تواند برنامه را بیش از حد بارگذاری کند و سایر کاربران را تحت تأثیر قرار دهد. زمان پردازش ممکن است از مهلت زمانی سیستم نظارت نیز بیشتر شود. در نتیجه، سیستم ممکن است برنامه را به عنوان غیرقابل دسترس علامت گذاری کند. اکثر برنامه ها شامل ابزار دقیقی مانند کنترل کننده خطا و شمارشگر عملکرد هستند. این ابزارها می توانند عملکرد و اطلاعات دقیق خطا را ثبت کنند که ممکن است کافی باشد. به جای بازگرداندن اطلاعات اضافی از بررسی تأیید سلامت، از این داده ها استفاده کنید.  
  
* ذخیره کردن وضعیت نقطه پایانی را در نظر بگیرید. انجام مکرر چک سلامت ممکن است گران باشد. به عنوان مثال، اگر وضعیت سلامت از طریق داشبورد گزارش شود، نمی‌خواهید هر درخواستی به داشبورد انجام شود تا بررسی سلامتی را آغاز کند. در عوض، به طور دوره ای سلامت سیستم را بررسی کنید و وضعیت را در حافظه پنهان ذخیره کنید. نقطه پایانی را که وضعیت ذخیره شده در حافظه پنهان را برمی گرداند، در معرض نمایش قرار دهید.  
  
* نحوه پیکربندی امنیت برای نقاط پایانی نظارت را برنامه ریزی کنید. با پیکربندی امنیت، می‌توانید به محافظت از نقاط پایانی در برابر دسترسی عمومی کمک کنید، که ممکن است:  
  
	* برنامه را در معرض حملات مخرب قرار دهید.  
	* قرار گرفتن در معرض اطلاعات حساس را در معرض خطر قرار دهید.  
	* حملات انکار سرویس (DoS) را جذب کنید.  

به طور معمول، شما امنیت را در پیکربندی برنامه پیکربندی می کنید. سپس می توانید بدون راه اندازی مجدد برنامه، تنظیمات را به راحتی به روز کنید. استفاده از یک یا چند تکنیک زیر را در نظر بگیرید:  



* با نیاز به احراز هویت، نقطه پایانی را ایمن کنید. اگر سرویس یا ابزار نظارت از احراز هویت پشتیبانی می کند، می توانید از یک کلید امنیتی احراز هویت در هدر درخواست استفاده کنید. شما همچنین می توانید اعتبارنامه را با درخواست ارسال کنید. هنگامی که از احراز هویت استفاده می کنید، نحوه دسترسی به نقاط پایانی بررسی سلامت خود را در نظر بگیرید. به عنوان مثال، Azure App Service دارای یک بررسی سلامت داخلی است که با ویژگی های احراز هویت و مجوز App Service یکپارچه می شود.  
  
* از یک نقطه پایانی مبهم یا پنهان استفاده کنید. به عنوان مثال، نقطه پایانی را در یک آدرس IP متفاوت از آدرسی که URL برنامه پیش فرض استفاده می کند، نشان دهید. نقطه پایانی را روی یک پورت HTTP غیر استاندارد پیکربندی کنید. همچنین، از یک مسیر پیچیده برای صفحه آزمایشی خود استفاده کنید. معمولاً می‌توانید آدرس‌ها و پورت‌های نقطه پایانی اضافی را در پیکربندی برنامه مشخص کنید. در صورت لزوم، می توانید ورودی هایی را برای این نقاط پایانی به سرور DNS اضافه کنید. سپس از تعیین مستقیم آدرس IP اجتناب می کنید.  
  
* روشی را در نقطه پایانی نشان دهید که پارامتری مانند مقدار کلید یا مقدار حالت عملیات را می پذیرد. زمانی که درخواستی می رسد، کد می تواند تست های خاصی را اجرا کند که به مقدار پارامتر بستگی دارد. اگر کد مقدار پارامتر را تشخیص ندهد، می تواند خطای 404 (Not Found) را برگرداند. امکان تعریف مقادیر پارامتر در پیکربندی برنامه را فراهم کنید.  
  
	* از یک نقطه پایانی جداگانه استفاده کنید که تست های عملکردی اولیه را بدون به خطر انداختن عملکرد برنامه انجام می دهد. با این رویکرد، می توانید به کاهش تأثیر حمله DoS کمک کنید. در حالت ایده آل، از استفاده از آزمایشی که ممکن است اطلاعات حساس را در معرض دید قرار دهد، خودداری کنید. گاهی اوقات باید اطلاعاتی را برگردانید که ممکن است برای یک مهاجم مفید باشد. در این مورد، نحوه محافظت از نقطه پایانی و داده ها از دسترسی غیرمجاز را در نظر بگیرید. تکیه بر ابهام کافی نیست. همچنین استفاده از اتصال HTTPS و رمزگذاری داده های حساس را در نظر بگیرید، اگرچه این رویکرد بار روی سرور را افزایش می دهد.  
  
	* تصمیم بگیرید که چگونه از عملکرد صحیح عامل نظارت اطمینان حاصل کنید. یک روش این است که نقطه پایانی را در معرض دید قرار دهید که مقداری را از پیکربندی برنامه برمی گرداند یا یک مقدار تصادفی را که می توانید برای آزمایش عامل استفاده کنید. همچنین اطمینان حاصل کنید که سیستم مانیتورینگ خود را بررسی می کند. برای جلوگیری از صدور نتایج مثبت کاذب توسط سیستم مانیتورینگ، می توانید از خودآزمایی یا تست داخلی استفاده کنید.


------------
p2
----------------




## When to use this pattern

این الگوی برای:

* نظارت بر وب سایت ها و برنامه های وب برای تأیید در دسترس بودن.
* نظارت بر وب سایت ها و برنامه های وب برای بررسی عملکرد صحیح.
* نظارت بر خدمات سطح متوسط یا مشترک برای تشخیص و جداسازی خرابی هایی که می تواند سایر برنامه ها را مختل کند.
* تکمیل ابزار دقیق موجود در برنامه ، مانند پیشخوان های عملکرد و دستگیره های خطا. بررسی تأیید سلامت جایگزین الزامات برنامه برای ورود به سیستم و حسابرسی نیست. ابزار دقیق می تواند اطلاعات ارزشمندی را برای یک چارچوب موجود فراهم کند که بر پیشخوان ها و سیاهههای مربوط به خطا نظارت می کند تا خرابی ها یا سایر موارد را تشخیص دهد. اما در صورت عدم دسترسی به برنامه ، ابزار دقیق نمی تواند اطلاعاتی را ارائه دهد.

## Example

می‌توانید از میان‌افزار و کتابخانه‌های بررسی سلامت ASP.NET برای گزارش سلامت مؤلفه‌های زیرساخت برنامه استفاده کنید. این چارچوب راهی برای گزارش بررسی های سلامت به روشی ثابت ارائه می دهد. بسیاری از شیوه هایی را که این مقاله توضیح می دهد، اجرا می کند. به عنوان مثال، بررسی های سلامت ASP.NET شامل بررسی های خارجی مانند اتصال به پایگاه داده و مفاهیم خاصی مانند کاوشگرهای زنده بودن و آمادگی است.  
  
چندین نمونه پیاده سازی که از بررسی های سلامت ASP.NET استفاده می کنند در GitHub در دسترس هستند.

## Monitor endpoints in Azure-hosted applications

گزینه های نظارت بر نقاط پایانی در برنامه های لاجورد شامل موارد زیر است:  
  
* از ویژگی های نظارت داخلی لاجورد مانند مانیتور لاجورد استفاده کنید.  
* از یک سرویس شخص ثالث یا چارچوبی مانند مدیر عملیات مرکز Microsoft System استفاده کنید.  
* یک ابزار سفارشی یا خدماتی را ایجاد کنید که روی سرور شخصی شما یا یک سرور میزبان اجرا شود.  


حتی اگر Azure گزینه های نظارتی جامع را ارائه دهد ، می توانید از خدمات و ابزارهای اضافی برای ارائه اطلاعات اضافی استفاده کنید. Insights Application ، یکی از ویژگی های مانیتور ، برای تیم های توسعه طراحی شده است. این ویژگی به شما کمک می کند تا نحوه عملکرد برنامه و نحوه استفاده از آن را درک کنید. مانیتورهای بینش برنامه ، نرخ پاسخ ، زمان پاسخ ، نرخ خرابی و نرخ وابستگی را درخواست می کنند. این می تواند به شما کمک کند تا تعیین کنید که آیا خدمات خارجی شما را کند می کند یا خیر.  
  
شرایطی که می توانید نظارت کنید به مکانیسم میزبانی که برای برنامه خود انتخاب می کنید بستگی دارد. کلیه گزینه های موجود در این بخش از قوانین هشدار پشتیبانی می کند. یک قانون هشدار از یک نقطه پایانی وب استفاده می کند که در تنظیمات خدمات خود مشخص می کنید. این نقطه پایانی باید به موقع پاسخ دهد تا سیستم هشدار بتواند تشخیص دهد که برنامه به درستی کار می کند. برای اطلاعات بیشتر ، به ایجاد یک قانون هشدار جدید مراجعه کنید.  
  
در صورت بروز قطع اصلی ، ترافیک مشتری باید برای استقرار درخواست که در مناطق دیگر یا مناطق موجود است ، قابل استفاده باشد. این وضعیت مورد خوبی برای اتصال متقابل و تعادل بار جهانی است. انتخاب بستگی به این دارد که برنامه داخلی یا خارجی باشد. خدماتی از قبیل درب ورودی لاجورد ، مدیر ترافیک لاجورد یا شبکه های تحویل محتوا می توانند بر اساس داده هایی که پروب های بهداشتی ارائه می دهند ، ترافیک را در مناطق مختلف مسیریابی کنند.  
  
مدیر ترافیک یک سرویس مسیریابی و متعادل کردن بار است. این می تواند از طیف وسیعی از قوانین و تنظیمات برای توزیع درخواست ها در موارد خاص برنامه شما استفاده کند. علاوه بر اینکه درخواست های مسیریابی ، مدیر ترافیک می تواند به طور مرتب URL ، PORT و مسیر نسبی را پیگیری کند. شما اهداف پینگ را با هدف تعیین اینکه کدام نمونه از برنامه شما فعال است و به درخواست ها پاسخ می دهد ، مشخص می کنید. اگر مدیر ترافیک کد وضعیت 200 (OK) را تشخیص دهد ، این برنامه را به صورت موجود مشخص می کند. هر کد وضعیت دیگر باعث می شود مدیر ترافیک برنامه را به صورت آفلاین علامت گذاری کند. کنسول مدیر ترافیک وضعیت هر برنامه را نشان می دهد. شما می توانید هر قانون را برای درخواست مجدد درخواست های دیگر به موارد دیگر برنامه که پاسخ می دهند پیکربندی کنید.  
  
مدیر ترافیک منتظر زمان معینی برای دریافت پاسخ از URL نظارت است. اطمینان حاصل کنید که کد تأیید سلامتی شما در این زمان اجرا می شود. برای سفر دور از مدیر ترافیک به برنامه خود و دوباره برگرداندن شبکه اجازه دهید.

## Next steps

The following guidance is useful for implementing this pattern:

- [Health monitoring guidance in microservices-based applications](https://learn.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/monitor-app-health)
- [Monitoring application health for reliability](https://learn.microsoft.com/en-us/azure/architecture/framework/resiliency/monitoring), part of the Azure Well-Architected Framework
- [Create a new alert rule](https://learn.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-create-new-alert-rule?tabs=metric)

[](https://learn.microsoft.com/en-us/azure/architecture/patterns/health-endpoint-monitoring#related-resources)

## Related resources

- [External Configuration Store pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/external-configuration-store)
- [Circuit Breaker pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/circuit-breaker)
- [Gateway Routing pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/gateway-routing)
- [Gatekeeper pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/gatekeeper)