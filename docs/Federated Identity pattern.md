احراز هویت را به یک ارائه دهنده identity provider  واگذار کنید. این می تواند توسعه را ساده‌تر کند، نیاز به مدیریت کاربر را به حداقل برساند و تجربه کاربری برنامه را بهبود بخشد.

## Context and problem

کاربران معمولاً نیاز به کار با چندین برنامه دارند که توسط سازمان‌های مختلفی که با آنها رابطه تجاری دارند، ارائه و میزبانی می‌شوند. ممکن است از این کاربران خواسته شود که از اعتبارنامه های (credentials) خاص (و متفاوت) برای هر یک استفاده کنند. این می تواند:



باعث ایجاد یک تجربه کاربری ناخوشایند شود به خصوص هنگامی که کاربران دارای اعتبارنامه های مختلف هستند، اغلب sign-in credentials به سیستم را فراموش می کنند.  
  
آسیب پذیری های امنیتی را افزایش دهد. هنگامی که یک کاربر شرکت را ترک می کند، حساب باید فوراً لغو شود. نادیده گرفتن این موضوع در سازمان های بزرگ آسان است.  
  
پیچیده کردن **user management**. در واقع Administrators باید credentials را برای همه کاربران مدیریت کنند و کارهای اضافی مانند ارائه یادآوری رمز عبور را انجام دهند.

کاربران معمولاً ترجیح می دهند از اعتبار(credentials) یکسانی برای همه این برنامه ها استفاده کنند.




## Solution

یک مکانیسم احراز هویت را پیاده سازی کنید که می تواند از هویت فدرال(federated) استفاده کند. احراز هویت کاربر را از کد برنامه جدا کنید و احراز هویت را به یک ارائه دهنده هویت قابل اعتماد واگذار کنید. این می تواند توسعه را ساده کند و به کاربران اجازه دهد تا با استفاده از طیف وسیع تری از ارائه دهندگان هویت (IdP) احراز هویت کنند و در عین حال هزینه های اداری را به حداقل برساند. همچنین به شما این امکان را می دهد که به وضوح احراز هویت (authentication) را از مجوز(authorization) جدا کنید.  
  
ارائه‌دهندگان هویت مورد اعتماد شامل دایرکتوری‌های شرکتی، on-premises federation services، سایر security token services (STS) ارائه‌شده توسط شرکای تجاری یا ارائه‌دهندگان هویت social identity هستند که می‌توانند کاربرانی را که مثلاً دارای حساب کاربری Microsoft، Google، Yahoo! یا Facebook هستند، احراز هویت کنند.  
  
شکل زیر الگوی هویت فدرال (Federated Identity) را در زمانی که یک client application نیاز به دسترسی به سرویسی دارد که نیاز به احراز هویت دارد را نشان می دهد. احراز هویت توسط یک IdP که در هماهنگی با STS کار می کند انجام می شود. IdP توکن‌های امنیتی صادر می‌کند که اطلاعاتی در مورد کاربر تأیید شده ارائه می‌کند. این اطلاعات، که به عنوان claims نامیده می شود، شامل هویت کاربر است و همچنین ممکن است شامل اطلاعات دیگری مانند role membership و granular access دقیق تر باشد.

![[Pasted image 20230821171911.png]]

این مدل اغلب  claims-based access control نامیده می شود. برنامه‌ها و سرویس‌ها بر اساس ادعاهای موجود در توکن، اجازه دسترسی به ویژگی‌ها و عملکرد را می‌دهند. سرویسی که نیاز به احراز هویت دارد باید به IdP اعتماد کند. برنامه مشتری با IdP که احراز هویت را انجام می دهد تماس می گیرد. اگر احراز هویت موفقیت آمیز باشد، IdP یک توکن حاوی claims که کاربر را به STS شناسایی می کند، برمی گرداند (توجه داشته باشید که IdP و STS می توانند یک سرویس باشند). STS می تواند claim های موجود در توکن را بر اساس قوانین از پیش تعریف شده، قبل از بازگرداندن آن به client، تبدیل و تکمیل کند. سپس برنامه کلاینت می تواند این نشانه را به عنوان اثبات هویت خود به سرویس ارسال کند.

ممکن استsecurity token services اضافی در دنباله ای از trustها وجود داشته باشد. به عنوان مثال، در سناریویی که بعدا توضیح داده شد، یک STS داخلی به STS دیگری اعتماد می کند که مسئول دسترسی به یک identity provider برای احراز هویت کاربر است. این رویکرد در سناریوهای سازمانی که در آن on-premises STS و directory وجود دارد رایج است.


احراز هویت فدرال (Federated authentication) راه حلی مبتنی بر استانداردها را برای مسئله اعتماد به هویت (trusting identities) در دامنه های مختلف ارائه می دهد و می تواند از یک ورود به سیستم پشتیبانی کند. این نوع احراز هویت در همه انواع برنامه‌ها، به‌ویژه برنامه‌های میزبانی شده در فضای ابری رایج‌تر می‌شود، زیرا از یک ورود بدون نیاز به اتصال مستقیم شبکه به ارائه‌دهندگان هویت پشتیبانی می‌کند. کاربر مجبور نیست برای هر برنامه ای اعتبارنامه را وارد کند. این امر امنیت را افزایش می دهد زیرا از ایجاد اعتبار مورد نیاز برای دسترسی به بسیاری از برنامه های مختلف جلوگیری می کند و همچنین اعتبار کاربر را از همه افراد به جز ارائه دهنده هویت اصلی پنهان می کند. برنامه ها فقط اطلاعات هویت احراز هویت شده موجود در توکن را می بینند.

هویت فدرال (Federated identity) همچنین دارای این مزیت عمده است که مدیریت identity و credentials را به عهده  identity provider است. برنامه یا سرویس نیازی به ارائه ویژگی هایprovide identity management ندارد. علاوه بر این، در سناریوهای شرکتی (corporate scenarios)، دایرکتوری شرکت در صورت اعتماد به   identity provider، نیازی به اطلاع از کاربر ندارد. این کار تمام  administrative overhead مرتبط بت مدیریت هویت کاربر را حذف می کند.

## Issues and considerations


احراز هویت (Authentication) می تواند تنها یک نقطه شکست باشد. اگر application خود را بر روی چندین دیتاسنتر مستقر می کنید، مکانیسم مدیریت هویت (identity management) خود را در دیتاسنتر یکسانی برای حفظ قابلیت اطمینان و در دسترس بودن برنامه در نظر بگیرید.


ابزارهای Authentication  ممکن است  configure access control based را روی role claims  موجود در authentication token را ممکن می‌سازند. که اغلب به عنوانrole-based access control (RBAC) نامیده می شود، و می تواند سطح دقیق تری از کنترل دسترسی به ویژگی ها و منابع را فراهم کند.

بر خلاف corporate directory معمولا claims-based authentication با استفاده از  social identity providers اطلاعات بیشتری در مورد کابر احراز هویت شده به نسبت روش‌های دیگه مثلا احراز هویت فقط با email address  نمی‌دهد. برخی از  social identity providers مثل Microsoft account فقط یک identifier یکتا تولید می‌کنند.  برنامه معمولاً باید برخی از اطلاعات کاربران ثبت نام شده را حفظ کند و بتوانید این اطلاعات را با شناسه  موجود در token مطابقت دهید. معمولاً این کار از طریق ثبت نام(registration) انجام می شود، زمانی که کاربر برای اولین بار به برنامه دسترسی پیدا می کند، و اطلاعات پس از هر بار احراز هویت به عنوان additional claims به توکن تزریق می شود.

اگر بیش از یک identity provider برای STS تنظیم شده باشد ، STS باید تعیین کند که identity provider کاربر باید برای تأیید اعتبار (authentication) به آن redirected شود. این فرایند Discovery Home Realm نامیده می شود. STS ممکن است بتواند این کار را به طور خودکار بر اساس آدرس ایمیل یا نام کاربری که کاربر ارائه می دهد ، انجام دهد ، subdomain برنامه ای که کاربر به آن دسترسی دارد دارای دامنه آدرس IP کاربر یا محتوای یک کوکی ذخیره شده در کاربر مرورگر است به عنوان مثال ، اگر کاربر آدرس ایمیل را در دامنه مایکروسافت مانند user@live.com وارد کند ، STS کاربر را به صفحه ورود به حساب حساب مایکروسافت هدایت می کند. در بازدیدهای بعدی ، STS می تواند از یک کوکی استفاده کند تا نشان دهد آخرین علامت ورود به حساب مایکروسافت بود. اگر Discovery Automatic نتواند  home realm را تعیین کند ، STS یک صفحه Discovery Realm Home را نشان می دهد که  identity provider  قابل اعتماد را لیست می کند  و کاربر باید گزینه مورد نظر را انتخاب کند.



## When to use this pattern


این الگو برای سناریوهایی مانند حالت های زیر مناسب هست :


در حالت Single sign-on .
در این سناریو شما باید افراد را برای برنامه‌های کاربردی شرکتی که در فضای ابری خارج از مرز امنیتی شرکت میزبانی می‌شوند، احراز هویت کنید، بدون اینکه هر بار که از برنامه‌ای بازدید می‌کنند مجبور به ورود به سیستم شوند. تجربه کاربر مانند استفاده از برنامه‌های داخلی سازمان است که در آن هنگام ورود به شبکه شرکتی احراز هویت می‌شوند و از آن پس بدون نیاز به ورود مجدد به همه برنامه‌های مربوطه دسترسی دارند.

در حالت **Federated identity with multiple partners** 

در این سناریو شما باید هم کارمندان شرکت و هم شرکای تجاری را که حسابی در فهرست شرکتی ندارند، احراز هویت کنید. این امر در application‌های تجاری به کسب‌وکار (business-to-business) رایج است، برنامه‌هایی که با  (third-party services) یکپارچه می‌شوند و شرکت‌هایی با سیستم‌های فناوری اطلاعات مختلف ادغام یا منابع مشترک را به اشتراک گذاشته‌اند.

در حالت **Federated identity in SaaS applications**.

در این سناریو ، فروشندگان نرم افزار مستقل ( independent software vendors) یک سرویس آماده برای استفاده برای چندین مشتری  ارائه می دهند. هر مشتری با استفاده از identity provider مناسب تأیید می شود. به عنوان مثال ، کاربران تجاری از اعتبار شرکت های خود استفاده می کنند ، در حالی که مصرف کنندگان و مشتریان از اعتبار هویت اجتماعی خود استفاده می کنند.

این الگو ممکن است در شرایط زیر مفید نباشد:

همه کاربران application می توانند توسط یک  identity provider احراز هویت شوند، و هیچ نیازی به احراز هویت با استفاده از  identity provider دیگر وجود ندارد. این امر در برنامه‌های تجاری که از دایرکتوری شرکتی (قابل دسترسی در برنامه) برای احراز هویت، با استفاده از VPN یا (در سناریوی میزبان ابری) از طریق یک اتصال شبکه مجازی بین دایرکتوری داخلی و برنامه استفاده می‌کنند، معمول است.


این برنامه در ابتدا با استفاده از مکانیزم احراز هویت متفاوت ساخته شد. اضاه کردنclaims-based authentication و access control به برنامه های موجود می تواند پیچیده باشد و احتمالا مقرون به صرفه نیست.

## Example

  
یک organization hosts یک نرم افزار multi-tenant به عنوان software as a service (SaaS)  در Microsoft Azure است. این برنامه شامل وب سایتی است که کلاینت‌ها می توانند از آن برای مدیریت برنامه برای کاربران خود استفاده کنند. این برنامه به کاربران اجازه می دهد تا با استفاده از هویت فدرال که توسط Active Directory Federation Services تولید می شود، به وب سایت دسترسی پیدا کنند.


![[Pasted image 20230821183559.png]]
شکل نشان می دهد که چگونه کاربرها با identity provider خود احراز هویت می کنند (مرحله 1)، در این مورد AD FS. پس از احراز هویت موفق کاربرها، AD FS یک توکن صادر می کند. مرورگر کاربر این نشانه را به ارائه‌دهنده فدراسیون برنامه SaaS، که به توکن‌های صادر شده توسط AD FS مستاجر اعتماد می‌کند، می‌فرستد تا رمزی را که برای SaaS federation provide معتبر است، پس بگیرد (مرحله 2). در صورت لزوم،  SaaS federation provide قبل از بازگرداندن رمز یا توکن جدید به مرورگر کلاینت، claims موجود در توکن را به claims که برنامه تشخیص می‌دهد (مرحله 3) انجام می‌دهد. برنامه به توکن های صادر شده توسط SaaS federation provide اعتماد می کند و از claims موجود در توکن برای اعمال قوانین مجوز استفاده می کند (مرحله 4).  
  
کاربرها برای دسترسی به برنامه نیازی به به خاطر سپردن اعتبارنامه های(credentials) جداگانه ندارند و administrator  می تواند لیست کاربرانی را که می توانند به برنامه دسترسی داشته باشند در AD FS خود پیکربندی کند.