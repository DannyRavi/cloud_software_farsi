

نمایه هایی را بر روی فیلدهای موجود در انبارهای داده ایجاد کنید که اغلب توسط پرس و جوها به آنها ارجاع داده می شود. این الگو می تواند عملکرد پرس و جو را با اجازه دادن به برنامه های کاربردی برای مکان یابی سریعتر داده ها برای بازیابی از یک فروشگاه داده بهبود بخشد.

## Context and problem

بسیاری از فروشگاه های داده، داده ها را برای مجموعه ای از موجودیت ها با استفاده از کلید اصلی سازماندهی می کنند. یک برنامه می تواند از این کلید برای مکان یابی و بازیابی داده ها استفاده کند. شکل نمونه ای از یک فروشگاه داده را نشان می دهد که اطلاعات مشتری را در خود نگهداری می کند. کلید اصلی شناسه مشتری است. شکل، اطلاعات مشتری سازماندهی شده توسط کلید اصلی (شناسه مشتری) را نشان می دهد.

![[Pasted image 20231203223817.png]]

در حالی که کلید اولیه برای جستارهایی که داده‌ها را بر اساس مقدار این کلید واکشی می‌کنند ارزشمند است، اگر برنامه‌ای نیاز به بازیابی داده‌ها بر اساس فیلد دیگری داشته باشد، ممکن است نتواند از کلید اصلی استفاده کند. در مثال مشتریان، یک برنامه کاربردی نمی‌تواند از کلید اصلی شناسه مشتری برای بازیابی مشتریان استفاده کند، اگر داده‌ها را صرفاً با ارجاع به مقدار مشخصه‌های دیگر، مانند شهری که مشتری در آن قرار دارد، جستجو کند. برای انجام یک پرس و جو مانند این، برنامه ممکن است مجبور باشد هر رکورد مشتری را واکشی و بررسی کند، که می تواند روند کندی باشد.  
  
بسیاری از سیستم های مدیریت پایگاه داده رابطه ای از نمایه های ثانویه پشتیبانی می کنند. نمایه ثانویه یک ساختار داده جداگانه است که توسط یک یا چند فیلد کلیدی غیراصولی (ثانویه) سازماندهی شده است و نشان می دهد که داده های هر مقدار نمایه شده در کجا ذخیره می شود. موارد موجود در یک نمایه ثانویه معمولاً بر اساس مقدار کلیدهای ثانویه مرتب می شوند تا امکان جستجوی سریع داده ها فراهم شود. این فهرست ها معمولاً به طور خودکار توسط سیستم مدیریت پایگاه داده نگهداری می شوند.  
  
شما می توانید به تعداد مورد نیاز ایندکس ثانویه ایجاد کنید تا از پرس و جوهای مختلفی که برنامه شما انجام می دهد پشتیبانی کند. به عنوان مثال، در یک جدول مشتریان در یک پایگاه داده رابطه‌ای که شناسه مشتری کلید اصلی است، اگر برنامه مرتباً مشتریان را بر اساس شهر محل سکونت آنها جستجو می‌کند، افزودن یک فهرست ثانویه در قسمت شهر مفید است.  
  
با این حال، اگرچه نمایه‌های ثانویه در سیستم‌های رابطه‌ای رایج هستند، برخی از فروشگاه‌های داده NoSQL که توسط برنامه‌های ابری استفاده می‌شوند، ویژگی مشابهی را ارائه نمی‌دهند.

## Solution

اگر فروشگاه داده از نمایه‌های ثانویه پشتیبانی نمی‌کند، می‌توانید با ایجاد جداول فهرست خود، آنها را به صورت دستی شبیه‌سازی کنید. یک جدول شاخص داده ها را با یک کلید مشخص سازماندهی می کند. بسته به تعداد شاخص های ثانویه مورد نیاز و ماهیت پرس و جوهایی که یک برنامه کاربردی انجام می دهد، معمولاً از سه استراتژی برای ساختاربندی جدول شاخص استفاده می شود.  
  
اولین استراتژی این است که داده ها را در هر جدول شاخص کپی کنید اما آنها را با کلیدهای مختلف سازماندهی کنید (غیر عادی سازی کامل). شکل بعدی جداول فهرستی را نشان می دهد که اطلاعات مشتری یکسان را بر اساس شهر و نام خانوادگی سازماندهی می کند.

![[Pasted image 20231203223844.png]]

این استراتژی در صورتی مناسب است که داده ها در مقایسه با تعداد دفعاتی که با استفاده از هر کلید پرس و جو می شوند، نسبتا ثابت باشند. اگر داده‌ها پویاتر باشند، سربار پردازش نگهداری هر جدول شاخص برای این رویکرد بسیار بزرگ می‌شود که مفید نباشد. همچنین اگر حجم داده ها بسیار زیاد باشد، میزان فضای مورد نیاز برای ذخیره سازی داده های تکراری قابل توجه است.  
  
استراتژی دوم ایجاد جداول شاخص نرمال شده سازماندهی شده توسط کلیدهای مختلف و ارجاع داده های اصلی با استفاده از کلید اصلی به جای تکرار آن است، همانطور که در شکل زیر نشان داده شده است. داده های اصلی جدول واقعیت نامیده می شود.

![[Pasted image 20231203223900.png]]

این تکنیک باعث صرفه جویی در فضا و کاهش هزینه های سربار نگهداری داده های تکراری می شود. نقطه ضعف این است که یک برنامه کاربردی باید دو عملیات جستجو را برای یافتن داده ها با استفاده از یک کلید ثانویه انجام دهد. باید کلید اصلی داده ها را در جدول فهرست پیدا کند و سپس از کلید اصلی برای جستجوی داده ها در جدول واقعی استفاده کند.  
  
راهبرد سوم ایجاد جداول شاخص جزئی نرمال شده سازماندهی شده توسط کلیدهای مختلف است که فیلدهای اغلب بازیابی شده را کپی می کنند. برای دسترسی به فیلدهایی که کمتر به آنها دسترسی دارید، به جدول واقعیت مراجعه کنید. شکل بعدی نشان می‌دهد که چگونه داده‌هایی که معمولاً در دسترس هستند در هر جدول فهرست تکرار می‌شوند.

![[Pasted image 20231203223914.png]]


با این استراتژی می توانید بین دو رویکرد اول تعادل برقرار کنید. داده‌های پرس‌و‌جوهای رایج را می‌توان با استفاده از یک جستجوی واحد به سرعت بازیابی کرد، در حالی که فضا و سربار نگهداری به اندازه کپی کردن کل مجموعه داده مهم نیست.  
  
اگر برنامه‌ای اغلب با تعیین ترکیبی از مقادیر، داده‌ها را جستجو می‌کند (به عنوان مثال، «همه مشتریانی را که در ردموند زندگی می‌کنند و نام خانوادگی اسمیت دارند را بیابید»)، می‌توانید کلیدهای موارد موجود در جدول فهرست را به صورت الحاقی پیاده‌سازی کنید. از ویژگی Town و ویژگی LastName. شکل بعدی یک جدول شاخص بر اساس کلیدهای ترکیبی را نشان می دهد. کلیدها بر اساس Town و سپس برای رکوردهایی که مقدار مشابهی برای Town دارند بر اساس LastName مرتب می شوند.

![[Pasted image 20231203223947.png]]


جداول فهرست می توانند عملیات پرس و جو را بر روی داده های خرد شده سرعت بخشند و به ویژه در مواردی که کلید خرده هش شده است مفید هستند. شکل بعدی مثالی را نشان می دهد که در آن کلید خرده هش شناسه مشتری است. جدول فهرست می‌تواند داده‌ها را بر اساس مقدار غیرهش‌شده (Town و LastName) سازمان‌دهی کند و کلید هش‌شده را به‌عنوان داده جستجو ارائه دهد. این می‌تواند برنامه را از محاسبه مکرر کلیدهای هش (عملیات گران‌قیمت) نجات دهد، در صورتی که نیاز به بازیابی داده‌هایی داشته باشد که در یک محدوده قرار می‌گیرند، یا نیاز به واکشی داده‌ها به ترتیب کلید غیرهش‌شده داشته باشد. به عنوان مثال، پرس و جوی مانند 'یافتن همه مشتریانی که در ردموند زندگی می کنند' را می توان با قرار دادن موارد منطبق در جدول فهرست به سرعت حل کرد، جایی که همه آنها در یک بلوک به هم پیوسته ذخیره می شوند. سپس، ارجاعات به داده های مشتری را با استفاده از کلیدهای خرد شده ذخیره شده در جدول فهرست دنبال کنید.

![[Pasted image 20231203224012.png]]

## Issues and considerations

هنگام تصمیم گیری در مورد نحوه اجرای این الگو به نکات زیر توجه کنید:  
  
* سربار حفظ شاخص های ثانویه می تواند قابل توجه باشد. شما باید پرس و جوهایی را که برنامه شما استفاده می کند، تجزیه و تحلیل و درک کنید. جداول شاخص را فقط زمانی ایجاد کنید که احتمالاً به طور منظم از آنها استفاده می شود. برای پشتیبانی از پرس و جوهایی که یک برنامه کاربردی انجام نمی دهد یا فقط گاهی اوقات انجام می دهد، جداول ایندکس گمانه زنی ایجاد نکنید.  
  
* کپی کردن داده ها در یک جدول فهرست می تواند هزینه های ذخیره سازی و تلاش لازم برای نگهداری چندین نسخه از داده ها را افزایش دهد.  
  
* پیاده‌سازی جدول فهرست به‌عنوان یک ساختار نرمال‌شده که به داده‌های اصلی ارجاع می‌دهد، نیازمند اجرای دو عملیات جستجو برای یافتن داده‌ها است. عملیات اول جدول فهرست را برای بازیابی کلید اصلی جستجو می کند و عملیات دوم از کلید اصلی برای واکشی داده ها استفاده می کند.  
  
* اگر یک سیستم تعدادی جدول شاخص را در مجموعه داده های بسیار بزرگ ترکیب کند، حفظ سازگاری بین جداول فهرست و داده های اصلی می تواند دشوار باشد. ممکن است بتوان برنامه را بر اساس مدل سازگاری نهایی طراحی کرد. به عنوان مثال، برای درج، به‌روزرسانی یا حذف داده‌ها، یک برنامه می‌تواند پیامی را به یک صف ارسال کند و به یک کار جداگانه اجازه دهد این عملیات را انجام دهد و جداول فهرستی را که به صورت ناهمزمان به این داده‌ها ارجاع می‌دهند حفظ کند. برای اطلاعات بیشتر در مورد اجرای سازگاری نهایی، به Primer سازگاری داده مراجعه کنید.

>جداول ذخیره‌سازی Microsoft Azure از به‌روزرسانی‌های تراکنشی برای تغییرات ایجاد شده در داده‌های موجود در همان پارتیشن (که به تراکنش‌های گروه نهاد گفته می‌شود) پشتیبانی می‌کنند. اگر می‌توانید داده‌ها را برای یک جدول واقعی و یک یا چند جدول فهرست در یک پارتیشن ذخیره کنید، می‌توانید از این ویژگی برای اطمینان از سازگاری استفاده کنید.

* جداول فهرست ممکن است خود پارتیشن بندی یا خرد شده باشند.


## When to use this pattern


از این الگو برای بهبود عملکرد پرس و جو زمانی که یک برنامه اغلب نیاز به بازیابی داده ها با استفاده از کلیدی غیر از کلید اصلی (یا کلید خرده) دارد، استفاده کنید.  
  
این الگو ممکن است زمانی مفید نباشد که:  
  
* داده ها بی ثبات هستند. یک جدول شاخص می تواند خیلی سریع منسوخ شود و آن را ناکارآمد کند یا هزینه سربار نگهداری جدول شاخص را بیشتر از صرفه جویی در استفاده از آن کند.  
* فیلدی که به‌عنوان کلید ثانویه برای جدول فهرست انتخاب می‌شود، بدون تبعیض است و فقط می‌تواند مجموعه‌ای از مقادیر کوچک (مثلاً جنسیت) داشته باشد.  
* تعادل مقادیر داده برای یک فیلد انتخاب شده به عنوان کلید ثانویه برای جدول شاخص بسیار کج است. به عنوان مثال، اگر 90 درصد رکوردها دارای مقدار یکسان در یک فیلد باشند، ایجاد و نگهداری یک جدول فهرست برای جستجوی داده‌ها بر اساس این فیلد ممکن است هزینه بیشتری نسبت به اسکن متوالی داده‌ها ایجاد کند. با این حال، اگر پرس و جوها اغلب مقادیری را هدف قرار می دهند که در 10٪ باقی مانده قرار دارند، این شاخص می تواند مفید باشد. شما باید پرس و جوهایی را که برنامه شما انجام می دهد و تعداد دفعات انجام آنها را درک کنید.

## Example

جداول ذخیره‌سازی Azure یک ذخیره‌سازی کلید/مقدار بسیار مقیاس‌پذیر برای برنامه‌های در حال اجرا در ابر فراهم می‌کنند. برنامه ها با تعیین یک کلید مقادیر داده را ذخیره و بازیابی می کنند. مقادیر داده‌ها می‌توانند شامل چندین فیلد باشند، اما ساختار یک آیتم داده نسبت به ذخیره‌سازی جدول غیرشفاف است، که به سادگی یک آیتم داده را به‌عنوان آرایه‌ای از بایت‌ها مدیریت می‌کند.  
  
جداول ذخیره سازی Azure نیز از شاردینگ پشتیبانی می کنند. کلید اشتراک گذاری شامل دو عنصر، یک کلید پارتیشن و یک کلید ردیف است. مواردی که دارای کلید پارتیشن یکسان هستند در همان پارتیشن (شارد) و موارد به ترتیب کلیدهای ردیفی در یک قطعه ذخیره می شوند. ذخیره سازی جدول برای انجام پرس و جوهایی بهینه شده است که داده ها را در محدوده پیوسته ای از مقادیر کلید ردیف در یک پارتیشن واکشی می کند. اگر در حال ساخت برنامه های ابری هستید که اطلاعات را در جداول Azure ذخیره می کنند، باید داده های خود را با در نظر گرفتن این ویژگی ساختار دهید.  
  
به عنوان مثال، برنامه ای را در نظر بگیرید که اطلاعات فیلم ها را ذخیره می کند. این برنامه اغلب فیلم ها را بر اساس ژانر (اکشن، مستند، تاریخی، کمدی، درام و غیره) جستجو می کند. می توانید با استفاده از ژانر به عنوان کلید پارتیشن، و تعیین نام فیلم به عنوان کلید ردیف، همانطور که در شکل بعدی نشان داده شده است، یک جدول Azure با پارتیشن هایی برای هر ژانر ایجاد کنید.

![[Pasted image 20231203224257.png]]

اگر برنامه همچنین نیاز به پرس و جو فیلم ها توسط بازیگر داشته باشد، این رویکرد کمتر موثر است. در این حالت می توانید یک جدول Azure جداگانه ایجاد کنید که به عنوان جدول شاخص عمل می کند. کلید پارتیشن بازیگر و کلید ردیف نام فیلم است. داده های هر بازیگر در پارتیشن های جداگانه ذخیره می شود. اگر در یک فیلم بیش از یک بازیگر نقش آفرینی کند، همان فیلم در چندین پارتیشن نمایش داده می شود.  
  
می‌توانید داده‌های فیلم را در مقادیر نگه‌داشته شده توسط هر پارتیشن با اتخاذ اولین رویکردی که در بخش راه‌حل بالا توضیح داده شد، کپی کنید. با این حال، این احتمال وجود دارد که هر فیلم چندین بار تکرار شود (یک بار برای هر بازیگر)، بنابراین ممکن است کارآمدتر باشد که داده‌ها را تا حدی غیرعادی‌سازی کنیم تا از رایج‌ترین پرسش‌ها (مانند نام بازیگران دیگر) پشتیبانی شود و یک برنامه کاربردی فعال شود. برای بازیابی جزئیات باقیمانده با گنجاندن کلید پارتیشن لازم برای یافتن اطلاعات کامل در پارتیشن‌های سبک. این رویکرد توسط گزینه سوم در بخش Solution توضیح داده شده است. شکل بعدی این رویکرد را نشان می دهد.

![[Pasted image 20231203224311.png]]

## Next steps

* پرایمر سازگاری داده یک جدول شاخص باید با تغییر داده هایی که ایندکس می کند حفظ شود. در ابر، ممکن است انجام عملیاتی برای به روز رسانی یک شاخص به عنوان بخشی از همان تراکنش که داده ها را تغییر می دهد، ممکن یا مناسب نباشد. در آن صورت، یک رویکرد در نهایت سازگار مناسب تر است. اطلاعاتی در مورد مسائل مربوط به سازگاری نهایی ارائه می دهد.

## Related resources

الگوهای زیر نیز ممکن است هنگام اجرای این الگو مرتبط باشند:  
  
* الگوی شاردینگ. الگوی جدول شاخص اغلب در ارتباط با داده های تقسیم بندی شده با استفاده از خرده ها استفاده می شود. الگوی Sharding اطلاعات بیشتری در مورد نحوه تقسیم یک فروشگاه داده به مجموعه ای از خرده ها ارائه می دهد.  
* الگوی نمای مادی. به‌جای فهرست‌بندی داده‌ها برای پشتیبانی از پرسش‌هایی که داده‌ها را خلاصه می‌کنند، ممکن است بهتر باشد که یک نمای واقعی از داده‌ها ایجاد کنیم. نحوه پشتیبانی از جستارهای خلاصه کارآمد را با ایجاد نماهای از پیش پرجمعیت شده روی داده ها شرح می دهد.  
