# Quarantine 
---

 استفاده از مصنوعات (artifacts) نرم‌افزاری شخص ثالث در زنجیره تأمین خود، تنها زمانی که توسط فرآیندهای به‌خوبی تعریف‌شده، تأیید شده و به‌عنوان «ایمن برای استفاده» علامت‌گذاری شده باشند. این الگو یک «سایدکار» (همراه) عملیاتی برای فرآیند توسعه است. مصرف‌کننده‌ی این الگو، این فرآیند را برای تأیید و مسدود کردن استفاده از نرم‌افزاری که به‌طور بالقوه می‌تواند آسیب‌پذیری‌های امنیتی ایجاد کند، فراخوانی می‌کند.

**زمینه و مسئله**

راه‌حل‌های ابری اغلب به نرم‌افزارهای شخص ثالث که از منابع خارجی تهیه می‌شوند، متکی هستند. باینری‌های متن‌باز، ایمیج‌های کانتینر عمومی، و ایمیج‌های سیستم‌عامل فروشنده، نمونه‌هایی از این نوع مصنوعات هستند. تمام این مصنوعات خارجی باید به‌عنوان غیرقابل اعتماد تلقی شوند.

در یک گردش کار معمول، مصنوع از یک مخزن خارج از محدوده راه‌حل بازیابی شده و سپس در پایپ‌لاین استقرار (deployment pipeline) یکپارچه می‌شود. این رویکرد چندین مشکل بالقوه دارد. ممکن است منبع قابل اعتماد نباشد، مصنوع حاوی آسیب‌پذیری باشد، یا به هر طریق دیگری برای محیط توسعه‌دهنده مناسب نباشد.

اگر این مسائل مورد توجه قرار نگیرند، ممکن است تضمین‌های یکپارچگی و محرمانگی داده‌های راه‌حل به خطر بیفتند، یا به دلیل ناسازگاری با سایر اجزا، باعث ناپایداری شوند.

با افزودن بررسی‌ها به هر مصنوع می‌توان از برخی از این مسائل امنیتی جلوگیری کرد.

**راه‌حل**
فرآیندی داشته باشید که نرم‌افزار را قبل از معرفی به بار کاری (workload) شما از نظر امنیتی اعتبارسنجی کند. در طول این فرآیند، هر مصنوع تحت یک بررسی عملیاتی دقیق قرار می‌گیرد که آن را بر اساس شرایط خاصی تأیید می‌کند. تنها پس از اینکه مصنوع آن شرایط را برآورده کرد، فرآیند آن را به‌عنوان قابل اعتماد علامت‌گذاری می‌کند.

فرآیند قرنطینه یک اقدام امنیتی است که شامل مجموعه‌ای از نقاط بازرسی (checkpoints) است که قبل از مصرف یک مصنوع به کار گرفته می‌شوند. این نقاط بازرسی امنیتی اطمینان حاصل می‌کنند که یک مصنوع از وضعیت غیرقابل اعتماد به وضعیت قابل اعتماد منتقل شود.

توجه به این نکته مهم است که فرآیند قرنطینه ترکیب مصنوع را تغییر نمی‌دهد. این فرآیند مستقل از چرخه توسعه نرم‌افزار است و در صورت نیاز توسط مصرف‌کنندگان فراخوانی می‌شود. به‌عنوان مصرف‌کننده مصنوع، استفاده از مصنوعات را تا زمانی که از قرنطینه عبور نکرده‌اند، مسدود کنید.

در اینجا یک گردش کار معمول قرنطینه آمده است:

---نمودار ۱ (fig1)

1.  مصرف‌کننده قصد خود را اعلام می‌کند، منبع ورودی مصنوع را مشخص کرده و استفاده از آن را مسدود می‌کند.
2.  فرآیند قرنطینه، اصالت درخواست را تأیید کرده و مصنوعات را از مخزن مشخص‌شده دریافت می‌کند.
3.  یک فرآیند تأیید سفارشی به‌عنوان بخشی از قرنطینه انجام می‌شود که شامل تأیید محدودیت‌های ورودی و بررسی صفات، منبع و نوع در برابر استانداردهای تثبیت‌شده است.
    *   برخی از این بررسی‌های امنیتی می‌توانند شامل اسکن آسیب‌پذیری، شناسایی بدافزار و غیره، روی هر مصنوع ارسالی باشند.
    *   بررسی‌های واقعی به نوع مصنوع بستگی دارد. برای مثال، ارزیابی یک ایمیج سیستم‌عامل با ارزیابی یک بسته NuGet متفاوت است.
4.  اگر فرآیند تأیید موفقیت‌آمیز باشد، مصنوع در یک مخزن امن با توضیحات (annotation) واضح منتشر می‌شود. در غیر این صورت، برای مصرف‌کننده در دسترس نخواهد بود.
    *   فرآیند انتشار می‌تواند شامل یک گزارش تجمعی باشد که اثبات تأیید و اهمیت حیاتی (criticality) هر بررسی را نشان دهد. تاریخ انقضا را در گزارش بگنجانید که پس از آن گزارش باید نامعتبر باشد و مصنوع ناامن تلقی شود.
5.  فرآیند با اعلام یک رویداد حاوی اطلاعات وضعیت به همراه یک گزارش، پایان قرنطینه را مشخص می‌کند.
6.  براساس این اطلاعات، مصرف‌کنندگان می‌توانند برای استفاده از مصنوع قابل اعتماد اقدام کنند. این اقدامات خارج از محدوده الگوی قرنطینه است.

**مسائل و ملاحظات**
به‌عنوان تیمی که مصنوعات شخص ثالث را مصرف می‌کند، اطمینان حاصل کنید که از یک منبع قابل اعتماد تهیه شده است. انتخاب شما باید با استانداردهای تأییدشده سازمان برای مصنوعاتی که از فروشندگان شخص ثالث تهیه می‌شوند، همسو باشد. فروشندگان باید بتوانند الزامات امنیتی بار کاری شما (و سازمان شما) را برآورده کنند. برای مثال، اطمینان حاصل کنید که برنامه افشای مسئولانه (responsible disclosure plan) فروشنده با الزامات امنیتی سازمان شما مطابقت دارد.

بین منابعی که مصنوعات قابل اعتماد و غیرقابل اعتماد را ذخیره می‌کنند، تفکیک ایجاد کنید. از کنترل‌های هویتی و شبکه‌ای برای محدود کردن دسترسی به کاربران مجاز استفاده کنید.

روشی قابل اعتماد برای فراخوانی فرآیند قرنطینه داشته باشید. اطمینان حاصل کنید که مصنوع تا زمانی که به‌عنوان قابل اعتماد علامت‌گذاری نشده است، به‌طور ناخواسته مصرف نشود. سیگنال‌دهی باید خودکار باشد. برای مثال، وظایف مربوط به اطلاع‌رسانی به طرف‌های مسئول هنگام ورود (ingestion) یک مصنوع به محیط توسعه‌دهنده، کامیت کردن تغییرات در یک مخزن گیت‌هاب، افزودن یک ایمیج به یک رجیستری خصوصی و غیره.

یک جایگزین برای پیاده‌سازی الگوی قرنطینه، برون‌سپاری آن است. متخصصان قرنطینه‌ای وجود دارند که در اعتبارسنجی دارایی‌های عمومی به‌عنوان مدل کسب‌وکار خود تخصص دارند. هم هزینه‌های مالی و هم هزینه‌های عملیاتی پیاده‌سازی الگو در مقابل برون‌سپاری این مسئولیت را ارزیابی کنید. اگر الزامات امنیتی شما به کنترل بیشتری نیاز دارد، پیاده‌سازی فرآیند اختصاصی خودتان توصیه می‌شود.

فرآیند ورود (ingestion) مصنوع و همچنین فرآیند انتشار مصنوع را خودکار کنید. از آنجا که وظایف اعتبارسنجی می‌تواند زمان‌بر باشد، فرآیند اتوماسیون باید بتواند تا تکمیل همه وظایف ادامه یابد.

این الگو به‌عنوان یک اعتبارسنجی لحظه‌ای در اولین فرصت عمل می‌کند. با موفقیت گذراندن قرنطینه تضمین نمی‌کند که مصنوع برای همیشه قابل اعتماد باقی بماند. مصنوع باید همچنان تحت اسکن مداوم، اعتبارسنجی پایپ‌لاین و سایر بررسی‌های امنیتی معمول قرار گیرد که به‌عنوان اعتبارسنجی‌های آخرین فرصت قبل از ارتقاء نسخه (release) عمل می‌کنند.

این الگو می‌تواند توسط تیم‌های مرکزی یک سازمان یا یک تیم بار کاری منفرد پیاده‌سازی شود. اگر نمونه‌ها یا تغییرات زیادی از فرآیند قرنطینه وجود دارد، این عملیات باید توسط سازمان استانداردسازی و متمرکز شوند. در این حالت، تیم‌های بار کاری فرآیند را به اشتراک می‌گذارند و از واگذاری (offloading) مدیریت فرآیند سود می‌برند.

**چه زمانی از این الگو استفاده کنیم**
از این الگو در موارد زیر استفاده کنید:

*   بار کاری، مصنوع توسعه‌یافته خارج از محدوده تیم بار کاری را یکپارچه می‌کند. مثال‌های رایج عبارتند از:
    *   یک مصنوع Open Container Initiative (OCI) از رجیستری‌های عمومی مانند DockerHub، رجیستری کانتینر گیت‌هاب، رجیستری کانتینر مایکروسافت.
    *   یک کتابخانه یا بسته نرم‌افزاری از منابع عمومی مانند گالری NuGet، ایندکس بسته پایتون (Python Package Index)، مخزن آپاچی Maven.
    *   یک بسته زیرساخت به عنوان کد (IaC) خارجی مانند ماژول‌های Terraform، کتاب‌های آشپزی Chef جامعه (Community Chef Cookbooks)، ماژول‌های تأییدشده Azure (Azure Verified Modules).
    *   یک ایمیج سیستم‌عامل یا نصب‌کننده نرم‌افزار ارائه‌شده توسط فروشنده.
*   تیم بار کاری، مصنوع را به‌عنوان ریسکی که ارزش کاهش دادن دارد، در نظر می‌گیرد. تیم پیامدهای منفی یکپارچه‌سازی مصنوعات به خطر افتاده و ارزش قرنطینه در تضمین یک محیط قابل اعتماد را درک می‌کند.
*   تیم درک روشن و مشترکی از قوانین اعتبارسنجی که باید برای یک نوع مصنوع اعمال شود، دارد. بدون اجماع، الگو ممکن است مؤثر نباشد.
    *   برای مثال، اگر هر بار که یک ایمیج سیستم‌عامل وارد قرنطینه می‌شود، مجموعه متفاوتی از بررسی‌های اعتبارسنجی اعمال شود، فرآیند کلی تأیید برای ایمیج‌های سیستم‌عامل ناسازگار می‌شود.

**این الگو ممکن است در موارد زیر مفید نباشد:**

*   مصنوع نرم‌افزاری توسط تیم بار کاری یا یک تیم شریک قابل اعتماد ایجاد شده است.
*   ریسک عدم تأیید مصنوع، کم‌هزینه‌تر از هزینه ساخت و نگهداری فرآیند قرنطینه است.

**طراحی بار کاری (Workload)**
یک معمار و تیم بار کاری باید ارزیابی کنند که چگونه الگوی قرنطینه می‌تواند به‌عنوان بخشی از شیوه‌های DevSecOps بار کاری استفاده شود. اصول بنیادین در ستون‌های چارچوب خوب معماری شده Azure (Azure Well-Architected Framework) پوشش داده شده‌اند.

| ستون                  | چگونه این الگو از اهداف ستون پشتیبانی می‌کند                                                                                                                                                                                               |
| --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| امنیت (Security)       | اولین مسئولیت اعتبارسنجی امنیتی توسط الگوی قرنطینه انجام می‌شود. اعتبارسنجی یک مصنوع خارجی قبل از اینکه توسط فرآیند توسعه مصرف شود، در یک محیط تفکیک‌شده (segmented) انجام می‌شود. <br> - SE:02 چرخه عمر توسعه ایمن <br> - SE:11 آزمون و اعتبارسنجی |
| تعالی عملیاتی (Operational Excellence) | الگوی قرنطینه از شیوه‌های استقرار ایمن (SDP) با اطمینان از اینکه مصنوعات به خطر افتاده توسط بار کاری مصرف نمی‌شوند، پشتیبانی می‌کند، که می‌تواند منجر به نقض‌های امنیتی در طول استقرارهای تدریجی (progressive exposure) شود. <br> - OE:03 شیوه‌های توسعه نرم‌افزار <br> - OE:11 آزمون و اعتبارسنجی |

مانند هر تصمیم طراحی، هرگونه بده‌بستان (tradeoff) در برابر اهداف ستون‌های دیگر که ممکن است با این الگو معرفی شود را در نظر بگیرید.

**مثال**
این مثال گردش کار راه‌حل را برای سناریویی اعمال می‌کند که در آن تیم بار کاری می‌خواهد مصنوعات OCI را از رجیستری‌های عمومی به یک نمونه Azure Container Registry (ACR) که متعلق به تیم بار کاری است، یکپارچه کند. تیم آن نمونه را به‌عنوان یک مخزن مصنوع قابل اعتماد تلقی می‌کند.

محیط بار کاری از خط‌مشی Azure برای Kubernetes برای اجرای حاکمیت (governance) استفاده می‌کند. این خط‌مشی، کشیدن (pull) کانتینر را فقط از نمونه رجیستری قابل اعتماد خود محدود می‌کند. علاوه بر این، هشدارهای Azure Monitor برای شناسایی هرگونه واردات (import) به آن رجیستری از منابع غیرمنتظره تنظیم شده‌اند.

----نمودار ۲ (fig2)

1.  درخواست برای یک ایمیج خارجی توسط تیم بار کاری از طریق یک اپلیکیشن سفارشی میزبان شده در Azure Web Apps انجام می‌شود. اپلیکیشن اطلاعات مورد نیاز را فقط از کاربران مجاز جمع‌آوری می‌کند.
    *   **نقطه بازرسی امنیتی:** هویت درخواست‌کننده، رجیستری کانتینر مقصد و منبع ایمیج درخواستی، تأیید می‌شوند.
2.  درخواست در Azure Cosmos DB ذخیره می‌شود.
    *   **نقطه بازرسی امنیتی:** یک ردپای ممیزی (audit trail) در پایگاه داده نگهداری می‌شود که اصل و نسب (lineage) و اعتبارسنجی‌های ایمیج را ردیابی می‌کند. این ردپا برای گزارش‌دهی تاریخی نیز استفاده می‌شود.
3.  درخواست توسط یک ارکستراتور گردش کار، که یک Azure Function بادوام است، مدیریت می‌شود. ارکستراتور از رویکرد پخش-جمع‌آوری (scatter-gather) برای اجرای همه اعتبارسنجی‌ها استفاده می‌کند.
    *   **نقطه بازرسی امنیتی:** ارکستراتور دارای یک هویت مدیریت‌شده با دسترسی فقط به اندازه کافی (just-enough access) برای انجام وظایف اعتبارسنجی است.
4.  ارکستراتور درخواستی برای وارد کردن (import) ایمیج به رجیستری کانتینر Azure (ACR) قرنطینه، که به‌عنوان یک مخزن غیرقابل اعتماد تلقی می‌شود، ارسال می‌کند.
5.  فرآیند واردات در رجیستری قرنطینه، ایمیج را از مخزن خارجی غیرقابل اعتماد دریافت می‌کند. اگر واردات موفقیت‌آمیز باشد، رجیستری قرنطینه یک کپی محلی از ایمیج برای اجرای اعتبارسنجی‌ها دارد.
    *   **نقطه بازرسی امنیتی:** رجیستری قرنطینه در طول فرآیند اعتبارسنجی در برابر دستکاری و مصرف توسط بار کاری محافظت می‌کند.
6.  ارکستراتور تمام وظایف اعتبارسنجی را روی کپی محلی ایمیج اجرا می‌کند. وظایف شامل بررسی‌هایی مانند شناسایی آسیب‌پذیری‌ها و مواجهه‌های رایج (CVE)، ارزیابی فهرست مواد نرم‌افزاری (SBOM)، شناسایی بدافزار، امضای ایمیج و غیره است.
    *   ارکستراتور نوع بررسی‌ها، ترتیب اجرا و زمان اجرا را تصمیم می‌گیرد. در این مثال، از Azure Container Instance به‌عنوان اجراکننده‌های وظیفه (task runners) استفاده می‌کند و نتایج در پایگاه داده ممیزی Cosmos DB قرار دارند. همه وظایف می‌توانند زمان قابل توجهی ببرند.
    *   **نقطه بازرسی امنیتی:** این مرحله هسته فرآیند قرنطینه است که تمام بررسی‌های اعتبارسنجی را انجام می‌دهد. نوع بررسی‌ها می‌تواند راه‌حل‌های سفارشی، متن‌باز یا خریداری‌شده از فروشنده باشد.
7.  ارکستراتور تصمیم می‌گیرد. اگر ایمیج تمام اعتبارسنجی‌ها را با موفقیت پشت سر بگذارد، رویداد در پایگاه داده ممیزی ثبت می‌شود، ایمیج به رجیستری قابل اعتماد ارسال (push) شده و کپی محلی از رجیستری قرنطینه حذف می‌شود. در غیر این صورت، ایمیج از رجیستری قرنطینه حذف می‌شود تا از استفاده ناخواسته آن جلوگیری شود.
    *   **نقطه بازرسی امنیتی:** ارکستراتور تفکیک بین مکان‌های منابع قابل اعتماد و غیرقابل اعتماد را حفظ می‌کند.

> **نکته**
>
> به‌جای اینکه ارکستراتور تصمیم بگیرد، تیم بار کاری می‌تواند این مسئولیت را بر عهده بگیرد. در این جایگزین، ارکستراتور نتایج اعتبارسنجی را از طریق یک API منتشر می‌کند و ایمیج را برای مدتی در رجیستری قرنطینه نگه می‌دارد.
>
> تیم بار کاری پس از بررسی نتایج تصمیم می‌گیرد. اگر نتایج با آستانه تحمل ریسک (risk tolerance) آن‌ها مطابقت داشته باشد، ایمیج را از مخزن قرنطینه به نمونه کانتینر خود می‌کشند (pull). این مدل کشیدن (pull model) زمانی عملی‌تر است که این الگو برای پشتیبانی از چندین تیم بار کاری با آستانه‌های تحمل ریسک امنیتی متفاوت استفاده شود.

همه رجیستری‌های کانتینر توسط Microsoft Defender for Containers پوشش داده می‌شوند، که به‌طور مداوم برای مسائل تازه کشف‌شده اسکن می‌کند. این مسائل در Microsoft Defender Vulnerability Management نشان داده می‌شوند.

**گام‌های بعدی**
راهنمایی‌های زیر ممکن است هنگام پیاده‌سازی این الگو مرتبط باشند:

*   توصیه‌هایی برای ایمن‌سازی چرخه عمر توسعه، راهنمایی‌هایی در مورد استفاده از واحدهای کد قابل اعتماد در تمام مراحل چرخه عمر توسعه ارائه می‌دهد.
*   بهترین شیوه‌ها برای یک زنجیره تأمین نرم‌افزار ایمن، به‌ویژه زمانی که وابستگی‌های NuGet در اپلیکیشن خود دارید.
*   محافظت در برابر بسته‌های عمومی مخرب با استفاده از Azure Artifacts.
