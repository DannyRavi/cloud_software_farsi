
عنوان: امکان دادن به یک اپلیکیشن برای اعلام ناهمزمان رویدادها به چندین مصرف‌کننده‌ی علاقه‌مند، بدون ایجاد وابستگی (coupling) بین فرستنده‌ها و گیرنده‌ها.

نام دیگر: پیام‌رسانی انتشار/اشتراک (Pub/Sub)

زمینه و مسئله
در اپلیکیشن‌های مبتنی بر ابر و توزیع‌شده، اجزای سیستم اغلب نیاز دارند همزمان با وقوع رویدادها، اطلاعات را به سایر اجزا ارائه دهند.

پیام‌رسانی ناهمزمان روشی مؤثر برای جداسازی فرستنده‌ها از مصرف‌کننده‌ها و جلوگیری از مسدود شدن فرستنده در انتظار پاسخ است. با این حال، استفاده از یک صف پیام اختصاصی برای هر مصرف‌کننده، برای تعداد زیاد مصرف‌کننده به‌طور مؤثر مقیاس‌پذیر نیست. همچنین، برخی از مصرف‌کنندگان ممکن است تنها به زیرمجموعه‌ای از اطلاعات علاقه‌مند باشند. چگونه فرستنده می‌تواند رویدادها را به تمام مصرف‌کنندگان علاقه‌مند بدون اطلاع از هویت آن‌ها اعلام کند؟

راه‌حل
راهکار، معرفی یک زیرسیستم پیام‌رسانی ناهمزمان است که شامل موارد زیر می‌شود:

یک کانال پیام‌رسانی ورودی که توسط فرستنده استفاده می‌شود. فرستنده رویدادها را با استفاده از یک فرمت پیام شناخته‌شده، در قالب پیام بسته‌بندی کرده و از طریق کانال ورودی ارسال می‌کند. فرستنده در این الگو، ناشر (publisher) نیز نامیده می‌شود.

نکته

پیام (Message) یک بسته داده است. رویداد (Event) پیامی است که سایر اجزا را از یک تغییر یا اقدامی که رخ داده است، مطلع می‌کند.

یک کانال پیام‌رسانی خروجی برای هر مصرف‌کننده. مصرف‌کنندگان به‌عنوان مشترک (subscriber) شناخته می‌شوند.

مکانیزمی برای کپی کردن هر پیام از کانال ورودی به کانال‌های خروجی برای تمام مشترکینی که به آن پیام علاقه‌مند هستند. این عملیات معمولاً توسط یک واسطه مانند یک کارگزار پیام (message broker) یا گذرگاه رویداد (event bus) انجام می‌شود.

نمودار زیر اجزای منطقی این الگو را نشان می‌دهد:

------نمودار ۱ (fig1)

پیام‌رسانی Pub/Sub مزایای زیر را دارد:

زیرسیستم‌هایی را که همچنان نیاز به ارتباط دارند، از هم جدا می‌کند (decouples). زیرسیستم‌ها می‌توانند به‌طور مستقل مدیریت شوند و پیام‌ها حتی اگر یک یا چند گیرنده آفلاین باشند، به‌درستی مدیریت می‌شوند.

مقیاس‌پذیری را افزایش داده و پاسخ‌دهی فرستنده را بهبود می‌بخشد. فرستنده می‌تواند به‌سرعت یک پیام را به کانال ورودی ارسال کرده و سپس به مسئولیت‌های پردازشی اصلی خود بازگردد. زیرساخت پیام‌رسانی مسئول حصول اطمینان از تحویل پیام‌ها به مشترکین علاقه‌مند است.

قابلیت اطمینان را بهبود می‌بخشد. پیام‌رسانی ناهمزمان به اپلیکیشن‌ها کمک می‌کند تا تحت بارهای افزایش‌یافته به‌طور روان به کار خود ادامه داده و خرابی‌های متناوب را مؤثرتر مدیریت کنند.

امکان پردازش معوق یا زمان‌بندی‌شده را فراهم می‌کند. مشترکین می‌توانند تا ساعات غیر اوج بار برای دریافت پیام‌ها منتظر بمانند، یا پیام‌ها می‌توانند طبق یک برنامه زمانی خاص مسیریابی یا پردازش شوند.

یکپارچه‌سازی ساده‌تر بین سیستم‌هایی که از پلتفرم‌ها، زبان‌های برنامه‌نویسی یا پروتکل‌های ارتباطی مختلف استفاده می‌کنند و همچنین بین سیستم‌های محلی (on-premises) و اپلیکیشن‌های در حال اجرا در ابر را امکان‌پذیر می‌سازد.

گردش‌کارهای ناهمزمان در سراسر یک سازمان را تسهیل می‌کند.

آزمون‌پذیری را بهبود می‌بخشد. کانال‌ها می‌توانند به‌عنوان بخشی از یک استراتژی کلی آزمون یکپارچه‌سازی، نظارت شده و پیام‌ها بازرسی یا ثبت (log) شوند.

تفکیک دغدغه‌ها (separation of concerns) را برای اپلیکیشن‌های شما فراهم می‌کند. هر اپلیکیشن می‌تواند بر قابلیت‌های اصلی خود تمرکز کند، در حالی که زیرساخت پیام‌رسانی تمام موارد لازم برای مسیریابی مطمئن پیام‌ها به چندین مصرف‌کننده را مدیریت می‌کند.

مسائل و ملاحظات
هنگام تصمیم‌گیری در مورد چگونگی پیاده‌سازی این الگو، نکات زیر را در نظر بگیرید:

فناوری‌های موجود. اکیداً توصیه می‌شود به‌جای ساختن سیستم اختصاصی خود، از محصولات و خدمات پیام‌رسانی موجود که از مدل انتشار-اشتراک پشتیبانی می‌کنند، استفاده کنید. در Azure، استفاده از Service Bus، Event Hubs یا Event Grid را در نظر بگیرید. سایر فناوری‌هایی که می‌توان برای پیام‌رسانی pub/sub استفاده کرد عبارتند از Redis، RabbitMQ و Apache Kafka.

مدیریت اشتراک. زیرساخت پیام‌رسانی باید مکانیزم‌هایی را فراهم کند که مصرف‌کنندگان بتوانند برای اشتراک در کانال‌های موجود یا لغو اشتراک از آن‌ها استفاده کنند.

امنیت. اتصال به هر کانال پیام باید توسط خط‌مشی امنیتی محدود شود تا از استراق سمع توسط کاربران یا اپلیکیشن‌های غیرمجاز جلوگیری شود.

زیرمجموعه‌های پیام. مشترکین معمولاً تنها به زیرمجموعه‌ای از پیام‌های توزیع‌شده توسط ناشر علاقه‌مند هستند. خدمات پیام‌رسانی اغلب به مشترکین اجازه می‌دهند مجموعه پیام‌های دریافتی را از طریق روش‌های زیر محدود کنند:

موضوعات (Topics). هر موضوع یک کانال خروجی اختصاصی دارد و هر مصرف‌کننده می‌تواند در تمام موضوعات مرتبط مشترک شود.

فیلترسازی محتوا. پیام‌ها بازرسی شده و براساس محتوای هر پیام توزیع می‌شوند. هر مشترک می‌تواند محتوای مورد علاقه خود را مشخص کند.

مشترکین با استفاده از wildcard (نویسه عمومی). امکان اشتراک مشترکین در چندین موضوع از طریق wildcardها را در نظر بگیرید.

ارتباط دوطرفه. کانال‌ها در سیستم انتشار-اشتراک به‌عنوان یک‌طرفه در نظر گرفته می‌شوند. اگر یک مشترک خاص نیاز به ارسال تأییدیه (acknowledgment) یا اعلام وضعیت به ناشر داشته باشد، استفاده از الگوی درخواست/پاسخ (Request/Reply Pattern) را در نظر بگیرید. این الگو از یک کانال برای ارسال پیام به مشترک و یک کانال پاسخ جداگانه برای برقراری ارتباط با ناشر استفاده می‌کند.

ترتیب پیام‌ها. ترتیبی که نمونه‌های مصرف‌کننده پیام‌ها را دریافت می‌کنند، تضمین‌شده نیست و لزوماً منعکس‌کننده ترتیب ایجاد پیام‌ها نیست. سیستم را طوری طراحی کنید که پردازش پیام توان‌یکسان (idempotent) باشد تا به حذف هرگونه وابستگی به ترتیب پردازش پیام کمک کند.

اولویت پیام. برخی راه‌حل‌ها ممکن است نیاز داشته باشند که پیام‌ها به ترتیب خاصی پردازش شوند. الگوی صف اولویت (Priority Queue pattern) مکانیزمی برای اطمینان از تحویل پیام‌های خاص قبل از سایرین فراهم می‌کند.

پیام‌های مسموم (Poison messages). یک پیام ناقص‌الخلقه (malformed)، یا وظیفه‌ای که به منابع غیرقابل دسترس نیاز دارد، می‌تواند باعث خرابی یک نمونه از سرویس شود. سیستم باید از بازگشت چنین پیام‌هایی به صف جلوگیری کند. در عوض، جزئیات این پیام‌ها را در جای دیگری ضبط و ذخیره کنید تا در صورت لزوم قابل تجزیه و تحلیل باشند. برخی از کارگزاران پیام، مانند Azure Service Bus، از طریق قابلیت صف نامه‌های مرده (dead-letter queue) خود از این امر پشتیبانی می‌کنند.

پیام‌های تکراری. ممکن است یک پیام بیش از یک بار ارسال شود. به‌عنوان مثال، فرستنده ممکن است پس از ارسال پیام با شکست مواجه شود. سپس یک نمونه جدید از فرستنده ممکن است راه‌اندازی شده و پیام را تکرار کند. زیرساخت پیام‌رسانی باید تشخیص و حذف پیام‌های تکراری (که به آن de-duping یا تکرارزدایی نیز گفته می‌شود) را براساس شناسه پیام پیاده‌سازی کند تا تحویل حداکثر یک‌باره (at-most-once) پیام‌ها را فراهم نماید. در غیر این صورت، اگر از زیرساخت پیام‌رسانی استفاده می‌کنید که پیام‌های تکراری را حذف نمی‌کند، اطمینان حاصل کنید که منطق پردازش پیام توان‌یکسان (idempotent) است.

انقضای پیام. یک پیام ممکن است طول عمر محدودی داشته باشد. اگر در این مدت پردازش نشود، ممکن است دیگر مرتبط نبوده و باید دور انداخته شود. فرستنده می‌تواند زمان انقضا را به‌عنوان بخشی از داده‌های پیام مشخص کند. گیرنده می‌تواند این اطلاعات را قبل از تصمیم‌گیری در مورد اجرای منطق تجاری مرتبط با پیام، بررسی کند.

زمان‌بندی پیام. یک پیام ممکن است به‌طور موقت به تعویق افتد (embargoed) و نباید تا تاریخ و زمان مشخصی پردازش شود. پیام نباید تا آن زمان برای گیرنده در دسترس باشد.

مقیاس‌پذیری افقی (Scaling out) مشترکین. اگر یک مشترک معین قادر به همگام شدن با نرخ پیام‌های دریافتی خود نباشد، از الگوی مصرف‌کنندگان رقیب (Competing Consumers pattern) برای مقیاس‌پذیری افقی آن استفاده کنید.

چه زمانی از این الگو استفاده کنیم
از این الگو در موارد زیر استفاده کنید:

یک اپلیکیشن نیاز به پخش (broadcast) اطلاعات به تعداد قابل توجهی از مصرف‌کنندگان دارد.

یک اپلیکیشن نیاز به برقراری ارتباط با یک یا چند اپلیکیشن یا سرویس مستقل توسعه‌یافته دارد که ممکن است از پلتفرم‌ها، زبان‌های برنامه‌نویسی و پروتکل‌های ارتباطی مختلفی استفاده کنند.

یک اپلیکیشن می‌تواند اطلاعات را بدون نیاز به پاسخ‌های بلادرنگ از سوی مصرف‌کنندگان، به آن‌ها ارسال کند.

سیستم‌های در حال یکپارچه‌سازی برای پشتیبانی از مدل سازگاری نهایی (eventual consistency) برای داده‌های خود طراحی شده‌اند.

یک اپلیکیشن نیاز به انتقال اطلاعات به چندین مصرف‌کننده دارد که ممکن است الزامات دسترس‌پذیری یا برنامه‌های زمانی فعال بودن (uptime) متفاوتی نسبت به فرستنده داشته باشند.

این الگو ممکن است در موارد زیر مفید نباشد:

یک اپلیکیشن تنها تعداد کمی مصرف‌کننده دارد که به اطلاعاتی به‌طور قابل توجهی متفاوت از اپلیکیشن تولیدکننده نیاز دارند.

یک اپلیکیشن به تعامل نزدیک به بلادرنگ (near real-time) با مصرف‌کنندگان نیاز دارد.

طراحی بار کاری (Workload)
یک معمار باید ارزیابی کند که چگونه الگوی ناشر/مشترک (Publisher/Subscriber) می‌تواند در طراحی بار کاری (workload) آن‌ها برای پرداختن به اهداف و اصول مطرح شده در ستون‌های چارچوب خوب معماری شده Azure (Azure Well-Architected Framework) استفاده شود. برای مثال:

ستون	چگونه این الگو از اهداف ستون پشتیبانی می‌کند
پایایی (Reliability)	جداسازی (decoupling) معرفی‌شده در این الگو، اهداف پایایی مستقل را برای اجزا امکان‌پذیر ساخته و وابستگی‌های مستقیم را حذف می‌کند. <br> - RE:03 تحلیل حالت خرابی <br> - RE:07 کارهای پس‌زمینه
امنیت (Security)	این الگو یک مرز تقسیم‌بندی امنیتی مهم را معرفی می‌کند که مشترکین صف را قادر می‌سازد تا از نظر شبکه از ناشر جدا (network-isolated) باشند. <br> - SE:04 تقسیم‌بندی
بهینه‌سازی هزینه (Cost Optimization)	این طراحی جداشده (decoupled) می‌تواند یک رویکرد رویداد-محور را در معماری شما فعال کند، که به خوبی با صورت‌حساب مبتنی بر مصرف (consumption-based billing) برای جلوگیری از تأمین بیش از حد منابع (overprovisioning) سازگار است. <br> - CO:05 بهینه‌سازی نرخ <br> - CO:12 هزینه‌های مقیاس‌پذیری
تعالی عملیاتی (Operational Excellence)	این لایه از غیرمستقیم بودن (indirection) می‌تواند شما را قادر سازد تا پیاده‌سازی را در سمت ناشر یا مشترک بدون نیاز به هماهنگی تغییرات در هر دو جزء، به‌طور ایمن تغییر دهید. <br> - OE:06 توسعه بار کاری <br> - OE:11 شیوه‌های استقرار ایمن
کارایی عملکرد (Performance Efficiency)	جداسازی ناشران از مصرف‌کنندگان شما را قادر می‌سازد تا محاسبات و کد را به‌طور خاص برای وظیفه‌ای که مصرف‌کننده باید برای پیام خاص انجام دهد، بهینه کنید. <br> - PE:02 برنامه‌ریزی ظرفیت <br> - PE:05 مقیاس‌پذیری و پارتیشن‌بندی

مانند هر تصمیم طراحی، هرگونه بده‌بستان (tradeoff) در برابر اهداف ستون‌های دیگر که ممکن است با این الگو معرفی شود را در نظر بگیرید.

مثال
نمودار زیر یک معماری یکپارچه‌سازی سازمانی را نشان می‌دهد که از Service Bus برای هماهنگ‌سازی گردش‌کارها و از Event Grid برای اطلاع‌رسانی به زیرسیستم‌ها در مورد رویدادهای رخ‌داده استفاده می‌کند. برای اطلاعات بیشتر، به مبحث "یکپارچه‌سازی سازمانی در Azure با استفاده از صف‌های پیام و رویدادها" مراجعه کنید.

-------نمودار ۲ (fig2)

گام‌های بعدی
راهنمایی‌های زیر ممکن است هنگام پیاده‌سازی این الگو مرتبط باشند:

انتخاب بین سرویس‌های Azure که پیام‌ها را تحویل می‌دهند.

مبانی پیام‌رسانی ناهمزمان. صف‌های پیام یک مکانیزم ارتباطی ناهمزمان هستند. اگر یک سرویس مصرف‌کننده نیاز به ارسال پاسخ به یک اپلیکیشن داشته باشد، ممکن است لازم باشد نوعی پیام‌رسانی پاسخ پیاده‌سازی شود. "مبانی پیام‌رسانی ناهمزمان" اطلاعاتی در مورد نحوه پیاده‌سازی پیام‌رسانی درخواست/پاسخ با استفاده از صف‌های پیام ارائه می‌دهد.

الگوهای زیر ممکن است هنگام پیاده‌سازی این الگو مرتبط باشند:

الگوی مشاهده‌گر (Observer pattern). الگوی انتشار-اشتراک (Publish-Subscribe) با جداسازی موضوعات (subjects) از مشاهده‌گران (observers) از طریق پیام‌رسانی ناهمزمان، بر پایه الگوی مشاهده‌گر ساخته شده است.

الگوی کارگزار پیام (Message Broker pattern). بسیاری از زیرسیستم‌های پیام‌رسانی که از مدل انتشار-اشتراک پشتیبانی می‌کنند، از طریق یک کارگزار پیام پیاده‌سازی می‌شوند.

این پست وبلاگ روش‌های مختلفی را برای مدیریت پیام‌هایی که خارج از ترتیب می‌رسند، شرح می‌دهد.

منابع مرتبط

سبک معماری رویداد-محور (Event-driven architecture style) یک سبک معماری است که از پیام‌رسانی pub/sub استفاده می‌کند.

پردازش پیام توان‌یکسان (Idempotent)

یکپارچه‌سازی سازمانی در Azure با استفاده از صف‌های پیام و رویدادها

امیدوارم این بازبینی به شما کمک کند. در صورت نیاز به تغییرات بیشتر، لطفاً اطلاع دهید.