
چندین مصرف کننده همزمان را فعال کنید تا پیام های دریافت شده در یک کانال پیام رسانی را پردازش کنند. با چندین مصرف کننده همزمان، یک سیستم می تواند چندین پیام را به طور همزمان پردازش کند تا توان عملیاتی را بهینه کند، مقیاس پذیری و در دسترس بودن را بهبود بخشد و حجم کار را متعادل کند.

## Context and problem

انتظار می‌رود برنامه‌ای که در فضای ابری اجرا می‌شود، تعداد زیادی از درخواست‌ها را مدیریت کند. به جای پردازش هر درخواست به صورت همزمان، یک تکنیک رایج این است که برنامه کاربردی آنها را از طریق یک سیستم پیام رسانی به سرویس دیگری (یک سرویس مصرف کننده) که آنها را به طور ناهمزمان رسیدگی می کند، ارسال می کند. این استراتژی کمک می کند تا اطمینان حاصل شود که منطق تجاری در برنامه مسدود نمی شود، در حالی که درخواست ها در حال پردازش هستند.  
  
تعداد درخواست ها به دلایل زیادی در طول زمان می تواند به طور قابل توجهی متفاوت باشد. افزایش ناگهانی فعالیت کاربر یا درخواست‌های انبوهی که از چندین مستأجر می‌آیند می‌تواند باعث ایجاد حجم کاری غیرقابل پیش‌بینی شود. در ساعات اوج مصرف، یک سیستم ممکن است نیاز به پردازش صدها درخواست در ثانیه داشته باشد، در حالی که در زمان‌های دیگر این تعداد ممکن است بسیار کم باشد. علاوه بر این، ماهیت کار انجام شده برای رسیدگی به این درخواست ها ممکن است بسیار متغیر باشد. با استفاده از یک نمونه از خدمات مصرف کننده، می توانید باعث شوید که آن نمونه مملو از درخواست ها شود. یا، سیستم پیام رسانی ممکن است به دلیل هجوم پیام هایی که از برنامه می آید، بیش از حد بارگذاری شود. برای مدیریت این حجم کاری نوسان، سیستم می تواند چندین نمونه از خدمات مصرف کننده را اجرا کند. با این حال، این مصرف کنندگان باید هماهنگ شوند تا اطمینان حاصل شود که هر پیام تنها به یک مصرف کننده تحویل داده می شود. حجم کار همچنین باید در بین مصرف کنندگان متعادل باشد تا از تبدیل شدن یک نمونه به گلوگاه جلوگیری شود.

## Solution

از یک صف پیام برای پیاده سازی کانال ارتباطی بین برنامه و نمونه های خدمات مصرف کننده استفاده کنید. برنامه درخواست ها را در قالب پیام به صف ارسال می کند و نمونه های خدمات مصرف کننده پیام هایی را از صف دریافت می کنند و آنها را پردازش می کنند. این رویکرد، مجموعه مشابهی از نمونه‌های خدمات مصرف‌کننده را قادر می‌سازد تا پیام‌های هر نمونه از برنامه را مدیریت کنند. شکل استفاده از صف پیام برای توزیع کار در نمونه های یک سرویس را نشان می دهد.

![[Pasted image 20231203234618.png]]


این راه حل دارای مزایای زیر است:

* این یک سیستم سطح بار ارائه می کند که می تواند تغییرات گسترده ای در حجم درخواست های ارسال شده توسط نمونه های برنامه کاربردی را مدیریت کند. صف به عنوان یک بافر بین نمونه های برنامه کاربردی و نمونه های خدمات مصرف کننده عمل می کند. این بافر می تواند به حداقل رساندن تأثیر بر در دسترس بودن و پاسخگویی، هم برای نمونه برنامه و هم برای سرویس کمک کند. برای اطلاعات بیشتر، الگوی بارگذاری بر اساس صف را ببینید. مدیریت پیامی که نیاز به پردازش طولانی مدت دارد، مانع از رسیدگی همزمان پیام های دیگر توسط سایر نمونه های خدمات مصرف کننده نمی شود.  
  
* قابلیت اطمینان را بهبود می بخشد. اگر یک تولیدکننده به جای استفاده از این الگو، مستقیماً با مصرف کننده ارتباط برقرار کند، اما بر مصرف کننده نظارت نداشته باشد، احتمال زیادی وجود دارد که در صورت شکست مصرف کننده، پیام ها گم شوند یا پردازش نشوند. در این الگو، پیام‌ها به یک نمونه سرویس خاص ارسال نمی‌شوند. یک نمونه سرویس ناموفق تولید کننده را مسدود نمی کند و پیام ها می توانند توسط هر نمونه سرویس کار پردازش شوند.  
  
* این نیازی به هماهنگی پیچیده بین مصرف کنندگان، یا بین نمونه های تولید کننده و مصرف کننده ندارد. صف پیام تضمین می کند که هر پیام حداقل یک بار تحویل داده می شود.  
  
* مقیاس پذیر است. هنگامی که مقیاس خودکار را اعمال می کنید، سیستم می تواند به صورت پویا تعداد نمونه های خدمات مصرف کننده را با نوسانات حجم پیام ها افزایش یا کاهش دهد.  
  
* اگر صف پیام عملیات خواندن تراکنشی را ارائه دهد، می تواند انعطاف پذیری را بهبود بخشد. اگر یک نمونه خدمات مصرف کننده پیام را به عنوان بخشی از یک عملیات تراکنشی بخواند و پردازش کند، و نمونه خدمات مصرف کننده با شکست مواجه شود، این الگو می تواند اطمینان حاصل کند که پیام به صف بازگردانده می شود تا توسط نمونه دیگری از خدمات مصرف کننده دریافت و مدیریت شود. . به منظور کاهش خطر شکست مداوم یک پیام، توصیه می کنیم از صف های مرده استفاده کنید.

## Issues and considerations

هنگام تصمیم گیری در مورد نحوه اجرای این الگو به نکات زیر توجه کنید:

* سفارش پیام. ترتیبی که نمونه‌های خدمات مصرف‌کننده پیام‌ها را دریافت می‌کنند تضمینی نیست و لزوماً نشان‌دهنده ترتیب ایجاد پیام‌ها نیست. سیستم را طوری طراحی کنید که از عدم توانایی پردازش پیام اطمینان حاصل کنید زیرا این امر به حذف هرگونه وابستگی به ترتیب مدیریت پیام ها کمک می کند. برای اطلاعات بیشتر، الگوهای عدم توانایی را در وبلاگ جاناتون الیور ببینید.  
  
> مایکروسافت Azure Service Bus Queues می‌تواند با استفاده از جلسات پیام، مرتب‌سازی تضمین شده پیام‌ها را از ابتدا در ابتدا اجرا کند. برای اطلاعات بیشتر، الگوهای پیام رسانی با استفاده از جلسات را ببینید.  
  
* طراحی خدمات برای تاب آوری. اگر سیستم برای شناسایی و راه‌اندازی مجدد نمونه‌های سرویس ناموفق طراحی شده است، ممکن است لازم باشد پردازش انجام شده توسط نمونه‌های سرویس به‌عنوان عملیات‌های بی‌توان اجرا شود تا اثرات یک پیام واحد که بیش از یک بار بازیابی و پردازش می‌شود به حداقل برسد.  
  
* تشخیص پیام های سمی یک پیام نادرست، یا کاری که نیاز به دسترسی به منابعی دارد که در دسترس نیستند، می‌تواند باعث از کار افتادن یک نمونه سرویس شود. سیستم باید از بازگرداندن چنین پیام‌هایی به صف جلوگیری کند و در عوض جزئیات این پیام‌ها را در جای دیگری ضبط و ذخیره کند تا در صورت لزوم بتوان آن‌ها را تجزیه و تحلیل کرد.  
  
* رسیدگی به نتایج نمونه سرویسی که یک پیام را مدیریت می کند به طور کامل از منطق برنامه ای که پیام را تولید می کند جدا شده است و ممکن است نتوانند مستقیماً ارتباط برقرار کنند. اگر نمونه سرویس نتایجی تولید کند که باید به منطق برنامه بازگردانده شود، این اطلاعات باید در مکانی ذخیره شود که برای هر دو قابل دسترسی باشد. برای جلوگیری از بازیابی اطلاعات ناقص توسط منطق برنامه، سیستم باید نشان دهد که پردازش کامل شده است.

> اگر از Azure استفاده می کنید، یک فرآیند کارگر می تواند نتایج را با استفاده از یک صف پاسخ اختصاصی پیام به منطق برنامه بازگرداند. منطق برنامه باید بتواند این نتایج را با پیام اصلی مرتبط کند. این سناریو با جزئیات بیشتر در آغازگر پیام رسانی ناهمزمان توضیح داده شده است.  
  
* مقیاس بندی سیستم پیام رسانی در یک راه حل در مقیاس بزرگ، یک صف پیام واحد می تواند توسط تعداد پیام ها غرق شود و به یک گلوگاه در سیستم تبدیل شود. در این شرایط، سیستم پیام رسانی را برای ارسال پیام از تولیدکنندگان خاص به یک صف خاص، پارتیشن بندی کنید، یا از تعادل بار برای توزیع پیام ها در چندین صف پیام استفاده کنید.  
  
* اطمینان از قابلیت اطمینان سیستم پیام رسانی. یک سیستم پیام رسانی قابل اعتماد لازم است تا تضمین کند که پس از اینکه برنامه یک پیام را در نوبت قرار داد، از بین نخواهد رفت. این سیستم برای اطمینان از اینکه همه پیام ها حداقل یک بار تحویل داده می شوند ضروری است.

## When to use this pattern


از این الگو زمانی استفاده کنید که:  
  
* حجم کار برای یک برنامه به وظایفی تقسیم می شود که می توانند به صورت ناهمزمان اجرا شوند.  
* وظایف مستقل هستند و می توانند به صورت موازی اجرا شوند.  
* حجم کار بسیار متغیر است و به یک راه حل مقیاس پذیر نیاز دارد.  
* راه حل باید در دسترس بودن بالایی داشته باشد و اگر پردازش یک کار با شکست مواجه شد، باید انعطاف پذیر باشد.


این الگو ممکن است زمانی مفید نباشد که:  
  
* تفکیک حجم کاری برنامه به وظایف مجزا کار آسانی نیست، یا وابستگی بالایی بین کارها وجود دارد.  
* وظایف باید به صورت همزمان انجام شوند و منطق برنامه قبل از ادامه باید منتظر تکمیل کار باشد.  
* وظایف باید در یک توالی خاص انجام شود.  
* برخی از سیستم‌های پیام‌رسان جلساتی را پشتیبانی می‌کنند که تولیدکننده را قادر می‌سازد تا پیام‌ها را با هم گروه‌بندی کند و اطمینان حاصل کند که همه آنها توسط یک مصرف‌کننده مدیریت می‌شوند. این مکانیسم می‌تواند با پیام‌های اولویت‌دار (در صورت پشتیبانی) برای پیاده‌سازی شکلی از سفارش پیام که پیام‌ها را به ترتیب از یک تولیدکننده به یک مصرف‌کننده تحویل می‌دهد، استفاده شود.

> برخی از سیستم‌های پیام‌رسان جلساتی را پشتیبانی می‌کنند که تولیدکننده را قادر می‌سازد تا پیام‌ها را با هم گروه‌بندی کند و اطمینان حاصل کند که همه آنها توسط یک مصرف‌کننده مدیریت می‌شوند. این مکانیسم می‌تواند با پیام‌های اولویت‌دار (در صورت پشتیبانی) برای پیاده‌سازی شکلی از سفارش پیام که پیام‌ها را به ترتیب از یک تولیدکننده به یک مصرف‌کننده تحویل می‌دهد، استفاده شود.

## Example

Azure محرک‌های صف گذرگاه خدمات و عملکرد Azure را فراهم می‌کند که در صورت ترکیب، اجرای مستقیم این الگوی طراحی ابری هستند. توابع Azure از طریق تریگرها و اتصالات با Azure Service Bus یکپارچه می شوند. ادغام با Service Bus به شما امکان می دهد تا عملکردهایی بسازید که پیام های صف ارسال شده توسط ناشران را مصرف می کنند. برنامه(های) انتشار پیام ها را به یک صف ارسال می کند و مصرف کنندگان، که به عنوان توابع Azure پیاده سازی شده اند، می توانند پیام ها را از این صف بازیابی کرده و آنها را مدیریت کنند.  
  
برای انعطاف‌پذیری، صف سرویس گذرگاه به مصرف‌کننده امکان می‌دهد از حالت PeekLock زمانی که پیامی را از صف بازیابی می‌کند استفاده کند. این حالت در واقع پیام را حذف نمی کند، بلکه به سادگی آن را از سایر مصرف کنندگان پنهان می کند. زمان اجرا Azure Functions پیامی را در حالت PeekLock دریافت می‌کند، اگر عملکرد با موفقیت تمام شود، Complete را روی پیام فراخوانی می‌کند، یا ممکن است Abandon را در صورت از کار افتادن عملکرد فراخوانی کند و پیام دوباره قابل مشاهده است و به مصرف‌کننده دیگری اجازه می‌دهد آن را بازیابی کند. اگر عملکرد برای مدت زمانی طولانی‌تر از مهلت زمانی PeekLock اجرا شود، تا زمانی که عملکرد در حال اجرا باشد، قفل به‌طور خودکار تمدید می‌شود.  
  
توابع Azure می توانند بر اساس عمق صف کوچک شوند و همه به عنوان مصرف کنندگان رقیب صف عمل کنند. اگر چندین نمونه از توابع ایجاد شوند، همه آنها با کشیدن و پردازش مستقل پیام ها به رقابت می پردازند.  
  
برای اطلاعات دقیق در مورد استفاده از صف‌های اتوبوس خدمات Azure، به صف‌ها، موضوعات و اشتراک‌های سرویس اتوبوس مراجعه کنید.  
  
برای اطلاعات در مورد عملکردهای Azure فعال شده در صف، به ماشه اتوبوس سرویس Azure برای عملکردهای Azure مراجعه کنید.  
  
کد زیر نشان می دهد که چگونه می توانید با استفاده از یک نمونه ServiceBusClient یک پیام جدید ایجاد کنید و آن را به صف سرویس اتوبوس ارسال کنید.

```csharp
private string serviceBusConnectionString = ...;
...

  public async Task SendMessagesAsync(CancellationToken  ct)
  {
   try
   {
    var msgNumber = 0;

    var serviceBusClient = new ServiceBusClient(serviceBusConnectionString);

    // create the sender
    ServiceBusSender sender = serviceBusClient.CreateSender("myqueue");

    while (!ct.IsCancellationRequested)
    {
     // Create a new message to send to the queue
     string messageBody = $"Message {msgNumber}";
     var message = new ServiceBusMessage(messageBody);

     // Write the body of the message to the console
     this._logger.LogInformation($"Sending message: {messageBody}");

     // Send the message to the queue
     await sender.SendMessageAsync(message);

     this._logger.LogInformation("Message successfully sent.");
     msgNumber++;
    }
   }
   catch (Exception exception)
   {
    this._logger.LogException(exception.Message);
   }
  }
```

مثال کد زیر مصرف کننده ای را نشان می دهد که به عنوان یک تابع C# Azure نوشته شده است که فراداده پیام را می خواند و یک پیام صف گذرگاه خدمات را ثبت می کند. توجه داشته باشید که چگونه ویژگی ServiceBusTrigger برای اتصال آن به صف سرویس گذرگاه استفاده می شود.

```csharp
[FunctionName("ProcessQueueMessage")]
public static void Run(
    [ServiceBusTrigger("myqueue", Connection = "ServiceBusConnectionString")]
    string myQueueItem,
    Int32 deliveryCount,
    DateTime enqueuedTimeUtc,
    string messageId,
    ILogger log)
{
    log.LogInformation($"C# ServiceBus queue trigger function consumed message: {myQueueItem}");
    log.LogInformation($"EnqueuedTimeUtc={enqueuedTimeUtc}");
    log.LogInformation($"DeliveryCount={deliveryCount}");
    log.LogInformation($"MessageId={messageId}");
}
```

## Next steps

* آغازگر پیام رسانی ناهمزمان. صف های پیام یک مکانیسم ارتباطی ناهمزمان هستند. اگر یک سرویس مصرف کننده نیاز به ارسال پاسخ به یک برنامه کاربردی داشته باشد، ممکن است لازم باشد که نوعی پیام پاسخ را پیاده سازی کند. Asynchronous Messaging Primer اطلاعاتی در مورد نحوه اجرای پیام درخواست/پاسخ با استفاده از صف های پیام ارائه می دهد.  
  
* راهنمای مقیاس خودکار. ممکن است بتوان نمونه‌هایی از خدمات مصرف‌کننده را شروع کرد و متوقف کرد، زیرا طول برنامه‌های صف پیام‌ها متفاوت است. مقیاس خودکار می تواند به حفظ توان در زمان اوج پردازش کمک کند.

## Related resources

الگوها و راهنمایی‌های زیر ممکن است هنگام اجرای این الگو مرتبط باشند:  
  
* محاسبه الگوی تلفیق منابع ممکن است بتوان چندین نمونه از خدمات مصرف کننده را در یک فرآیند واحد ادغام کرد تا هزینه ها و سربار مدیریت کاهش یابد. الگوی تلفیق منابع محاسباتی مزایا و معاوضه پیروی از این رویکرد را توصیف می کند.  
  
* الگوی بارگذاری بر اساس صف. معرفی یک صف پیام می‌تواند انعطاف‌پذیری را به سیستم اضافه کند و نمونه‌های سرویس را قادر می‌سازد تا حجم بسیار متفاوتی از درخواست‌ها را از نمونه‌های برنامه مدیریت کنند. صف پیام به عنوان یک بافر عمل می کند که بار را تراز می کند. الگوی تراز بار مبتنی بر صف این سناریو را با جزئیات بیشتری توصیف می کند.