از برنامه ها و سرویس‌ها با استفاده از یک نمونه host  اختصاصی برای broker requests بین کاربر  و برنامه یا سرویس‌های مختلف محافظت کنید. broker  درخواست‌ها را تأیید و پاکسازی می‌کند و می‌تواند یک لایه امنیتی اضافی فراهم کند و سطح حمله سیستم را محدود کند.

## **طرح صورت مسئله:**

سرویس‌های ابری endpointهایی را نشان می‌دهند که به برنامه‌های سرویس گیرنده اجازه می‌دهند تا APIهای خود را فراخوانی کنند. کد مورد استفاده برای پیاده سازی API ها چندین کار را انجام می دهد، از جمله احراز هویت، مجوزها، اعتبارسنج و برخی یا همه پردازش درخواست‌ها. کد API احتمالاً از طرف کاربر به فضای ذخیره سازی و سایر سرویس ها دسترسی دارد.

اگر یک کاربر مخرب سیستم را در معرض خطر قرار دهد و به محیط میزبانی برنامه دسترسی پیدا کند، مکانیسم‌های امنیتی و دسترسی به داده‌ها و سایر سرویس‌ها در معرض خطر قرار داده می‌شود. در نتیجه، کاربر مخرب می تواند دسترسی نامحدودی به اعتبارنامه ها، storage keys، اطلاعات حساس و سایر سرویس‌ها داشته باشد.

 از فصل مقدمه می دانیم که **Endpoint** در نرم‌افزار به دستگاه‌های فیزیکی یا مجازی اشاره دارد که به یک شبکه متصل شده و اطلاعات را با آن تبادل می‌کنند.
## راه حل

یک راه حل برای این مشکل جدا کردن کدی است که  endpoints عمومی را پیاده سازی می کند از کدی که درخواست ها را پردازش می کند و به فضای ذخیره سازی دسترسی دارد. شما می توانید با استفاده از یک نما (façade) یا نوعی تسک اختصاصی که با کاربر تعامل دارد و در ادامه درخواست‌ها را (شاید از طریق یک interface جداگانه) به hostها یا تسک‌هایی که درخواست‌ها را پردازش می کنند ارسال می‌کند، به  این جداسازی مورد نظر برسید. شکل زیر نمای کلی و سطح بالایی از این الگو را ارائه می دهد.

![[Pasted image 20230908151120.png]]

الگوی gatekeeper می‌تواند برای محافظت از فضای ذخیره‌سازی استفاده شود، یا می‌توان از آن به‌عنوان façade (نمای) جامع‌تری برای محافظت از تمام عملکردهای برنامه استفاده کرد. عوامل مهم عبارتند از:
* **Controlled validation** (اعتبار سنجی کنترل شده) gatekeeper تمام درخواست‌ها را تأیید می‌کند و درخواست‌هایی را که الزامات اعتبارسنجی را برآورده نمی‌کنند رد می‌کند.
* **Limited risk and exposure** در واقع gatekeeper به اعتبارنامه‌ها یا کلیدهایی که مورد اعتماد host که برای دسترسی به فضای ذخیره‌سازی و سرویس‌ها استفاده می‌کند، دسترسی ندارد. اگر gatekeeper به خطر بیفتد، مهاجم به این اعتبارنامه‌ها یا کلیدها دسترسی نخواهد داشت.
* **Appropriate security**   همینطور gatekeeper در یک حالت دسترسی محدود شده اجرا می‌شود، در حالی که بقیه برنامه‌ها در حالت  full trust mode مورد نیاز برای دسترسی به فضای ذخیره‌سازی و سرویس‌ها اجرا می‌شوند. اگر gatekeeper به خطر بیفتد، نمی‌تواند مستقیماً به سرویس‌ها یا داده‌های برنامه دسترسی داشته باشد.

این الگو مانند یک فایروال در یک توپوگرافی شبکه معمولی عمل می کند. این به gatekeeper اجازه می دهد تا درخواست ها را بررسی کند و تصمیم بگیرد که آیا درخواست را به میزبان مورد اعتمادی که وظایف مورد نیاز را انجام می دهد ارسال کند یا خیر. این تصمیم معمولاً از gatekeeper می‌خواهد که محتوای درخواست را قبل از ارسال آن به trusted host تأیید و پاکسازی کند.

### مسائل و ملاحظات:

هنگام تصمیم گیری در مورد نحوه اجرای این الگو به نکات زیر توجه کنید:  
  
* اطمینان حاصل کنید که host‌های مورد اعتماد فقط endpointهای داخلی یا محافظت شده را که فقط توسط gatekeeper استفاده می‌شود، در معرض دید قرار(expose) می‌دهند. host‌ های مورد اعتماد نباید هیچ  endpoint خارجی یا اینترفیس‌ها را در معرض دید قرار دهند.  
* در واقع gatekeeper باید در یک حالت دسترسی محدود (limited privilege) اجرا شود که معمولاً نیاز به اجرای gatekeeper و host مورد اعتماد در سرویس‌های host جداگانه یا ماشین‌های مجازی دارد.
* همینطور gatekeeper نباید هیچ گونه پردازش مربوط به برنامه یا سرویس را انجام دهد یا به هیچ داده ای دسترسی داشته باشد. عملکرد آن صرفاً اعتبارسنجی و صحت سنجی درخواست ها است. hostهای مورد اعتماد ممکن است نیاز به تأیید اعتبار درخواست اضافی داشته باشند، اما gatekeeper باید اعتبارسنجی اصلی را انجام دهد.
* در صورت امکان از یک کانال ارتباطی امن (HTTPS، SSL یا TLS) بین gatekeeper و hostها یا task مورد اعتماد استفاده کنید. با این حال، برخی از hosting environments از HTTPS در endpointهای داخلی پشتیبانی نمی‌کنند.
* افزودن لایه اضافی برای اجرای الگوی gatekeeper به دلیل پردازش اضافی و ارتباطات شبکه مورد نیاز، احتمالاً بر عملکرد کلی سیستم تأثیر می‌گذارد.
* یک gatekeeper instance می تواند تنها یک نقطه شکست باشد. برای به حداقل رساندن تأثیر خرابی، به کارگیری نمونه های اضافی و استفاده از مکانیزم autoscaling برای اطمینان از ظرفیت برای حفظ در دسترس بودن gatekeeper را در نظر بگیرید.

### چه زمانی از این الگو استفاده کنیم؟


این الگو برای برنامه هایی مفید است که:

* مدیریت اطلاعات حساس  
* نمایش دادن سرویس‌هایی که نیاز به درجه بالایی از محافظت در برابر حملات مخرب دارند  
* انجام عملیات‌های مهم و حیاتی که نمی‌توان آنها را در نظر نگرفت کرد.
* نیاز به اعتبار سنجی درخواست‌ها به طور جداگانه از وظایف اصلی انجام شود یا این اعتبارسنجی برای ساده کردن تعمیر و نگهداری و مدیریت متمرکز شود.

## مثال

در یک سناریوی  مبتنی بر محیط ابری از این الگو را می توان با جدا کردن نقش gatekeeper یا ماشین مجازی از نقش‌ها و سرویس‌های قابل اعتماد در یک اپلیکیشن پیاده‌سازی کرد. پیاده سازی می تواند از یک endpoint داخلی، یک صف یا ذخیره سازی به عنوان مکانیزم  ارتباطی میانی  استفاده کند. شکل زیر این الگو را با استفاده از یک endpoint داخلی را نشان می دهد.

![[Pasted image 20230908152728.png]]

## منابع مرتبط

الگوی [Valet Key pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/valet-key) ممکن است هنگام اجرای الگوی Gatekeeper نیز مرتبط و مورد نیاز باشد. هنگام برقراری ارتباط بین Gatekeeper و نقش یا role‌های مورد اعتماد، تقویت امنیت با استفاده از کلیدها یا توکن‌هایی که مجوزهای(permissions) دسترسی به منابع را محدود می‌کنند، تمرین خوبی است. این الگو استفاده از یک توکن یا کلید را توصیف می کند که دسترسی محدود و مستقیم به یک منبع یا سرویس خاص را برای clientها فراهم می کند.