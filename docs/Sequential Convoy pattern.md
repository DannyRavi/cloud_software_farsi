
مجموعه ای از پیام های مرتبط را به ترتیب تعریف شده پردازش کنید، بدون اینکه پردازش گروه های دیگر پیام ها را مسدود کنید.

## Context and problem

برنامه‌ها معمولاً نیاز دارند دنباله‌ای از پیام‌ها را به ترتیبی که می‌رسند پردازش کنند، در حالی که همچنان می‌توانند برای مدیریت بار افزایش یافته، مقیاس را کاهش دهند. در یک معماری توزیع‌شده، پردازش این پیام‌ها به ترتیب ساده نیست، زیرا کارگران می‌توانند به طور مستقل مقیاس کنند و اغلب پیام‌ها را به‌طور مستقل با استفاده از الگوی مصرف‌کنندگان رقیب بکشند.  
  
به عنوان مثال، یک سیستم ردیابی سفارش، دفتری را دریافت می کند که حاوی سفارشات و عملیات مربوط به آن سفارش ها است. این عملیات می تواند ایجاد یک سفارش، افزودن یک تراکنش به سفارش، اصلاح تراکنش گذشته یا حذف یک سفارش باشد. در این سیستم، عملیات باید به صورت first-in-first-out (FIFO) انجام شود، اما فقط در سطح سفارش. با این حال، صف اولیه یک دفتر کل حاوی تراکنش‌های بسیاری از سفارش‌ها را دریافت می‌کند، که ممکن است به‌هم‌پیوسته باشد.

## Solution

پیام‌های مرتبط را به دسته‌هایی در سیستم صف فشار دهید و از شنوندگان صف بخواهید که فقط از یک دسته، یک پیام در یک زمان، قفل کنند و بکشند.

در اینجا الگوی عمومی کاروان متوالی به نظر می رسد:

![[Pasted image 20231127161022.png]]

همانطور که در نمودار زیر نشان داده شده است، در صف، پیام‌های دسته‌های مختلف ممکن است به هم متصل شوند:

![[Pasted image 20231127161047.png]]

## Issues and considerations

هنگام تصمیم گیری در مورد نحوه اجرای این الگو به نکات زیر توجه کنید:

* دسته/واحد مقیاس. کدام ویژگی پیام‌های دریافتی‌تان را می‌توانید کاهش دهید؟ در سناریوی پیگیری سفارش، این ویژگی شناسه سفارش است.
* توان عملیاتی. خروجی پیام هدف شما چقدر است؟ اگر بسیار زیاد است، ممکن است لازم باشد الزامات FIFO خود را تجدید نظر کنید. به عنوان مثال، آیا می توانید پیام شروع/پایان را اعمال کنید، بر اساس زمان مرتب کنید، سپس یک دسته را برای پردازش بفرستید؟
* قابلیت های خدماتی آیا انتخاب گذرگاه پیام شما امکان پردازش یک‌باره پیام‌ها را در یک صف یا دسته‌بندی صف فراهم می‌کند؟
* تکامل پذیری چگونه دسته جدیدی از پیام ها را به سیستم اضافه می کنید؟ برای مثال، فرض کنید سیستم دفتر کل شرح داده شده در بالا یک مشتری خاص است. اگر نیاز داشتید مشتری جدیدی را وارد کنید، آیا می‌توانید مجموعه‌ای از پردازنده‌های دفتر کل را داشته باشید که کار را در هر شناسه مشتری توزیع می‌کنند؟
* این احتمال وجود دارد که مصرف‌کنندگان پیامی را دریافت کنند که به دلیل تاخیر شبکه در هنگام ارسال پیام‌ها، ناموفق است. استفاده از اعداد ترتیبی را برای تأیید سفارش در نظر بگیرید. همچنین ممکن است در آخرین پیام تراکنش یک پرچم خاص «پایان توالی» قرار دهید. فناوری‌های پردازش جریانی مانند Spark یا Azure Stream Analytics می‌توانند پیام‌ها را به ترتیب در یک پنجره زمانی پردازش کنند.


## When to use this pattern

از این الگو زمانی استفاده کنید که:

شما پیام هایی دارید که به ترتیب می رسند و باید به همان ترتیب پردازش شوند.
پیام‌های دریافتی به‌گونه‌ای «دسته‌بندی» می‌شوند یا می‌توان آن‌ها را به‌گونه‌ای «رده‌بندی» کرد که دسته‌بندی به یک واحد مقیاس برای سیستم تبدیل شود.
این الگو ممکن است برای موارد زیر مناسب نباشد:

سناریوهای توان عملیاتی بسیار بالا (میلیون‌ها پیام در دقیقه یا ثانیه)، زیرا الزامات FIFO مقیاس‌بندی قابل انجام توسط سیستم را محدود می‌کند.

## Example

در Azure، این الگو را می توان با استفاده از جلسات پیام Azure Service Bus پیاده سازی کرد. برای مصرف‌کنندگان، می‌توانید از برنامه‌های منطقی با رابط قفل قفل سرویس اتوبوس یا عملکردهای Azure با ماشه سرویس اتوبوس استفاده کنید.

برای مثال قبلی ردیابی سفارش، هر پیام دفتر کل را به ترتیبی که دریافت کرده است پردازش کنید و هر تراکنش را به صف دیگری ارسال کنید، جایی که دسته روی شناسه سفارش تنظیم شده است. در این سناریو، یک تراکنش هرگز چندین سفارش را در بر نمی گیرد، بنابراین مصرف کنندگان هر دسته را به صورت موازی پردازش می کنند اما FIFO در آن دسته است.

فن پردازنده لبه پیام ها را با جدا کردن محتوای هر پیام در صف اول ارسال می کند:

![[Pasted image 20231127161423.png]]

پردازنده دفتر کل به موارد زیر رسیدگی می کند:

1- یک تراکنش در دفتر کل.
2- تنظیم شناسه جلسه پیام برای مطابقت با شناسه سفارش.
3- ارسال هر تراکنش دفتر کل به یک صف ثانویه با شناسه جلسه روی شناسه سفارش تنظیم شده است.
مصرف کنندگان به صف ثانویه گوش می دهند که در آن همه پیام ها را با شناسه های سفارش منطبق به ترتیب از صف پردازش می کنند. مصرف کنندگان از حالت قفل نگاه کردن استفاده می کنند.

وقتی مقیاس پذیری را در نظر می گیریم، صف دفتر یک گلوگاه اصلی است. تراکنش های مختلف ارسال شده به دفتر کل می تواند به همان شناسه سفارش اشاره کند. با این حال، پیام‌ها می‌توانند بعد از دفتر کل تعداد سفارش‌ها در یک محیط بدون سرور منتشر شوند.

### ## Next steps

اطلاعات زیر ممکن است هنگام اجرای این الگو مرتبط باشد:

جلسات پیام: اولین ورود، اولین خروج (FIFO)
پیام Peek-Lock (غیر مخرب خواندن)
برای تحویل سفارش پیام های مرتبط در برنامه های منطقی با استفاده از جلسات سرویس اتوبوس (وبلاگ MSDN)

