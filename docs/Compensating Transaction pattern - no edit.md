
وقتی از یک عملیات در نهایت سازگار که شامل یک سری مراحل است استفاده می کنید، الگوی تراکنش جبرانی می تواند مفید باشد. به طور خاص، اگر یک یا چند مرحله با شکست مواجه شد، می‌توانید از الگوی تراکنش جبرانی برای خنثی کردن کارهای انجام شده در مراحل استفاده کنید. به طور معمول، شما عملیاتی را پیدا می کنید که از مدل سازگاری نهایی در برنامه های کاربردی میزبان ابری پیروی می کند که فرآیندها و گردش های کاری پیچیده را پیاده سازی می کنند.

## Context and problem

برنامه هایی که در فضای ابری اجرا می شوند اغلب داده ها را تغییر می دهند. این داده ها گاهی اوقات در منابع مختلف داده در مکان های جغرافیایی مختلف پخش می شوند. برای جلوگیری از مشاجره و بهبود عملکرد در یک محیط توزیع شده، یک برنامه نباید سعی کند ثبات تراکنش های قوی را ارائه دهد. در عوض، برنامه باید سازگاری نهایی را اجرا کند. در مدل سازگاری نهایی، یک عملیات تجاری معمولی شامل یک سری مراحل جداگانه است. در حالی که عملیات این مراحل را انجام می دهد، نمای کلی وضعیت سیستم ممکن است ناسازگار باشد. اما وقتی عملیات تمام شد و تمام مراحل اجرا شد، سیستم باید دوباره سازگار شود.  
  
Data Consistency Primer اطلاعاتی در مورد اینکه چرا تراکنش های توزیع شده به خوبی مقیاس نمی شوند، ارائه می دهد. این منبع همچنین اصول مدل سازگاری نهایی را فهرست می کند.  
  
یک چالش در مدل سازگاری نهایی این است که چگونه مرحله ای را که شکست می خورد مدیریت کنیم. پس از شکست، ممکن است لازم باشد تمام کارهایی را که مراحل قبلی در عملیات انجام داده‌اند، لغو کنید. با این حال، همیشه نمی توانید داده ها را به عقب برگردانید، زیرا سایر نمونه های همزمان برنامه ممکن است آن را تغییر داده باشند. حتی در مواردی که نمونه‌های همزمان داده‌ها را تغییر نداده‌اند، لغو یک مرحله ممکن است پیچیده‌تر از بازگرداندن حالت اولیه باشد. ممکن است لازم باشد قوانین مختلفی برای کسب و کار خاص اعمال شود. برای مثال، به وب‌سایت مسافرتی که بخش مثال در ادامه این مقاله توضیح می‌دهد، مراجعه کنید.  
  
اگر عملیاتی که سازگاری نهایی را اجرا می‌کند، چندین فروشگاه داده ناهمگن را در بر می‌گیرد، لغو مراحل در عملیات مستلزم بازدید از هر ذخیره‌گاه داده به نوبه خود است. برای جلوگیری از ناسازگار ماندن سیستم، باید کاری را که در هر ذخیره‌گاه داده انجام داده‌اید، به‌طور قابل اعتمادی لغو کنید.  
  
داده‌هایی که تحت تأثیر عملیاتی قرار می‌گیرند که سازگاری نهایی را پیاده‌سازی می‌کند، همیشه در یک پایگاه داده نگهداری نمی‌شوند. به عنوان مثال، یک محیط معماری سرویس گرا (SOA) را در نظر بگیرید. یک عملیات SOA می تواند یک عمل را در یک سرویس فراخوانی کند و باعث تغییر در وضعیتی شود که توسط آن سرویس نگهداری می شود. برای لغو عملیات، باید این تغییر حالت را نیز لغو کنید. این فرآیند می‌تواند شامل فراخوانی مجدد سرویس و انجام عمل دیگری باشد که اثرات اولین را معکوس می‌کند.

## Solution

راه حل اجرای یک تراکنش جبرانی است. مراحل یک تراکنش جبرانی، اثرات مراحل در عملیات اصلی را خنثی می کند. یک رویکرد شهودی جایگزینی وضعیت فعلی با وضعیتی است که سیستم در شروع عملیات در آن قرار داشت. اما یک تراکنش جبران‌کننده همیشه نمی‌تواند این رویکرد را داشته باشد، زیرا ممکن است تغییراتی را که سایر نمونه‌های همزمان یک برنامه ایجاد کرده‌اند، بازنویسی کند. در عوض، یک تراکنش جبرانی باید یک فرآیند هوشمند باشد که هر کاری را که نمونه‌های همزمان انجام می‌دهند در نظر بگیرد. این فرآیند معمولاً به یک برنامه خاص بستگی دارد و به دلیل ماهیت کاری که عملیات اصلی انجام می دهد هدایت می شود.  
  
یک رویکرد متداول استفاده از یک گردش کار برای اجرای یک عملیات در نهایت سازگار است که نیاز به جبران دارد. همانطور که عملیات اصلی پیش می رود، سیستم اطلاعات مربوط به هر مرحله را ثبت می کند، از جمله نحوه لغو کاری که مرحله انجام می دهد. اگر عملیات در هر نقطه ای با شکست مواجه شود، گردش کار طی مراحلی که انجام داده است به عقب برمی گردد. در هر مرحله، گردش کار کاری را انجام می دهد که آن مرحله را معکوس می کند.

دو نکته مهم عبارتند از:  
  
* یک تراکنش جبرانی ممکن است مجبور نباشد کار را دقیقاً به ترتیب معکوس عملیات اصلی لغو کند.  
ممکن است بتوان برخی از مراحل واگرد را به صورت موازی انجام داد.  
* این رویکرد شبیه به استراتژی Sagas است که در وبلاگ Clemens Vasters مورد بحث قرار گرفته است.  
  
یک تراکنش جبرانی خود یک عملیات در نهایت سازگار است، بنابراین ممکن است شکست بخورد. سیستم باید بتواند تراکنش جبرانی را در نقطه شکست از سر گرفته و ادامه دهد. ممکن است لازم باشد مرحله ای را تکرار کنید که ناموفق است، بنابراین باید مراحل یک تراکنش جبرانی را به عنوان دستورات بی قدرت تعریف کنید. برای اطلاعات بیشتر، الگوهای عدم توانایی را در وبلاگ جاناتان الیور ببینید.  
  
در برخی موارد، مداخله دستی ممکن است تنها راه بازیابی از مرحله ای باشد که شکست خورده است. در این شرایط، سیستم باید یک هشدار داده و تا حد امکان اطلاعات بیشتری در مورد دلیل خرابی ارائه دهد

## Issues and considerations

هنگام تصمیم گیری در مورد نحوه اجرای این الگو به نکات زیر توجه کنید:  
  
* تشخیص اینکه چه زمانی یک مرحله از عملیاتی که سازگاری نهایی را اجرا می کند، ممکن است آسان نباشد. یک قدم ممکن است فوراً شکست نخورد. در عوض، ممکن است مسدود شود. ممکن است لازم باشد مکانیزمی را برای زمان‌بندی اجرا کنید.  
  
* تعمیم منطق جبران کار آسانی نیست. یک تراکنش جبرانی مختص برنامه کاربردی است. این متکی است که برنامه دارای اطلاعات کافی است تا بتواند اثرات هر مرحله را در یک عملیات ناموفق خنثی کند.  
  
* شما باید مراحل یک تراکنش جبرانی را به عنوان دستورات بی قدرت تعریف کنید. اگر این کار را انجام دهید، در صورت شکست خود تراکنش جبران‌کننده، می‌توان مراحل را تکرار کرد.  
  
* زیرساختی که مراحل را انجام می دهد باید معیارهای زیر را داشته باشد:  
  
	- در عملیات اصلی و در معامله جبرانی انعطاف پذیر است.  
	- اطلاعات لازم برای جبران یک مرحله شکست خورده را از دست نمی دهد.  
	- به طور قابل اعتمادی پیشرفت منطق جبران خسارت را نظارت می کند.  

* یک تراکنش جبرانی لزوماً داده های سیستم را به وضعیت خود در شروع عملیات اصلی بر نمی گرداند. در عوض، تراکنش کاری را که عملیات قبل از شکست با موفقیت انجام شده بود، جبران می کند.  
  
* ترتیب مراحل در تراکنش جبرانی لزوماً دقیقاً برعکس مراحل عملیات اصلی نیست. به عنوان مثال، یک فروشگاه داده ممکن است نسبت به دیگری نسبت به ناهماهنگی حساس تر باشد. مراحل تراکنش جبرانی که تغییرات این فروشگاه را خنثی می کند باید ابتدا انجام شود.  
  
* اقدامات خاصی می تواند به افزایش احتمال موفقیت کلی فعالیت کمک کند. به طور خاص، می‌توانید قفل کوتاه‌مدت و مبتنی بر زمان‌اوت را روی هر منبعی که برای تکمیل یک عملیات لازم است قرار دهید. شما همچنین می توانید این منابع را از قبل دریافت کنید. سپس، کار را فقط پس از به دست آوردن تمام منابع انجام دهید. تمام اقدامات را قبل از منقضی شدن قفل ها نهایی کنید.  
  
* سعی مجدد منطقی که بخشنده تر از حد معمول است می تواند به به حداقل رساندن شکست هایی که باعث تراکنش جبرانی می شود کمک کند. اگر مرحله ای از عملیاتی که سازگاری نهایی را اجرا می کند با شکست مواجه شد، سعی کنید شکست را به عنوان یک استثنا گذرا مدیریت کنید و مرحله را تکرار کنید. عملیات را متوقف کنید و یک تراکنش جبرانی را فقط در صورتی شروع کنید که یک مرحله مکرراً با شکست مواجه شود یا نتوان آن را بازیابی کرد.  
  
* هنگامی که یک تراکنش جبرانی را پیاده سازی می کنید، با بسیاری از چالش های مشابهی روبرو می شوید که هنگام اجرای یکپارچگی نهایی با آن مواجه می شوید. برای کسب اطلاعات بیشتر، به بخش 'ملاحظات برای اجرای سازگاری نهایی' در Data Consistency Primer مراجعه کنید.

## When to use this pattern


از این الگو فقط برای عملیاتی استفاده کنید که در صورت شکست باید لغو شوند. در صورت امکان، راه حل هایی طراحی کنید تا از پیچیدگی نیاز به تراکنش های جبرانی جلوگیری شود.

## Example

مشتریان از یک وب سایت سفر برای رزرو برنامه های سفر استفاده می کنند. یک برنامه سفر ممکن است شامل یک سری پرواز و هتل باشد. مشتری که از سیاتل به لندن و سپس به پاریس سفر می کند، ممکن است مراحل زیر را هنگام ایجاد یک برنامه سفر انجام دهد:

1- در پرواز F1 از سیاتل به لندن صندلی رزرو کنید.  
2- در پرواز F2 از لندن به پاریس صندلی رزرو کنید.  
3- در پرواز F3 از پاریس به سیاتل صندلی رزرو کنید.  
4- اتاقی را در هتل H1 لندن رزرو کنید.  
5- رزرو اتاق در هتل H2 در پاریس.

این مراحل یک عملیات در نهایت سازگار را تشکیل می دهند، اگرچه هر مرحله یک عمل جداگانه است. علاوه بر انجام این مراحل، سیستم باید عملیات شمارنده را نیز برای لغو هر مرحله ثبت کند. در صورتی که مشتری برنامه سفر را لغو کند به این اطلاعات نیاز است. مراحلی که برای انجام عملیات شمارنده لازم است می توانند به عنوان یک تراکنش جبرانی اجرا شوند.  
  
ممکن است مراحل تراکنش جبرانی دقیقاً برعکس مراحل اولیه نباشد. همچنین، منطق هر مرحله در تراکنش جبرانی باید قوانین خاص کسب و کار را در نظر بگیرد. به عنوان مثال، لغو رزرو پرواز ممکن است به مشتری حق بازپرداخت کامل را نداشته باشد.  
  
شکل زیر مراحل یک تراکنش طولانی مدت برای رزرو برنامه سفر را نشان می دهد. همچنین می توانید مراحل تراکنش جبرانی را که تراکنش را خنثی می کند، مشاهده کنید.

![[Pasted image 20231203234351.png]]

```
توجه داشته باشید  
  
بسته به نحوه طراحی منطق جبران کننده برای هر مرحله، ممکن است بتوانید مراحل تراکنش جبرانی را به صورت موازی انجام دهید.

```

در بسیاری از راه حل های تجاری، شکست یک مرحله واحد همیشه مستلزم عقب نشینی سیستم با استفاده از تراکنش جبرانی نیست. به عنوان مثال، سناریوی وب سایت سفر را در نظر بگیرید. فرض کنید مشتری پروازهای F1، F2 و F3 را رزرو می کند اما نمی تواند اتاقی در هتل H1 رزرو کند. ترجیحاً به جای لغو پروازها، اتاقی در هتل دیگری در همان شهر به مشتری پیشنهاد دهید. مشتری همچنان می تواند تصمیم به لغو را بگیرد. در آن صورت، تراکنش جبرانی اجرا می شود و رزرو پروازهای F1، F2 و F3 را لغو می کند. اما مشتری باید این تصمیم را بگیرد نه سیستم.

## Next steps

* پرایمر سازگاری داده الگوی تراکنش جبرانی اغلب برای خنثی سازی عملیاتی که مدل سازگاری نهایی را پیاده سازی می کند، استفاده می شود. این پرایمر اطلاعاتی در مورد مزایا و معاوضه های سازگاری نهایی ارائه می دهد.  
* الگوهای بی توانی در یک تراکنش جبرانی، بهتر است از دستورات idempotent استفاده کنید. این پست وبلاگ فاکتورهایی را توضیح می دهد که باید هنگام اجرای ناتوانی در نظر بگیرید.

## Related resources

* الگوی ناظر نماینده زمانبند. این مقاله نحوه پیاده‌سازی سیستم‌های انعطاف‌پذیر را شرح می‌دهد که عملیات تجاری را انجام می‌دهند که از خدمات و منابع توزیع شده استفاده می‌کنند. در این سیستم‌ها، گاهی اوقات لازم است از یک تراکنش جبران‌کننده برای لغو کاری که یک عملیات انجام می‌دهد استفاده کنید.  
* الگو را دوباره امتحان کنید. تراکنش های جبرانی می تواند از نظر محاسباتی سخت باشد. می‌توانید با استفاده از الگوی Retry برای اجرای یک سیاست مؤثر برای تلاش مجدد عملیات ناموفق، استفاده از آنها را به حداقل برسانید.  
* الگوی معاملات توزیع شده ساگا این مقاله نحوه استفاده از الگوی Saga را برای مدیریت سازگاری داده ها در میان ریزسرویس ها در سناریوهای تراکنش توزیع شده توضیح می دهد. الگوی Saga بازیابی شکست را با تراکنش های جبرانی مدیریت می کند.  
* الگوی لوله ها و فیلترها این مقاله الگوی لوله‌ها و فیلترها را توضیح می‌دهد که می‌توانید از آن برای تجزیه یک کار پردازشی پیچیده به یک سری از عناصر قابل استفاده مجدد استفاده کنید. می توانید از الگوی Pipes and Filters با الگوی تراکنش جبرانی به عنوان جایگزینی برای اجرای تراکنش های توزیع شده استفاده کنید.  
* طراحی برای خود درمانی این راهنما نحوه طراحی برنامه های خود درمانی را توضیح می دهد. می توانید از تراکنش های جبرانی به عنوان بخشی از رویکرد خود درمانی استفاده کنید.