
الگوی Geode شامل استقرار مجموعه‌ای از سرویس‌های پشتیبان در مجموعه‌ای از گره‌های جغرافیایی است که هر کدام می‌توانند هر درخواستی را برای هر مشتری در هر منطقه ارائه دهند. این الگو اجازه می دهد تا درخواست ها را به سبک فعال-فعال(_active-active_) ارائه کند، با توزیع توان پردازشی  مربوط به درخواست‌ها در سراسر جهان، تأخیر زمانی را بهبود بخشد و دسترسی را افزایش دهد.

![[Pasted image 20231203231759.png]]
## **طرح صورت مسئله:**

بسیاری از سرویس‌هایی که مقیاس بزرگی دارند، چالش‌های خاصی در مورد دسترسی جغرافیایی و مقیاس‌پذیری (scale) دارند. طرح‌های کلاسیک اغلب داده‌ها را با ذخیره داده‌ها در یک سرور SQL ریموت که به عنوان لایه محاسباتی برای آن داده‌ها عمل کرده و محاسبه و پردازش می‌کنند که با توجه به scale-up کردن سرویس های می توان این توان محاسباتی را افزایش داد.  
  
رویکرد کلاسیک ممکن است تعدادی چالش را به همراه داشته باشد:  
  
* مشکلات تأخیر شبکه برای کاربرانی که از آن سوی جهان می آیند تا به host endpoint متصل شوند.  
* مدیریت ترافیک برای افزایش ناگهانی تقاضا که می تواند سرویس‌ها را در یک منطقه تحت الشعاع قرار دهد. 
* پیچیدگی و پرهزینه بودن استقرار نسخه‌های زیرساخت برنامه در چندین منطقه برای یک سرویس با مصرف ماهانه به صورت  24x7 که به معنی 24 ساعت در 7 روز هفته است.  

زیرساخت‌های ابری مدرن برای تعادل بار جغرافیایی(geographic load balancing) جهت سرویس‌های front-end، تکامل یافته است. در حالی که امکان تکرار کردن جغرافیایی (geographic replication) سرویس‌ها backend را فراهم می‌کند. پس برای افزایش کیفیت مورد‌هایی مثل در دسترس بودن(availability) و کارایی(performance) بهتر است نزدیکتر کردن مکان فیزیکی اطلاعات به کاربرها رو به عنوان یک گزینه خوب در نظر بگیریم. هنگامی داده ها از نظر فیزیکی و جغرافیایی دور از کاربر قرار دارد، ذخیره‌ساز یا datastore توزیع شده‌ی-جغرافیایی(geo-distributed) نیز باید با منابع محاسباتی که داده ها را پردازش می کنند در کنار هم قرار گیرند. در این حالت الگوی Geode  منابع محاسباتی و پرادزشی لازم را برای داده ها ممکن می‌کند.

## راه حل

این سرویس را در تعدادی از استقرارهای ماهواره‌ای (satellite deployments) که در سرتاسر جهان پخش شده‌اند، مستقر کنید که هر کدام از آن‌ها یک Geode نامیده می‌شوند. الگوی Geode از ویژگی‌های کلیدی Azure برای هدایت ترافیک از طریق کوتاه‌ترین مسیر به Geode نزدیک استفاده می‌کند که تأخیر زمانی و کارایی را بهبود می‌بخشد. هر Geode پشت یک متعادل‌ساز بار سرتاسری (global load balancer) قرار دارد و از یک سرویس خواندن-نوشتن تکرار شونده جغرافیایی(geo-replicated) مانند [Azure Cosmos DB](https://learn.microsoft.com/en-us/azure/cosmos-db/introduction) برای میزبانی و host  کردن داده‌ها استفاده می کند و از سازگاری داده های geode متقابل (cross-geode data consistency) اطمینان حاصل می‌کند. سرویس‌های تکرار کننده داده‌ها (Data replication) تضمین می‌کنند که ذخیره‌های داده در سراسر Geodeها یکسان هستند، بنابراین همه درخواست‌ها می‌توانند از همه Geodeها ارائه شوند.  
  
تفاوت اصلی بین [deployment stamp](https://learn.microsoft.com/en-us/azure/architecture/patterns/deployment-stamp) و Geode در این است که Geodeها هرگز به صورت مجزا وجود ندارند. همیشه باید بیش از یک Geode در یک  پروداکشن پلتفرم وجود داشته باشد.

![[Pasted image 20231203231950.png]]


Geodeها دارای مشخصات زیر هستند:

* شامل مجموعه ای از انواع منابع متفاوت است که اغلب در یک قالب تعریف می‌شوند.  
* هیچ وابستگی خارج از محدوده Geode ندارند و مستقل هستند. هیچ Geodeی برای کار کردن به دیگری وابسته نیست و اگر یکی از بین برود بقیه آن ها به کار خود ادامه می دهند.  
* از طریق یک شبکه لبه(edge network) و صفحه پشتی تکرار شونده (replication backplane) به صورت ضعیف متصل می شوند. به عنوان مثال، می‌توانید از [Azure Traffic Manager](https://learn.microsoft.com/en-us/azure/traffic-manager/traffic-manager-overview) یا [Azure Front Door](https://learn.microsoft.com/en-us/azure/frontdoor/front-door-overview) برای قسمت جلویی Geodeها استفاده کنید، در حالی که Azure Cosmos DB می‌تواند به عنوان replication backplane عمل کند. البته Geodeها به گروه‌ یا دسته‌های یکسان شبیه نیستند، زیرا آنها یک replication backplane را به اشتراک می گذارند، بنابراین پلتفرم از مسائل حداقلی رسیدگی می‌کند.

الگوی Geode در معماری‌های کلان داده‌ها (big data) رخ می‌دهد که از این نوع روش برای پردازش داده‌های موجود در یک ماشین و از MapReduce (برای یاد آوری MapReduce به مقدمه رجوع شود) برای ادغام نتایج در بین ماشین‌ها استفاده می‌کنند. کاربرد دیگر محاسبات نزدیک به لبه (near-edge compute) است که برای کاهش زمان پاسخ، محاسبات را به لبه هوشمند شبکه(intelligent edge of the network) نزدیک می کند.  
  
سرویس ها می توانند از این الگو در ده ها یا صدها Geode استفاده کنند. علاوه بر این، انعطاف‌پذیری کل  با هر Geode اضافه‌شده افزایش می‌یابد، زیرا اگر یک یا چند Geode آفلاین شود، هر Geode می‌تواند کار را به دست بگیرد.  
  
همچنین می‌توان تکنیک‌های در دسترس بودن محلی(local availability)، مانند مناطق در دسترس یا مناطق paired را با الگوی Geode برای در دسترس بودن جهانی افزایش داد. اگر چه این مورد  پیچیدگی را افزایش می‌دهد، اما در صورتی مفید است که معماری شما توسط یک م<mark style="background: #FFF3A3A6;">وتور ذخیره‌سازی مانند  blob storage که فقط می‌تواند به یک منطقه paired شده تکثیر (replicate)  شود، پشتیبانی شود.</mark> شما می توانید Geodeها را در یک ناحیه درون منطقه‌ای با توجه به محدودیت های نظارتی یا تاخیر زمانی محدود کننده در موقعیت مورد نظر، مستقر کنید.
## مسائل و ملاحظات:

برای اجرای این الگو از تکنیک ها و فناوری های زیر استفاده کنید:  

* استفاده از روش‌ها و ابزارهای مدرن DevOps  برای تولید و deploy سریع Geodeهای یکسان در تعداد زیادی از مناطق یا نمونه‌های مختلف.  
* مقیاس دهی خودکار(Autoscaling) برای scale out کردن توان محاسباتی و  ساخت نمونه هایی از دیتابیس درون یک Geode. هر Geode به‌طور جداگانه درون یک صفحه پشتی (backplane) به صورت اجباری  scales out می شود. 
* یک سرویس front-end مانند Azure Front Door که  فرآیند شتاب دهی به محتوای پویا(dynamic content acceleration) و [split TCP](https://learn.microsoft.com/en-us/azure/frontdoor/front-door-traffic-acceleration?pivots=front-door-standard-premium) و [Anycast routing](https://en.wikipedia.org/wiki/Anycast) را انجام می‌دهد.  
* یک ذخیره‌سازی داده در حالت تکراری (replicating) مانند Azure Cosmos DB برای کنترل سازگاری داده‌ها.  
* فناوری‌های [Serverless](https://en.wikipedia.org/wiki/Serverless_computing) در صورت امکان، برای کاهش هزینه‌های deployment، به‌ویژه زمانی که load در سرتاسر جهان مرتباً متعادل (rebalanced) می‌شود. این استراتژی به بسیاری از Geodeها اجازه می دهد تا با حداقل سرمایه گذاری اضافی deploy شوند. فناوری‌های پرداخت صورت‌حساب Serverless و مبتنی بر مصرف([pay as you go](https://en.wikipedia.org/wiki/Pay_as_you_go))،  هزینه‌های ناشی از deploymentهای تکراری شونده و توزیع‌شده جغرافیایی(geo-distributed) را کاهش می‌دهند.  
* ‏API Management برای پیاده‌سازی در این الگوی طراحی لازم نیست، اما می‌توان آن را به هر Geodeی که در جلوی Azure Function App در یک ناحیه قرار می‌گیرد اضافه کرد تا یک لایه API قوی‌تر ارائه کند، به‌عنوان مثال، اجرای عملکردهای اضافی مانند محدودیت نرخ یا rate limit را ممکن می‌سازد.  



هنگام تصمیم گیری در مورد نحوه اجرای این الگو به نکات زیر توجه کنید:  
  
* انتخاب کنید که داده‌ها به صورت محلی در هر منطقه پردازش شوند یا به صورت تجمعی در یک Geode توزیع شوند و در نهایت در سراسر جهان تکرار (replicate) شود. [Azure Cosmos DB change feed processor](https://learn.microsoft.com/en-us/azure/cosmos-db/change-feed-processor) این کنترل دانه‌ای (granular control که به معنی توانایی تنظیم و مدیریت دسترسی کاربر به مناطق مختلف یک سیستم در یک سطح بسیار خاص)  را با استفاده از مفهوم _lease container_ و _leasecollectionprefix_ در [Azure Functions binding](https://learn.microsoft.com/en-us/azure/cosmos-db/change-feed-functions) مربوطه ارائه می‌کند. هر رویکرد دارای مزایا و معایب متمایز است.  

* ‏Geodeها می‌توانند پشت سر هم کار کنند، با استفاده از  تغییر ورودی Azure Cosmos DB و یک پلت فرم ارتباطی بلادرنگ مانند SignalR. ‏Geodeها‏ می توانند از طریق Geodeهای دیگر در یک الگوی مش(mesh) مانند با کاربران remote ارتباط برقرار کنند، بدون اینکه بدانند کاربر remote کجا قرار دارد یا اهمیتی بدهد.  

* این الگوی طراحی به طور ضمنی همه چیز را از هم جدا می کند و در نتیجه یک معماری بسیار پراکنده و جدا شده ایجاد می کند. نحوه ردیابی اجزای مختلف یک request را در نظر بگیرید زیرا ممکن است به صورت ناهمزمان(asynchronous) در نمونه های مختلف اجرا شوند. پس برای این کار  یک استراتژی نظارتی مناسب بسیار مهم است. هر دو Azure Front Door و Azure Cosmos DB را می توان به راحتی با Log Analytics ادغام کرد و Azure Functions باید در کنار Application Insights دیپلوی شوند تا یک سیستم نظارتی قوی در هر جزء در معماری ارائه دهند.  
* استقرارهای توزیع شده(Distributed deployments) دارای تعداد بیشتری از رمزها یا secretها و نقاط ورودی (ingress) هستند که به تمهیدات امنیتی خاص نیاز دارند. Key Vault یک لایه امن برای secret management ارائه می کند و هر لایه در معماری API باید به درستی ایمن سازی شود تا تنها نقطه ورودی(ingress) برای API سرویس front-end مانند Azure Front Door باشد. Azure Cosmos DB باید ترافیک را به Azure Function Apps و Function appها را به Azure Front Door با استفاده از Microsoft Entra ID یا اقداماتی مانند محدودیت IP، محدود کند.  
* کارایی (Performance) در این الگو به شدت تحت تأثیر تعداد Geodeهایی است که deploy می شوند، همینطور  App Service خاص اعمال شده در  API در هر Geode نیز روی کارایی تاثیر پذیر است. استقرار Geodeهای اضافی یا حرکت به سمت موردهای پریمیوم (premium) با افزایش هزینه برای حافظه اضافی و محاسبات همراه است، اما این کار را بر اساس هر تراکنش انجام ندهید. آزمایش تست بار (load testing) در معماری API را پس از deploy و contrast افزایش تعداد Geodeها با افزایش سطح قیمت در نظر بگیرید تا مقرون به صرفه ترین مدل برای نیازهای شما استفاده شود.

* الزامات در دسترس بودن(availability) داده های خود را تعیین کنید. Azure Cosmos DB دارای flag های اختیاری برای فعال کردن نوشتن چند منطقه ای(multi-region)، مناطق در دسترس  و موارد دیگر است. این موارد در دسترس بودن را برای نمونه Azure Cosmos DB افزایش می‌دهد و یک لایه داده انعطاف‌پذیرتر ایجاد می‌کند که با هزینه‌های اضافی همراه است.

* ‏Azure انواع متعادل کننده های بار(load balancers) را ارائه می دهد که عملکردهای مختلفی را برای توزیع ترافیک ارائه می دهد. از [decision tree](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/load-balancing-overview#decision-tree-for-load-balancing-in-azure) برای کمک به انتخاب گزینه مناسب برای قسمت front end API خود استفاده کنید.
## چه زمانی از این الگو استفاده کنیم؟

از این الگو استفاده کنید:  
  
* برای پیاده سازی یک پلتفرم در مقیاس بالا(high-scale) که کاربران در یک منطقه گسترده توزیع شده‌اند.  
* برای هر سرویسی که به ویژگی های در دسترس بودن (availability) و انعطاف پذیری شدید نیاز دارد، زیرا سرویس‌ها مبتنی بر الگوی Geode می توانند از دست دادن چندین سرویس در منطقه‌های مختلف که به طور همزمان اتفاق بیافتد، جان سالم به در ببرند.  

این الگو ممکن است مناسب نباشد  
  
* معماری‌هایی که دارای محدودیت‌هایی هستند به طوری که همه Geodeها نمی توانند برای ذخیره‌سازی داده‌ها، برابر باشند. برای مثال، ممکن است الزامات ذخیره داده وجود داشته باشد، برنامه‌ای که نیاز به حفظ حالت موقت برای یک سشن ([session](https://en.wikipedia.org/wiki/Session_(computer_science))) خاص دارد، یا وزن سنگین requestها برای یک منطقه واحد. در این مورد، استفاده از [deployment stamps](https://learn.microsoft.com/en-us/azure/architecture/patterns/deployment-stamp) را در ترکیب با یک صفحه مسیردهی سرتاسری در نظر بگیرید که از محل قرارگیری داده های کاربر آگاه است، مانند مؤلفه مسیریابی ترافیک که در الگوی [deployment stamps](https://learn.microsoft.com/en-us/azure/architecture/patterns/deployment-stamp) توضیح داده شده است.  
* موقعیت هایی که نیازی به توزیع جغرافیایی نیست. در عوض، مناطق در دسترس و مشترک را برای گروه بندی (cluster) کردن در نظر بگیرید.  
* موقعیت هایی که یک پلتفرم قدیمی نیاز به مقاوم سازی و بهبود دارد. این الگو فقط برای توسعه ابری کار می کند و به روز رسانی آن دشوار است.  
* معماری‌ها و الزامات ساده، که در آن افزونگی جغرافیایی و توزیع جغرافیایی مورد نیاز یا سودمند نیست.
## مثال

* مورد Windows Active Directory یک نوع اولیه از این الگو را پیاده سازی می کند.  Multi-primary replication به این معنی است که همه به‌روزرسانی‌ها و درخواست‌ها در تئوری می‌توانند از تمام گره‌های قابل سرویس‌دهی ارائه شوند، اما وظیفه Flexible Single Master Operation (FSMO) به این معنی است که همه Geodeها برابر نیستند.  
* ‏[geode pattern accelerator](https://github.com/mspnp/geode-pattern-accelerator) در GitHub این الگوی طراحی را در عمل به نمایش می گذارد و برای کمک به توسعه دهندگان طراحی شده است که آن را با APIهای دنیای واقعی پیاده سازی کنند.  
*  [QnA sample application](https://github.com/xstof/qnademo) در GitHub این الگوی طراحی را در عمل به نمایش می گذارد.  
 