اطلاعات configuration برنامه را از deployment package  به یک مکان متمرکز منتقل کنید. این می‌تواند فرصت‌هایی را برای مدیریت و کنترل آسان‌تر داده‌های پیکربندی و برای اشتراک‌گذاری داده‌های پیکربندی در بین برنامه‌ها و instance‌های برنامه فراهم کند.


## Context and problem


اکثر محیط های زمان اجرا برنامه شامل اطلاعات پیکربندی است که در فایل های مستقر شده با برنامه نگهداری می شود. در برخی موارد، امکان ویرایش این فایل‌ها برای تغییر رفتار برنامه پس از استقرار(deployed) آن وجود دارد. با این حال، تغییرات در پیکربندی نیاز به استقرار مجدد برنامه (redeployed) دارد، که اغلب منجر به خرابی غیرقابل قبول و سایر هزینه های اداری (administrative overhead) می شود.

فایل‌های Local configuration نیز configuration را به یک برنامه محدود می‌کنند، اما گاهی اوقات اشتراک‌گذاری تنظیمات پیکربندی در چندین برنامه مفید است. به عنوان مثال می‌توان به رشته‌های اتصال پایگاه داده، اطلاعات موضوع رابط کاربری، یا آدرس‌های اینترنتی صف‌ها و فضای ذخیره‌سازی مورد استفاده توسط مجموعه‌ای از برنامه‌های کاربردی مرتبط اشاره کرد.

مدیریت تغییرات در local configurations در چندین نمونه در حال اجرا برنامه، به‌ویژه در سناریوی میزبانی ابری(cloud-hosted)، چالش برانگیز است. این می تواند منجر به مواردی شود که از configuration settings مختلف در حین اجرای به روزرسانی استفاده می کنند.

علاوه بر این، به‌روزرسانی برنامه‌ها و componentها ممکن است به تغییراتی در طرح‌واره‌های پیکربندی(configuration schemas) نیاز داشته باشد. بسیاری از سیستم های پیکربندی از نسخه های مختلف اطلاعات پیکربندی پشتیبانی نمی کنند.

## Solution

اطلاعات configuration را در external storage ذخیره کنید و رابطی(interface) ارائه دهید که می تواند برای خواندن سریع و کارآمد تنظیمات پیکربندی و به روز رسانی آن استفاده شود. حالت external store بستگی به محیط میزبانی(hosting) و زمان اجرا برنامه دارد. در یک سناریوی میزبانی ابری، معمولاً یک سرویس  cloud-based storage یا سرویس dedicated configuration است، اما می تواند یک پایگاه داده میزبانی شده یا سایر سیستم های سفارشی باشد.

همینطور backing store که برای  configuration information انتخاب می‌کنید باید رابطی داشته باشد که دسترسی سازگار و آسان برای استفاده را فراهم کند. باید اطلاعات را در قالبی درست تایپ شده و ساختار یافته نشان دهد. همچنین ممکن است پیاده‌سازی نیاز به مجوز دسترسی کاربران به منظور محافظت از داده‌های پیکربندی داشته باشد، و به اندازه کافی انعطاف‌پذیر باشد تا امکان ذخیره‌سازی نسخه‌های متعدد پیکربندی (مانند توسعه، مرحله‌بندی، یا تولید، از جمله نسخه‌های انتشار چندگانه هر یک) را فراهم کند.




> بسیاری از built-in configuration systems هنگام راه‌اندازی برنامه، داده‌ها را می‌خوانند و داده‌ها را در حافظه cache می‌کنند تا دسترسی سریع را فراهم کنند و تأثیر آن بر عملکرد برنامه به حداقل برسد. بسته به نوع ذخیره پشتیبان (backing store) مورد استفاده و latency این ذخیره ساز، ممکن است پیاده سازی caching mechanism در حافظه به صورت external configuration مفید باشد. برای اطلاعات بیشتر، [Caching Guidance](https://learn.microsoft.com/en-us/previous-versions/msp-n-p/dn589802(v=pandp.10)) را ببینید. شکل یک نمای کلی از External Configuration Store pattern با حافظه  optional local cache را نشان می دهد




![[Pasted image 20231015223850.png]]
شکل 1

###  Issues and considerations

هنگام تصمیم گیری در مورد نحوه اجرای این الگو به نکات زیر توجه کنید:

یک فروشگاه پشتیبان ( backing store ) را انتخاب کنید که performance قابل قبول،  high availability، استحکام (robustness) بالا را ارائه می دهد و می تواند به عنوان بخشی از فرآیند maintenance و administration برنامه از آن به صورت دقیق backup تهیه کند. در یک برنامه cloud-hosted، استفاده از مکانیزم ذخیره سازی ابری یا سرویس پلتفرم پیکربندی اختصاصی (dedicated configuration) معمولاً انتخاب خوبی برای برآورده کردن این الزامات است.

باید schema backing store را طوری طراحی کنید تا از امکان انعطاف پذیری (flexibility) در انواع اطلاعاتی را که می تواند نگه دارد را داشته باشد. همینطور اطمینان کامل حاصل کنید  تمام الزامات پیکربندی مانند typed data ها ، مجموعه‌ای از تنظیمات، نسخه‌های چندگانه تنظیمات و هر ویژگی دیگری را که برنامه‌هایی که از آن استفاده می‌کنند و به آن نیاز دارد را فراهم می‌کند. schema باید به راحتی قابلیت توسعه  برای پشتیبانی از تنظیمات اضافی با تغییر نیازمندی ها را داشته باشد.

قابلیت‌های فیزیکی  backing store، نحوه ارتباط آن با روش‌های ذخیره سازی configuration information و تأثیرات آن بر performance سیستم  را در نظر بگیرید. به عنوان مثال، ذخیره یک سند XML حاوی اطلاعات پیکربندی به رابط پیکربندی یا برنامه نیاز دارد تا سند را برای خواندن تنظیمات جداگانه تجزیه کند. این به‌روزرسانی تنظیمات را پیچیده‌تر می‌کند، اگرچه ذخیره تنظیمات می‌تواند به جبران عملکرد خواندن کندتر کمک کند.

در نظر بگیرید که چگونه  configuration interface  اجازه کنترل scope و ارث‌بری(inheritance) بر تنظیمات پیکربندی را می دهد. به عنوان مثال، ممکن است نیاز باشد که تنظیمات پیکربندی در سطح سازمان، برنامه و دستگاه انجام شود. ممکن است نیاز باشد که از تفویض(delegation) کنترل دسترسی به حوزه‌های مختلف پشتیبانی کند و از لغو تنظیمات به applications جلوگیری کند یا اجازه استفاده از آن را دهد.

~~need to review~~
اطمینان حاصل کنید که رابط پیکربندی می‌تواند داده‌های پیکربندی را در قالب‌های مورد نیاز مانند مقادیر تایپ‌شده، مجموعه‌ها، جفت‌های کلید/مقدار یا کیسه‌های دارایی نمایش دهد.

در نظر بگیرید که وقتی تنظیمات حاوی خطا هستند یا در فروشگاه پشتیبان وجود ندارند، رابط فروشگاه پیکربندی چگونه رفتار خواهد کرد. ممکن است مناسب باشد که تنظیمات پیش فرض و خطاهای گزارش را برگردانید. همچنین جنبه‌هایی مانند حساسیت به حروف کوچک و بزرگ کلیدهای تنظیمات پیکربندی یا نام‌ها، ذخیره‌سازی و مدیریت داده‌های باینری، و روش‌هایی که مقادیر پوچ یا خالی را مدیریت می‌کنند، در نظر بگیرید.

نحوه محافظت از داده های پیکربندی را در نظر بگیرید تا فقط به کاربران و برنامه های کاربردی مناسب دسترسی داشته باشید. این احتمالاً یکی از ویژگی‌های رابط فروشگاه پیکربندی است، اما همچنین لازم است اطمینان حاصل شود که داده‌های موجود در فروشگاه پشتیبان نمی‌توانند مستقیماً بدون مجوز مناسب دسترسی داشته باشند. از جداسازی دقیق بین مجوزهای مورد نیاز برای خواندن و نوشتن داده های پیکربندی اطمینان حاصل کنید. همچنین در نظر بگیرید که آیا باید برخی یا همه تنظیمات پیکربندی را رمزگذاری کنید و چگونه این کار در رابط فروشگاه پیکربندی پیاده سازی می شود.

پیکربندی‌های ذخیره‌شده مرکزی، که رفتار برنامه را در طول زمان اجرا تغییر می‌دهند، بسیار مهم هستند و باید با استفاده از مکانیسم‌هایی مانند استقرار کد برنامه، مستقر، به‌روزرسانی و مدیریت شوند. به عنوان مثال، تغییراتی که می‌توانند بیش از یک برنامه کاربردی را تحت تأثیر قرار دهند، باید با استفاده از روش استقرار آزمایشی کامل و مرحله‌ای انجام شوند تا اطمینان حاصل شود که تغییر برای همه برنامه‌هایی که از این پیکربندی استفاده می‌کنند مناسب است. اگر یک مدیر تنظیمی را برای به‌روزرسانی یک برنامه ویرایش کند، می‌تواند بر سایر برنامه‌هایی که از همان تنظیمات استفاده می‌کنند تأثیر منفی بگذارد.

اگر برنامه ای اطلاعات پیکربندی را در حافظه پنهان ذخیره می کند، در صورت تغییر پیکربندی باید به برنامه هشدار داده شود. ممکن است بتوان یک خط‌مشی انقضا را روی داده‌های پیکربندی حافظه پنهان پیاده‌سازی کرد تا این اطلاعات به‌طور خودکار به‌صورت دوره‌ای بازخوانی شوند و هر گونه تغییر برداشته شود (و بر اساس آن عمل شود).

در حالی که کش کردن داده‌های پیکربندی می‌تواند به رفع مشکلات اتصال گذرا با ذخیره‌سازی پیکربندی خارجی در زمان اجرای برنامه کمک کند، این معمولاً مشکل را حل نمی‌کند اگر ذخیره خارجی در هنگام شروع برنامه برای اولین بار شروع به کار کند. اگر برنامه شما نمی تواند مقادیر زنده را هنگام شروع بازیابی کند، مطمئن شوید که خط لوله استقرار برنامه شما می تواند آخرین مجموعه شناخته شده از مقادیر پیکربندی را در یک فایل پیکربندی به عنوان یک بازگشت ارائه کند.

### When to use this pattern

این الگو برای موارد زیر مفید است:

تنظیمات پیکربندی که بین چندین برنامه و نمونه برنامه به اشتراک گذاشته شده است، یا در جایی که یک پیکربندی استاندارد باید در چندین برنامه و نمونه برنامه اعمال شود.

* یک سیستم پیکربندی استاندارد که از همه تنظیمات پیکربندی مورد نیاز، مانند ذخیره تصاویر یا انواع داده های پیچیده، پشتیبانی نمی کند.

* به عنوان یک فروشگاه مکمل برای برخی از تنظیمات برنامه‌ها، شاید به برنامه‌ها اجازه می‌دهد تا برخی یا همه تنظیمات ذخیره‌شده در مرکز را لغو کنند.

* به عنوان راهی برای ساده‌سازی مدیریت چندین برنامه، و به صورت اختیاری برای نظارت بر استفاده از تنظیمات پیکربندی با ثبت برخی یا همه انواع دسترسی به فروشگاه پیکربندی.

### Custom backing store example


در یک برنامه میزبانی شده Microsoft Azure، یک انتخاب ممکن برای ذخیره اطلاعات پیکربندی به صورت خارجی، استفاده از Azure Storage است. این انعطاف‌پذیر است، عملکرد بالایی ارائه می‌دهد و سه بار با failover خودکار تکرار می‌شود تا در دسترس بودن بالا ارائه شود. ذخیره سازی Azure Table یک ذخیره کلید/مقدار با قابلیت استفاده از طرحواره انعطاف پذیر برای مقادیر فراهم می کند. ذخیره سازی Azure Blob یک فروشگاه سلسله مراتبی و مبتنی بر کانتینر را فراهم می کند که می تواند هر نوع داده ای را در حباب هایی با نام جداگانه نگهداری کند.

هنگام پیاده‌سازی این الگو، شما مسئول حذف فضای ذخیره‌سازی Azure Blob و نمایش تنظیمات خود در برنامه‌هایتان هستید، از جمله بررسی به‌روزرسانی‌ها در زمان اجرا و رسیدگی به نحوه پاسخگویی به آن‌ها.

مثال زیر نشان می‌دهد که چگونه می‌توان یک ذخیره‌سازی پیکربندی ساده را روی ذخیره‌سازی Blob برای ذخیره و افشای اطلاعات پیکربندی پیش‌بینی کرد. یک کلاس BlobSettingsStore می تواند ذخیره سازی Blob را برای نگهداری اطلاعات پیکربندی انتزاعی کند و یک رابط ساده ISettingsStore را پیاده سازی کند.

public interface ISettingsStore

```csharp
public interface ISettingsStore
{
    Task<ETag> GetVersionAsync();
    Task<Dictionary<string, string>> FindAllAsync();
}
```



این رابط روش‌هایی را برای بازیابی تنظیمات پیکربندی موجود در فروشگاه پیکربندی تعریف می‌کند و شامل یک شماره نسخه است که می‌تواند برای تشخیص اینکه آیا تنظیمات پیکربندی اخیراً اصلاح شده است یا خیر. یک کلاس BlobSettingsStore می تواند از ویژگی ETag blob برای پیاده سازی نسخه سازی استفاده کند. ویژگی ETag هر بار که یک لکه نوشته می شود به طور خودکار به روز می شود.

```
با طراحی، این تصویر ساده تمام تنظیمات پیکربندی را به‌عنوان مقادیر رشته‌ای به جای مقادیر تایپ شده نشان می‌دهد.
```

سپس یک کلاس ExternalConfigurationManager می تواند پوششی در اطراف یک نمونه BlobSettingsStore ارائه دهد. یک برنامه می تواند از این کلاس برای بازیابی اطلاعات پیکربندی استفاده کند. این کلاس ممکن است از چیزی مانند Microsoft Reactive Extensions استفاده کند تا تغییرات ایجاد شده در پیکربندی را در حین اجرای سیستم منتشر کند. همچنین مسئول پیاده‌سازی الگوی Cache-Aside برای تنظیماتی است که انعطاف‌پذیری و عملکرد بیشتری را ارائه می‌کند.

استفاده ممکن است چیزی شبیه به زیر باشد.


```csharp
static void Main(string[] args)
{
    // Start monitoring configuration changes.
    ExternalConfiguration.Instance.StartMonitor();

    // Get a setting.
    var setting = ExternalConfiguration.Instance.GetAppSetting("someSettingKey");
    …
}

```



## Using Azure App Configuration


در حالی که ایجاد یک فروشگاه پیکربندی سفارشی ممکن است در برخی شرایط ضروری باشد، بسیاری از برنامه‌ها می‌توانند در عوض از پیکربندی برنامه Azure استفاده کنند. پیکربندی برنامه Azure از جفت‌های کلید-مقدار پشتیبانی می‌کند که می‌توانند فضای نامی داشته باشند. کلیدها تایپ می شوند و به صورت جداگانه ویرایش می شوند. Azure App Configuration همچنین از عکس‌های لحظه‌ای پیکربندی پشتیبانی می‌کند تا بتوانید به راحتی مقادیر پیکربندی قبلی را بررسی کنید یا حتی به آن برگردید. مقادیر پیکربندی را می توان به گونه ای صادر کرد که در صورت عدم دسترسی به سرویس هنگام شروع برنامه، یک کپی از پیکربندی می تواند با برنامه شما ارسال شود.


### Client libraries

بسیاری از این ویژگی‌ها از طریق کتابخانه‌های سرویس گیرنده که با زمان اجرای برنامه یکپارچه می‌شوند، برای تسهیل واکشی و ذخیره مقادیر، مقادیر تازه‌سازی در هنگام تغییر، و حتی مدیریت قطعی‌های گذرا در سرویس پیکربندی برنامه، ادغام می‌شوند.

|Runtime|Client Library|Notes|Quickstart|
|---|---|---|---|
|.NET|[Microsoft.Extensions.Configuration.AzureAppConfiguration](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureAppConfiguration/)|Provider for `Microsoft.Extensions.Configuration`|[Quickstart](https://learn.microsoft.com/en-us/azure/azure-app-configuration/quickstart-aspnet-core-app)|
|ASP.NET|[Microsoft.Azure.AppConfiguration.AspNetCore](https://www.nuget.org/packages/Microsoft.Azure.AppConfiguration.AspNetCore)|Provider for `Microsoft.Extensions.Configuration`|[Quickstart](https://learn.microsoft.com/en-us/azure/azure-app-configuration/quickstart-dotnet-core-app)|
|Azure Functions in .NET|[Microsoft.Extensions.Configuration.AzureAppConfiguration](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureAppConfiguration/)|Used with Azure Function extensions to support configuration in _Startup.cs_|[Quickstart](https://learn.microsoft.com/en-us/azure/azure-app-configuration/quickstart-azure-functions-csharp?tabs=in-process)|
|.NET Framework|[Microsoft.Configuration.ConfigurationBuilders.AzureAppConfiguration](https://www.nuget.org/packages/Microsoft.Configuration.ConfigurationBuilders.AzureAppConfiguration)|Configuration builder for `System.Configuration`|[Quickstart](https://learn.microsoft.com/en-us/azure/azure-app-configuration/quickstart-dotnet-app)|
|Java Spring|[com.azure.spring > azure-spring-cloud-appconfiguration-config](https://mvnrepository.com/artifact/com.azure.spring/azure-spring-cloud-appconfiguration-config)|Supports Spring Framework access via `ConfigurationProperties`|[Quickstart](https://learn.microsoft.com/en-us/azure/azure-app-configuration/quickstart-java-spring-app)|
|Python|[azure.appconfiguration](https://pypi.org/project/azure-appconfiguration/)|Provides an `AzureAppConfigurationClient`|[Quickstart](https://learn.microsoft.com/en-us/azure/azure-app-configuration/quickstart-python)|
|JavaScript/Node.js|[@azure/app-configuration](https://www.npmjs.com/package/@azure/app-configuration)|Provides an `AppConfigurationClient`|[Quickstart](https://learn.microsoft.com/en-us/azure/azure-app-configuration/quickstart-javascript)|

علاوه بر کتابخانه‌های سرویس گیرنده، Azure App Configuration Sync GitHub Action و Azure App Configuration Pull & Azure App Configuration Push Azure DevOps نیز برای ادغام مراحل پیکربندی در فرآیند ساخت شما وجود دارد.
