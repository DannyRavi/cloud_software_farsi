مصرف منابع مورد استفاده توسط یک نمونه از یک برنامه کاربردی، یک مستاجر فردی یا یک سرویس کامل را کنترل کنید. این می تواند به سیستم اجازه دهد تا به عملکرد خود ادامه دهد و توافقات سطح خدمات را برآورده کند، حتی زمانی که افزایش تقاضا بار شدیدی را بر منابع وارد می کند.

## Context and problem

بار روی یک برنامه ابری معمولاً در طول زمان بر اساس تعداد کاربران فعال یا نوع فعالیت هایی که انجام می دهند متفاوت است. به عنوان مثال، احتمالاً کاربران بیشتری در طول ساعات کاری فعال هستند، یا ممکن است سیستم در پایان هر ماه نیاز به انجام تجزیه و تحلیل های محاسباتی گران قیمت داشته باشد. همچنین ممکن است انفجارهای ناگهانی و غیرمنتظره در فعالیت ها وجود داشته باشد. اگر نیازهای پردازشی سیستم از ظرفیت منابع موجود بیشتر شود، از عملکرد ضعیف رنج می‌برد و حتی ممکن است از کار بیفتد. اگر سیستم باید سطح سرویس مورد توافق را برآورده کند، چنین شکستی می تواند غیرقابل قبول باشد.

بسته به اهداف تجاری برنامه، استراتژی‌های زیادی برای مدیریت بارهای مختلف در فضای ابری وجود دارد. یک استراتژی استفاده از مقیاس خودکار برای تطبیق منابع ارائه شده با نیازهای کاربر در هر زمان معین است. این پتانسیل را دارد که به طور مداوم تقاضای کاربر را برآورده کند، در حالی که هزینه های جاری را بهینه می کند. با این حال، در حالی که مقیاس خودکار می‌تواند باعث تامین منابع اضافی شود، این تامین فوری نیست. اگر تقاضا به سرعت رشد کند، ممکن است یک پنجره زمانی وجود داشته باشد که در آن کسری منابع وجود داشته باشد.
## Solution

این سیستم می‌تواند چندین استراتژی throttling را اجرا کند، از جمله:

* رد درخواست‌های یک کاربر که قبلاً بیش از n بار در ثانیه در یک بازه زمانی معین به APIهای سیستم دسترسی داشته است. این امر مستلزم آن است که سیستم میزان استفاده از منابع را برای هر مستأجر یا کاربری که یک برنامه را اجرا می کند اندازه گیری کند. برای اطلاعات بیشتر، راهنمای سنجش خدمات را ببینید.

* غیرفعال کردن یا کاهش عملکرد خدمات غیرضروری انتخاب شده به طوری که خدمات ضروری می توانند بدون مانع با منابع کافی اجرا شوند. به عنوان مثال، اگر برنامه در حال پخش خروجی ویدیو باشد، می تواند به وضوح پایین تری تغییر کند.

* استفاده از تسطیح بار برای هموارسازی حجم فعالیت (این رویکرد با جزئیات بیشتری توسط الگوی تراز بار مبتنی بر صف پوشش داده شده است). در یک محیط چند مستاجر، این رویکرد عملکرد هر مستاجر را کاهش می دهد. اگر سیستم باید ترکیبی از مستاجران با SLA های مختلف را پشتیبانی کند، کار برای مستاجران با ارزش ممکن است بلافاصله انجام شود. درخواست‌های مستاجران دیگر را می‌توان متوقف کرد، و زمانی که عقب ماندگی کاهش یافت، رسیدگی شد. الگوی صف اولویت می تواند برای کمک به پیاده سازی این رویکرد استفاده شود، همانطور که می تواند نقاط پایانی مختلف را برای سطوح/اولویت های خدمات مختلف نشان دهد.

* به تعویق انداختن عملیاتی که از طرف برنامه های کاربردی یا مستاجران با اولویت پایین تر انجام می شود. این عملیات را می توان به حالت تعلیق درآورد یا محدود کرد، به استثنای یک استثنا برای اطلاع مستاجر که سیستم مشغول است و این عملیات باید بعداً دوباره امتحان شود.

* هنگام ادغام با برخی از سرویس‌های شخص ثالث که ممکن است در دسترس نباشند یا با خطا مواجه شوند، باید مراقب باشید. تعداد درخواست‌های همزمان در حال پردازش را کاهش دهید تا لاگ‌ها بی جهت با خطا پر نشوند. همچنین از هزینه‌های مرتبط با پردازش مجدد درخواست‌هایی که به دلیل آن سرویس شخص ثالث با شکست مواجه می‌شوند، اجتناب می‌کنید. سپس، هنگامی که درخواست‌ها با موفقیت پردازش شدند، به پردازش درخواست‌های معمولی بازگردید. یکی از کتابخانه هایی که این قابلیت را پیاده سازی می کند NServiceBus است.

شکل یک نمودار منطقه ای برای استفاده از منابع (ترکیبی از حافظه، CPU، پهنای باند و عوامل دیگر) را در برابر زمان برای برنامه هایی که از سه ویژگی استفاده می کنند نشان می دهد. یک ویژگی ناحیه ای از عملکرد است، مانند مؤلفه ای که مجموعه خاصی از وظایف را انجام می دهد، قطعه کدی که محاسبات پیچیده ای را انجام می دهد، یا عنصری که سرویسی مانند کش در حافظه را ارائه می دهد. این ویژگی ها دارای برچسب های A، B و C هستند.

![[Pasted image 20231128230244.png]]


> ناحیه بلافاصله زیر خط یک ویژگی، منابعی را نشان می دهد که برنامه ها هنگام فراخوانی این ویژگی از آنها استفاده می کنند. به عنوان مثال، ناحیه زیر خط برای ویژگی A، منابع استفاده شده توسط برنامه‌هایی را نشان می‌دهد که از ویژگی A استفاده می‌کنند، و ناحیه بین خطوط برای ویژگی A و ویژگی B، منابع استفاده شده توسط برنامه‌های کاربردی با استفاده از ویژگی B را نشان می‌دهد. تجمیع مناطق برای هر ویژگی، کل استفاده از منابع سیستم را نشان می دهد.


شکل قبلی اثرات عملیات به تعویق انداختن را نشان می دهد. درست قبل از زمان T1، کل منابع تخصیص داده شده به همه برنامه های کاربردی با استفاده از این ویژگی ها به یک آستانه (محدودیت استفاده از منابع) می رسد. در این مرحله، برنامه های کاربردی در خطر فرسودگی منابع موجود هستند. در این سیستم، ویژگی B نسبت به ویژگی A یا ویژگی C از اهمیت کمتری برخوردار است، بنابراین به طور موقت غیرفعال می شود و منابعی که استفاده می کرد آزاد می شوند. بین زمان‌های T1 و T2، برنامه‌هایی که از ویژگی A و ویژگی C استفاده می‌کنند به طور عادی به کار خود ادامه می‌دهند. در نهایت، استفاده از منابع این دو ویژگی به حدی کاهش می یابد که در زمان T2، ظرفیت کافی برای فعال کردن مجدد ویژگی B وجود دارد.

رویکردهای مقیاس خودکار و throttling همچنین می توانند برای کمک به پاسخگو بودن برنامه ها و در SLA ها ترکیب شوند. اگر انتظار می‌رود تقاضا همچنان بالا بماند، در حالی که سیستم کاهش می‌یابد، throttling یک راه‌حل موقت ارائه می‌کند. در این مرحله، عملکرد کامل سیستم قابل بازیابی است.

شکل بعدی یک نمودار منطقه ای از استفاده کلی از منابع توسط همه برنامه های کاربردی در حال اجرا در یک سیستم در برابر زمان را نشان می دهد و نشان می دهد که چگونه throttling را می توان با مقیاس خودکار ترکیب کرد.

![[Pasted image 20231128230606.png]]

در زمان T1، آستانه تعیین حد نرم استفاده از منابع رسیده است. در این مرحله، سیستم می تواند شروع به کوچک شدن کند. با این حال، اگر منابع جدید به سرعت در دسترس قرار نگیرند، ممکن است منابع موجود تمام شده و سیستم از کار بیفتد. برای جلوگیری از این اتفاق، سیستم به طور موقت، همانطور که قبلاً توضیح داده شد، خاموش می شود. هنگامی که مقیاس خودکار کامل شد و منابع اضافی در دسترس هستند، می توان دریچه گاز را آرام کرد.

## Issues and considerations

هنگام تصمیم گیری در مورد نحوه اجرای این الگو باید نکات زیر را در نظر بگیرید:

* مهار کردن یک برنامه کاربردی و استراتژی مورد استفاده، یک تصمیم معماری است که کل طراحی یک سیستم را تحت تاثیر قرار می دهد. Throttling باید در مراحل اولیه طراحی برنامه در نظر گرفته شود زیرا اضافه کردن آن پس از پیاده سازی یک سیستم آسان نیست.

* دریچه گاز باید به سرعت انجام شود. سیستم باید توانایی تشخیص افزایش فعالیت را داشته باشد و متناسب با آن واکنش نشان دهد. همچنین سیستم باید بتواند پس از کاهش بار به سرعت به حالت اولیه خود بازگردد. این مستلزم آن است که داده های عملکرد مناسب به طور مداوم جمع آوری و نظارت شود.

* اگر سرویسی باید درخواست کاربر را به طور موقت رد کند، باید یک کد خطای خاص مانند 429 ("خیلی از درخواست ها") و 503 ("سرور بیش از حد مشغول") را برگرداند تا برنامه مشتری بتواند دلیل امتناع از سرویس را بفهمد. یک درخواست به دلیل دریچه گاز است.

* HTTP 429 نشان می دهد که برنامه تماس گیرنده درخواست های زیادی را در یک پنجره زمانی ارسال کرده و از حد از پیش تعیین شده فراتر رفته است.

* HTTP 503 نشان می دهد که سرویس برای رسیدگی به درخواست آماده نیست. دلیل رایج این است که سرویس بارگیری موقتی را بیش از حد انتظار تجربه می کند.

برنامه مشتری می تواند قبل از امتحان مجدد درخواست، مدتی صبر کند. یک هدر Retry-After HTTP باید گنجانده شود تا از مشتری در انتخاب استراتژی امتحان مجدد پشتیبانی کند.

* در حالی که یک سیستم به صورت خودکار مقیاس می شود، می توان از گلوگاه به عنوان یک معیار موقت استفاده کرد. در برخی موارد، اگر یک انفجار ناگهانی در فعالیت‌ها ناگهانی است و انتظار نمی‌رود عمر طولانی داشته باشد، به‌جای مقیاس‌بندی، بهتر است به سادگی دریچه گاز را فشار دهید، زیرا جرم‌گیری می‌تواند به میزان قابل توجهی به هزینه‌های جاری اضافه کند.

* اگر در زمانی که سیستم به صورت خودکار مقیاس می‌شود، از throttling به عنوان یک معیار موقت استفاده شود، و اگر تقاضای منابع خیلی سریع افزایش یابد، سیستم ممکن است نتواند به کار خود ادامه دهد - حتی زمانی که در حالت دریچه گاز کار می‌کند. اگر این مورد قابل قبول نیست، ذخیره ظرفیت بیشتری را حفظ کرده و مقیاس خودکار تهاجمی تر را پیکربندی کنید.

* عادی سازی هزینه های منابع برای عملیات های مختلف، زیرا آنها معمولاً هزینه های اجرایی برابری ندارند. برای مثال، محدودیت‌های throttling ممکن است برای عملیات خواندن کمتر و برای عملیات نوشتن بیشتر باشد. در نظر نگرفتن هزینه یک عملیات می تواند منجر به تخلیه ظرفیت و افشای یک بردار حمله بالقوه شود.

* تغییر پیکربندی دینامیکی رفتار throttling در زمان اجرا مطلوب است. اگر سیستمی با بار غیرعادی روبرو شود که پیکربندی اعمال شده قادر به تحمل آن نیست، ممکن است برای تثبیت سیستم و همگام شدن با ترافیک فعلی، محدودیت‌های دریچه گاز باید افزایش یا کاهش یابد. استقرار گران، پرخطر و کند در این مرحله مطلوب نیست. با استفاده از External Configuration Store الگوی throttling پیکربندی خارجی است و می توان آن را تغییر داد و بدون استقرار اعمال کرد.
## When to use this pattern

از این الگو استفاده کنید:

* برای اطمینان از اینکه یک سیستم به توافقات سطح خدمات ادامه می دهد.

* برای جلوگیری از انحصار یک مستاجر منابع ارائه شده توسط یک برنامه.

* برای مدیریت انفجار در فعالیت.

* برای کمک به بهینه سازی هزینه یک سیستم با محدود کردن حداکثر سطوح منابع مورد نیاز برای حفظ عملکرد آن.


## Example


شکل نهایی نشان می دهد که چگونه دریچه گاز را می توان در یک سیستم چند مستاجر پیاده سازی کرد. کاربران هر یک از سازمان‌های مستاجر به یک برنامه میزبانی ابری دسترسی پیدا می‌کنند که در آنجا نظرسنجی‌ها را تکمیل و ارسال می‌کنند. این برنامه حاوی ابزار دقیقی است که بر میزان ارسال درخواست‌های این کاربران به برنامه نظارت می‌کند.

به منظور جلوگیری از تأثیرگذاری کاربران از یک مستاجر بر پاسخگویی و در دسترس بودن برنامه برای همه کاربران دیگر، محدودیتی برای تعداد درخواست‌هایی در هر ثانیه اعمال می‌شود که کاربران از هر یک مستاجر می‌توانند ارسال کنند. برنامه درخواست هایی را که از این حد فراتر می روند مسدود می کند.


![[Pasted image 20231128230936.png]]


## Next steps

راهنمایی زیر ممکن است هنگام اجرای این الگو نیز مرتبط باشد:

راهنمای ابزار دقیق و تله متری. throttling بستگی به جمع آوری اطلاعات در مورد میزان استفاده از یک سرویس دارد. نحوه تولید و ضبط اطلاعات نظارت سفارشی را شرح می دهد.
راهنمای سنجش خدمات. نحوه اندازه‌گیری میزان استفاده از خدمات را به منظور درک نحوه استفاده از آنها شرح می‌دهد. این اطلاعات می تواند در تعیین نحوه دریچه گاز یک سرویس مفید باشد.
راهنمای مقیاس خودکار. تروتتلینگ می‌تواند به‌عنوان یک معیار موقت در حین مقیاس‌پذیری خودکار سیستم یا رفع نیاز به یک سیستم برای مقیاس خودکار استفاده شود. حاوی اطلاعاتی در مورد استراتژی های مقیاس خودکار است.

راهنمایی زیر ممکن است هنگام اجرای این الگو نیز مرتبط باشد:

راهنمای ابزار دقیق و تله متری. throttling بستگی به جمع آوری اطلاعات در مورد میزان استفاده از یک سرویس دارد. نحوه تولید و ضبط اطلاعات نظارت سفارشی را شرح می دهد.
راهنمای سنجش خدمات. نحوه اندازه‌گیری میزان استفاده از خدمات را به منظور درک نحوه استفاده از آنها شرح می‌دهد. این اطلاعات می تواند در تعیین نحوه دریچه گاز یک سرویس مفید باشد.
راهنمای مقیاس خودکار. تروتتلینگ می‌تواند به‌عنوان یک معیار موقت در حین مقیاس‌پذیری خودکار سیستم یا رفع نیاز به یک سیستم برای مقیاس خودکار استفاده شود. حاوی اطلاعاتی در مورد استراتژی های مقیاس خودکار است.

## Related resources

الگوهای زیر نیز ممکن است هنگام اجرای این الگو مرتبط باشند:

الگوی بارگذاری بر اساس صف. تراز کردن بار مبتنی بر صف مکانیزمی است که معمولاً برای اجرای دریچه گاز استفاده می شود. یک صف می تواند به عنوان یک بافر عمل کند که به یکنواخت کردن نرخ ارسال درخواست های ارسال شده توسط یک برنامه به یک سرویس کمک می کند.
الگوی صف اولویت. یک سیستم می‌تواند از صف اولویت‌بندی به عنوان بخشی از استراتژی throttling خود برای حفظ عملکرد برای برنامه‌های کاربردی مهم یا با ارزش بالاتر استفاده کند، در حالی که عملکرد برنامه‌های کمتر مهم را کاهش می‌دهد.
الگوی فروشگاه پیکربندی خارجی. متمرکز کردن و بیرونی کردن سیاست‌های throttling قابلیت تغییر پیکربندی را در زمان اجرا بدون نیاز به جابجایی مجدد فراهم می‌کند. سرویس‌ها می‌توانند مشترک تغییرات پیکربندی شوند، در نتیجه پیکربندی جدید را بلافاصله برای تثبیت سیستم اعمال کنند.