
از صفی استفاده کنید که به عنوان یک بافر بین یک وظیفه و سرویسی که فراخوانی می‌کند عمل می‌کند تا بارهای سنگین متناوب را که می‌توانند باعث از کار افتادن سرویس یا اتمام زمان کار شوند، هموار کند. این می تواند به به حداقل رساندن تأثیر اوج تقاضا بر در دسترس بودن و پاسخگویی هم برای کار و هم برای سرویس کمک کند.

## Context and problem

بسیاری از راه حل ها در ابر شامل اجرای وظایفی است که خدمات را فراخوانی می کنند. در این محیط، اگر سرویسی تحت بارهای سنگین متناوب قرار گیرد، می تواند باعث مشکلات عملکرد یا قابلیت اطمینان شود.  
  
یک سرویس می‌تواند بخشی از همان راه‌حلی باشد که وظایفی که از آن استفاده می‌کنند، یا می‌تواند یک سرویس شخص ثالث باشد که دسترسی به منابع پرکاربرد مانند حافظه پنهان یا سرویس ذخیره‌سازی را فراهم می‌کند. اگر از همان سرویس توسط تعدادی از وظایفی که به طور همزمان اجرا می شوند استفاده شود، پیش بینی حجم درخواست های سرویس در هر زمان ممکن است دشوار باشد.  
  
یک سرویس ممکن است اوج تقاضا را تجربه کند که باعث می شود بیش از حد بارگذاری شود و نتواند به درخواست ها به موقع پاسخ دهد. سیل یک سرویس با تعداد زیادی درخواست همزمان نیز می‌تواند منجر به شکست سرویس شود، در صورتی که نتواند با اختلافاتی که این درخواست‌ها ایجاد می‌کند، رسیدگی کند.

## Solution

راه حل را اصلاح کنید و یک صف بین وظیفه و سرویس معرفی کنید. وظیفه و سرویس به صورت ناهمزمان اجرا می شوند. وظیفه پیامی حاوی داده های مورد نیاز سرویس را به یک صف ارسال می کند. صف به عنوان یک بافر عمل می کند و پیام را تا زمانی که توسط سرویس بازیابی شود ذخیره می کند. این سرویس پیام ها را از صف بازیابی می کند و آنها را پردازش می کند. درخواست‌های تعدادی کار، که می‌توانند با نرخ بسیار متغیر تولید شوند، می‌توانند از طریق همان صف پیام به سرویس ارسال شوند. این شکل استفاده از یک صف برای تراز کردن بار روی یک سرویس را نشان می دهد.

![[Pasted image 20231202000213.png]]

صف وظایف را از سرویس جدا می‌کند و سرویس می‌تواند پیام‌ها را بدون توجه به حجم درخواست‌های وظایف همزمان با سرعت خودش مدیریت کند. علاوه بر این، اگر سرویس در زمانی که پیامی را به صف ارسال می‌کند، در دسترس نباشد، هیچ تاخیری برای انجام کار وجود ندارد.

این الگو دارای مزایای زیر است:

* این می تواند به به حداکثر رساندن در دسترس بودن کمک کند زیرا تأخیرهای ایجاد شده در سرویس ها تأثیر فوری و مستقیمی بر برنامه نخواهد داشت، که می تواند به پست کردن پیام ها در صف ادامه دهد حتی زمانی که سرویس در دسترس نیست یا در حال حاضر پیام ها را پردازش نمی کند.

* می‌تواند به حداکثر کردن مقیاس‌پذیری کمک کند، زیرا هم تعداد صف‌ها و هم تعداد سرویس‌ها می‌توانند برای پاسخگویی به تقاضا متفاوت باشند.

* می‌تواند به کنترل هزینه‌ها کمک کند، زیرا تعداد نمونه‌های سرویس مستقر شده فقط باید برای برآورده کردن بار متوسط به جای بار اوج کافی باشد.

> برخی از سرویس ها زمانی که تقاضا به آستانه ای می رسد که سیستم ممکن است از کار بیفتد، throttling را اجرا می کنند. throttling می تواند عملکرد موجود را کاهش دهد. برای اطمینان از عدم رسیدن به این آستانه، می‌توانید با این سرویس‌ها سطح بار را پیاده‌سازی کنید.

## Issues and considerations

هنگام تصمیم گیری در مورد نحوه اجرای این الگو به نکات زیر توجه کنید:  
  
* پیاده سازی منطق برنامه ای ضروری است که نرخ مدیریت پیام ها توسط سرویس ها را کنترل می کند تا از تسخیر منبع هدف جلوگیری شود. از انتقال افزایش تقاضا به مرحله بعدی سیستم خودداری کنید. سیستم را تحت بار آزمایش کنید تا مطمئن شوید که سطح مورد نیاز را فراهم می‌کند و تعداد صف‌ها و تعداد نمونه‌های سرویسی که پیام‌ها را مدیریت می‌کنند را برای رسیدن به این هدف تنظیم کنید.  
* صف های پیام یک مکانیسم ارتباطی یک طرفه هستند. اگر وظیفه ای انتظار پاسخ از یک سرویس را دارد، ممکن است لازم باشد مکانیزمی را پیاده سازی کرد که سرویس بتواند از آن برای ارسال پاسخ استفاده کند. برای اطلاعات بیشتر، به Primer Asynchronous Messaging مراجعه کنید.  
* اگر مقیاس خودکار را برای سرویس‌هایی که در حال گوش دادن به درخواست‌ها در صف هستند، اعمال می‌کنید، مراقب باشید. این می تواند منجر به افزایش اختلاف برای هر گونه منابعی شود که این سرویس ها به اشتراک می گذارند و اثربخشی استفاده از صف برای تراز کردن بار را کاهش می دهد.  
* بسته به بار سرویس، می‌توانید در موقعیتی قرار بگیرید که در آن به طور موثر همیشه عقب هستید، که در آن سیستم همیشه درخواست‌های بیشتری را نسبت به آنچه که شما پردازش می‌کنید در صف قرار می‌دهد. تنوع ترافیک ورودی به برنامه شما باید در نظر گرفته شود  
* بسته به ماندگاری صف می‌تواند اطلاعات را از دست بدهد. اگر صف شما خراب شد یا اطلاعات را از دست داد (به دلیل محدودیت های سیستم)، این احتمال وجود دارد که تحویل تضمینی نداشته باشید. رفتار صف و محدودیت های سیستم شما باید بر اساس نیازهای راه حل شما در نظر گرفته شود.


## When to use this pattern

این الگو برای هر برنامه ای که از سرویس هایی استفاده می کند که در معرض بارگذاری بیش از حد هستند مفید است.  
  
اگر برنامه انتظار پاسخی از سرویس با حداقل تأخیر داشته باشد، این الگو مفید نیست.


## Example

یک برنامه وب داده ها را در یک فروشگاه داده خارجی می نویسد. اگر تعداد زیادی از نمونه‌های برنامه وب به طور همزمان اجرا شوند، ممکن است فروشگاه داده نتواند به سرعت به درخواست‌ها پاسخ دهد، که باعث می‌شود درخواست‌ها به پایان برسد، کاهش یابد یا در غیر این صورت شکست بخورد. نمودار زیر نشان می‌دهد که یک فروشگاه داده تحت تأثیر تعداد زیادی درخواست همزمان از نمونه‌های یک برنامه کاربردی است.

![[Pasted image 20231202000441.png]]

برای حل این مشکل، می توانید از یک صف برای تراز کردن بار بین نمونه های برنامه و ذخیره داده استفاده کنید. یک برنامه Azure Functions پیام‌ها را از صف می‌خواند و درخواست‌های خواندن/نوشتن را به فروشگاه داده انجام می‌دهد. منطق برنامه کاربردی در برنامه تابع می‌تواند سرعت ارسال درخواست‌ها را به ذخیره‌گاه داده کنترل کند تا از غرق شدن فروشگاه جلوگیری کند. (در غیر این صورت برنامه تابع فقط همان مشکل را در انتهای پشتی ایجاد می کند.)

![[Pasted image 20231202000454.png]]

## Next steps

راهنمایی زیر ممکن است هنگام اجرای این الگو نیز مرتبط باشد:  
  
* آغازگر پیام رسانی ناهمزمان. صف های پیام ذاتا ناهمزمان هستند. اگر از برقراری ارتباط مستقیم با یک سرویس به استفاده از صف پیام تطبیق داده شده باشد، ممکن است نیاز به طراحی مجدد منطق برنامه در یک کار باشد. به طور مشابه، ممکن است لازم باشد یک سرویس برای پذیرش درخواست‌های یک صف پیام مجدداً تنظیم شود. از طرف دیگر، ممکن است بتوان یک سرویس پروکسی را همانطور که در مثال توضیح داد، پیاده سازی کرد.  
  
* از بین سرویس های پیام رسانی Azure یکی را انتخاب کنید. اطلاعاتی در مورد انتخاب مکانیزم پیام رسانی و صف بندی در برنامه های Azure.  
  
* ارتباط ناهمزمان مبتنی بر پیام

## Related resources


* سبک معماری Web-Queue-Worker. وب و کارگر هر دو بی تابعیت هستند. وضعیت جلسه را می توان در یک کش توزیع شده ذخیره کرد. هر کار طولانی مدت توسط کارگر به صورت ناهمزمان انجام می شود. کارگر می‌تواند توسط پیام‌های موجود در صف فعال شود یا بر اساس برنامه‌ای برای پردازش دسته‌ای اجرا شود.  

الگوهای زیر نیز ممکن است هنگام اجرای این الگو مرتبط باشند:  
  
* الگوی مصرف کنندگان رقابتی ممکن است بتوان چندین نمونه از یک سرویس را اجرا کرد، که هر کدام به عنوان یک مصرف کننده پیام از صف سطح بار عمل می کنند. شما می توانید از این روش برای تنظیم نرخ دریافت و ارسال پیام ها به یک سرویس استفاده کنید.  
  
* الگوی دریچه گاز. یک راه ساده برای پیاده‌سازی throttling با یک سرویس، استفاده از سطح‌بندی بار مبتنی بر صف و مسیریابی همه درخواست‌ها به یک سرویس از طریق یک صف پیام است. این سرویس می‌تواند درخواست‌ها را با سرعتی پردازش کند که تضمین کند منابع مورد نیاز سرویس تمام نشده‌اند، و میزان مشاجره‌ای که ممکن است رخ دهد را کاهش دهد.