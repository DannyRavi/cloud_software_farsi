
---

### **ضدالگوی همسایه مزاحم (Noisy Neighbor)**

سیستم‌های چندمستأجری (multitenant) منابع را بین دو یا چند مستأجر به اشتراک می‌گذارند. از آنجا که مستأجران از منابع مشترک یکسانی استفاده می‌کنند، فعالیت یک مستأجر می‌تواند بر استفاده مستأجر دیگر از سیستم تأثیر منفی بگذارد.

#### **زمینه و مشکل**

هنگامی که سرویسی را می‌سازید که چندین مشتری یا مستأجر در آن مشترک هستند، می‌توانید آن را به صورت چندمستأجری طراحی کنید. یکی از مزایای سیستم‌های چندمستأجری این است که منابع می‌توانند تجمیع شده (pooled) و بین مستأجران به اشتراک گذاشته شوند. این اشتراک‌گذاری منابع اغلب منجر به کاهش هزینه‌ها و بهبود کارایی می‌شود. با این حال، اگر یک مستأجر به تنهایی بخش نامتناسبی از منابع موجود در سیستم را مصرف کند، عملکرد کلی سیستم می‌تواند آسیب ببیند. مشکل «همسایه مزاحم» زمانی رخ می‌دهد که عملکرد یک مستأجر به دلیل فعالیت‌های مستأجر دیگر افت می‌کند.

یک سیستم چندمستأجری را با دو مستأجر در نظر بگیرید. الگوهای مصرف مستأجر A و مستأجر B با هم تلاقی دارند. در زمان‌های اوج مصرف، مستأجر A تمام منابع سیستم را مصرف می‌کند، که به این معناست که هر درخواستی که مستأجر B ارسال کند، با شکست مواجه خواهد شد. به عبارت دیگر، تقاضای کل برای منابع، از ظرفیت سیستم بیشتر است:

[نمودار ۱]

---

احتمالاً، مستأجری که درخواستش زودتر می‌رسد، اولویت پیدا می‌کند. در این صورت، مستأجر دیگر ممکن است با مشکل «همسایه مزاحم» مواجه شود. یا اینکه عملکرد هر دو مستأجر ممکن است افت کند.

مشکل «همسایه مزاحم» زمانی نیز رخ می‌دهد که هر مستأجر به تنهایی تنها بخش کوچکی از ظرفیت سیستم را مصرف می‌کند. با این حال، مصرف منابع ترکیبی چندین مستأجر می‌تواند منجر به یک اوج (peak) در مصرف کلی شود:

[نمودار ۲]

---

این سناریو زمانی ممکن است رخ دهد که شما چندین مستأجر با الگوهای مصرف مشابه داشته باشید یا زمانی که ظرفیت کافی برای بار کاری کلی سیستم فراهم نکرده باشید.

#### **راه‌حل**

اشتراک‌گذاری یک منبع واحد ذاتاً با خطر مشکلات «همسایه مزاحم» همراه است که نمی‌توانید به طور کامل از آن جلوگیری کنید. با این حال، اقداماتی وجود دارد که هم کلاینت‌ها و هم ارائه‌دهندگان سرویس می‌توانند برای کاهش احتمال وقوع این مشکل یا کاهش اثرات آن انجام دهند.

##### **اقداماتی که کلاینت‌ها می‌توانند انجام دهند**

*   اطمینان حاصل کنید که اپلیکیشن شما محدودسازی سرویس (throttling) را مدیریت می‌کند تا از ارسال درخواست‌های غیرضروری به سرویس جلوگیری شود. اطمینان حاصل کنید که اپلیکیشن شما از بهترین شیوه‌ها برای تلاش مجدد (retry) برای درخواست‌هایی که با پاسخ شکست گذرا (transient failure) مواجه شده‌اند، پیروی می‌کند.
*   در صورت امکان، ظرفیت رزرو شده (reserved capacity) خریداری کنید. برای مثال، هنگام استفاده از Azure Cosmos DB، توان عملیاتی رزرو شده خریداری کنید.
*   در صورت امکان، به یک سطح سرویس (service tier) با تضمین‌های ایزوله‌سازی (isolation) قوی‌تر مهاجرت کنید. برای مثال، هنگام استفاده از Azure Service Bus، به سطح Premium مهاجرت کنید. هنگام استفاده از Azure Cache for Redis، یک کش در سطح Standard یا Premium تهیه کنید.
*   به یک نمونه تک‌مستأجری (single-tenant) از سرویس مهاجرت کنید. برای مثال، هنگام استفاده از Azure ExpressRoute، برای محیط‌هایی که به عملکرد حساس هستند، مدارهای جداگانه تهیه کنید.

##### **اقداماتی که ارائه‌دهندگان سرویس می‌توانند انجام دهند**
*   مصرف منابع سیستم خود را نظارت کنید. هم مصرف کلی منابع و هم منابعی که هر مستأجر استفاده می‌کند را نظارت کنید. هشدارهایی (alerts) برای شناسایی جهش‌های ناگهانی در مصرف منابع تنظیم کنید. در صورت امکان، اتوماسیونی را پیکربندی کنید که به طور خودکار مشکلات شناخته‌شده را با ارتقای عمودی (scale up) یا افقی (scale out) برطرف کند.
*   حاکمیت منابع (resource governance) را اعمال کنید. اعمال سیاست‌هایی را در نظر بگیرید که از تحت فشار قرار دادن سیستم توسط یک مستأجر و کاهش ظرفیت موجود برای سایر مستأجران جلوگیری کند. این اقدام می‌تواند به شکل اعمال سهمیه (quota) از طریق الگوی Throttling یا الگوی Rate Limiting باشد.
*   زیرساخت بیشتری فراهم کنید. این فرآیند ممکن است شامل ارتقای عمودی با به‌روزرسانی برخی از اجزای راه‌حل شما باشد، یا ممکن است شامل ارتقای افقی با تهیه شارد (shard) اضافی (اگر از الگوی Sharding پیروی می‌کنید) یا استمپ (stamp) اضافی (اگر از الگوی Deployment Stamps پیروی می‌کنید) باشد.
*   به مستأجران این امکان را بدهید که ظرفیت از پیش تخصیص‌یافته یا رزرو شده خریداری کنند. این رویکرد به مستأجران اطمینان بیشتری می‌دهد که راه‌حل شما می‌تواند به طور قابل اعتمادی بارهای کاری آنها را مدیریت کند.
*   مصرف منابع مستأجران را متعادل کنید. برای مثال، می‌توانید یکی از رویکردهای زیر را امتحان کنید:
    *   اگر چندین نمونه از راه‌حل خود را میزبانی می‌کنید، متعادل‌سازی مجدد مستأجران در بین نمونه‌ها یا استمپ‌ها را در نظر بگیرید. برای مثال، مستأجرانی با الگوهای مصرف قابل پیش‌بینی و مکمل را در استمپ‌های مختلف قرار دهید تا اوج مصرف آنها را هموار کنید.
    *   بررسی کنید که آیا فرآیندهای پس‌زمینه یا بارهای کاری سنگین دارید که به زمان حساس نیستند. این بارهای کاری را به صورت ناهمزمان (asynchronously) در زمان‌های کم‌مصرف اجرا کنید تا ظرفیت منابع خود را برای بارهای کاری حساس به زمان حفظ کنید.
    *   بررسی کنید که آیا سرویس‌های پایین‌دستی (downstream) شما کنترل‌هایی برای کاهش مشکلات «همسایه مزاحم» ارائه می‌دهند. برای مثال، هنگام استفاده از Kubernetes، استفاده از pod limits را در نظر بگیرید. هنگام استفاده از Azure Service Fabric، استفاده از قابلیت‌های حاکمیتی داخلی را در نظر بگیرید.
*   عملیاتی را که مستأجران می‌توانند انجام دهند، محدود کنید. برای مثال، مستأجران را از انجام عملیاتی که کوئری‌های بسیار بزرگ پایگاه داده را اجرا می‌کنند، منع کنید (مثلاً با مشخص کردن حداکثر تعداد رکوردهای قابل بازگشت یا محدودیت زمانی برای کوئری‌ها). یا این عملیات‌ها را به صورت ناهمزمان تغییر دهید و آنها را برای اجرا در زمان‌های کم‌مصرف زمان‌بندی کنید. این اقدام خطر انجام اقداماتی توسط مستأجران که ممکن است بر سایر مستأجران تأثیر منفی بگذارد را کاهش می‌دهد.
*   یک سیستم کیفیت خدمات (QoS) ارائه دهید. با اعمال QoS، برخی فرآیندها یا بارهای کاری را نسبت به سایر فرآیندها یا بارهای کاری اولویت‌بندی می‌کنید. با در نظر گرفتن QoS در طراحی و معماری خود، می‌توانید اطمینان حاصل کنید که عملیات با اولویت بالا در زمان فشار بر منابع، در اولویت قرار می‌گیرند.

#### **ملاحظات**
در اکثر موارد، مستأجران به صورت فردی قصد ندارند که عامدانه مشکلات «همسایه مزاحم» ایجاد کنند. مستأجران ممکن است ندانند که بارهای کاری آنها برای سایر مستأجران مشکل ایجاد می‌کند. با این حال، برخی مستأجران ممکن است از آسیب‌پذیری‌های موجود در اجزای مشترک برای حمله به یک سرویس، چه به صورت فردی و چه با انجام یک حمله انکار سرویس توزیع‌شده (DDoS)، سوءاستفاده کنند.

صرف نظر از علت، مهم است که این مشکلات را به عنوان مشکلات حاکمیت منابع در نظر بگیرید و برای کاهش مشکل، سهمیه‌های مصرف، محدودسازی (throttling) و کنترل‌های حاکمیتی را اعمال کنید.

> **نکته**
>
> در مورد هرگونه مکانیزم محدودسازی یا سهمیه مصرف که اعمال می‌کنید، با کلاینت‌ها شفاف باشید. مهم است که آنها درخواست‌های ناموفق را به درستی مدیریت کنند و از وجود محدودیت‌ها غافلگیر نشوند.

#### **چگونه مشکل را شناسایی کنیم؟**
از دیدگاه کلاینت، مشکل «همسایه مزاحم» معمولاً به صورت درخواست‌های ناموفق به سرویس یا درخواست‌هایی که تکمیل آنها زمان زیادی می‌برد، خود را نشان می‌دهد. به طور خاص، اگر یک درخواست یکسان در زمان‌های دیگر موفقیت‌آمیز باشد و به نظر برسد که به صورت تصادفی شکست می‌خورد، ممکن است مشکل «همسایه مزاحم» وجود داشته باشد. اپلیکیشن‌های کلاینت باید تله‌متری را برای ردیابی نرخ موفقیت و عملکرد درخواست‌ها به سرویس‌ها ثبت کنند. همچنین این اپلیکیشن‌ها باید معیارهای عملکرد پایه (baseline) را برای مقاصد مقایسه‌ای ثبت کنند.

برای سرویس‌های مبتنی بر Azure، محدودیت‌ها، سهمیه‌ها و قیود اشتراک و سرویس Azure را بررسی کنید تا محدودیت‌ها و سهمیه‌هایی را که برای هر جزء Azure در راه‌حل شما اعمال می‌شود، درک کنید.

از دیدگاه سرویس، مشکل «همسایه مزاحم» ممکن است به روش‌های زیر ظاهر شود:

*   **جهش‌های ناگهانی در مصرف منابع:** مهم است که مصرف منابع پایه عادی خود را به وضوح درک کرده و نظارت و هشدارهایی برای شناسایی این جهش‌ها تنظیم کنید. تمام منابعی را که ممکن است بر عملکرد یا در دسترس بودن سرویس شما تأثیر بگذارند، در نظر بگیرید. این منابع شامل معیارهایی مانند مصرف CPU و حافظه سرور، ورودی/خروجی دیسک، استفاده از پایگاه داده و ترافیک شبکه است. همچنین باید معیارهای ارائه‌شده توسط سرویس‌های مدیریت‌شده را نظارت کنید، از جمله حجم درخواست و شاخص‌های عملکرد ترکیبی یا انتزاعی مانند واحدهای درخواست (Request Units) در Azure Cosmos DB.

*   **شکست در انجام یک عملیات برای یک مستأجر:** به دنبال شکست‌هایی باشید که زمانی رخ می‌دهند که یک مستأجر سهم زیادی از منابع سیستم را مصرف نمی‌کند. این الگو ممکن است نشان دهد که مستأجر در حال تجربه مشکل «همسایه مزاحم» است. مصرف منابع را بر اساس هر مستأجر ردیابی کنید. برای مثال، هنگام استفاده از Azure Cosmos DB، واحدهای درخواست برای هر درخواست را لاگ کرده و شناسه مستأجر را در تله‌متری بگنجانید تا بتوانید مصرف واحدهای درخواست را برای هر مستأجر تجمیع کنید.

---

##### **مشارکت‌کنندگان**
مایکروسافت این مقاله را نگهداری می‌کند. مشارکت‌کنندگان زیر این مقاله را نوشته‌اند.

**نویسنده اصلی:**

*   John Downs | مهندس نرم‌افزار ارشد

**سایر مشارکت‌کنندگان:**

*   Chad Kittel | مهندس نرم‌افزار ارشد، الگوها و شیوه‌های Azure
*   Paolo Salvatori | مهندس ارشد مشتری، FastTrack برای Azure
*   Daniel Scott-Raynsford | استراتژیست فناوری شرکا
*   Arsen Vladimirskiy | مهندس ارشد مشتری، FastTrack برای Azure

*برای مشاهده پروفایل‌های غیرعمومی لینکدین، وارد لینکدین شوید.*

---

##### **منابع مرتبط**
*   ملاحظات معماری برای یک راه‌حل چندمستأجری
*   بهترین شیوه‌های مدیریت خطای گذرا
