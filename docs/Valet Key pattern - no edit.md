از token ای استفاده کنید که دسترسی مستقیم و محدودی به یک منبع خاص را برای کلاینت‌ها فراهم می کند تا انتقال داده را از برنامه خالی کنند. این به ویژه در برنامه‌هایی که از سیستم‌های ذخیره‌سازی میزبان ابری(cloud-hosted) یا صف‌ها استفاده می‌کنند مفید است و می‌تواند هزینه را به حداقل برساند و مقیاس‌پذیری و کارایی را به حداکثر برساند.

## Context and problem

برنامه‌های سرویس گیرنده و مرورگرهای وب اغلب نیاز به خواندن و نوشتن فایل‌ها یا جریان‌های داده به و از فضای ذخیره‌سازی برنامه دارند. به طور معمول، برنامه حرکت داده‌ها را کنترل می‌کند – یا با واکشی آن‌ها از ذخیره‌سازی و پخش جریانی آن به مشتری، یا با خواندن جریان آپلود شده از مشتری و ذخیره آن در فروشگاه داده. با این حال، این رویکرد منابع ارزشمندی مانند محاسبات، حافظه و پهنای باند را جذب می کند.

فروشگاه‌های داده این توانایی را دارند که مستقیماً بارگذاری و بارگیری داده‌ها را مدیریت کنند، بدون اینکه برنامه‌ای برای انتقال این داده‌ها نیازی به پردازش انجام دهد. اما، این معمولاً مستلزم دسترسی مشتری به اعتبارنامه امنیتی فروشگاه است. این می تواند یک تکنیک مفید برای به حداقل رساندن هزینه های انتقال داده و نیاز به مقیاس بزرگ کردن برنامه و به حداکثر رساندن عملکرد باشد. اما به این معنی است که برنامه دیگر قادر به مدیریت امنیت داده ها نیست. پس از اینکه مشتری برای دسترسی مستقیم به فروشگاه داده متصل شد، برنامه نمی تواند به عنوان دروازه بان عمل کند. دیگر کنترل فرآیند را در دست ندارد و نمی‌تواند از آپلود یا دانلودهای بعدی از فروشگاه داده جلوگیری کند.

این یک رویکرد واقع بینانه در سیستم های توزیع شده ای نیست که باید به مشتریان غیر قابل اعتماد خدمت کنند. درعوض، برنامه‌ها باید بتوانند به‌طور ایمن دسترسی به داده‌ها را به صورت دانه‌بندی کنترل کنند، اما همچنان با راه‌اندازی این اتصال، بار روی سرور را کاهش دهند و سپس به مشتری اجازه دهند مستقیماً با ذخیره‌گاه داده ارتباط برقرار کند تا عملیات خواندن یا نوشتن مورد نیاز را انجام دهد. .


## Solution

شما باید مشکل کنترل دسترسی به یک فروشگاه داده را که در آن فروشگاه نمی تواند احراز هویت و مجوز مشتریان را مدیریت کند، حل کنید. یک راه حل معمولی محدود کردن دسترسی به اتصال عمومی فروشگاه داده و ارائه کلید یا نشانه ای به مشتری است که فروشگاه داده می تواند اعتبار سنجی کند.

این کلید یا نشانه معمولاً به عنوان کلید نوکر شناخته می شود. دسترسی محدود به منابع خاص را فراهم می کند و فقط عملیات از پیش تعریف شده مانند خواندن و نوشتن در فضای ذخیره سازی یا صف ها، یا آپلود و دانلود در یک مرورگر وب را امکان پذیر می کند. برنامه‌ها می‌توانند کلیدهای نوکر را به سرعت و به آسانی برای دستگاه‌های سرویس گیرنده و مرورگرهای وب ایجاد و صادر کنند و به مشتریان این امکان را می‌دهند تا عملیات مورد نیاز را بدون نیاز به برنامه کاربردی برای مدیریت مستقیم انتقال داده انجام دهند. این امر سربار پردازش و تأثیر بر عملکرد و مقیاس پذیری را از برنامه و سرور حذف می کند.

کلاینت از این نشانه برای دسترسی به یک منبع خاص در فروشگاه داده فقط برای یک دوره خاص و با محدودیت های خاص در مجوزهای دسترسی استفاده می کند، همانطور که در شکل نشان داده شده است. پس از مدت زمان مشخص شده، کلید نامعتبر می شود و اجازه دسترسی به منبع را نمی دهد.


![[Pasted image 20231130231411.png]]

همچنین می توان کلیدی را پیکربندی کرد که وابستگی های دیگری مانند محدوده داده ها داشته باشد. برای مثال، بسته به قابلیت‌های ذخیره‌سازی داده، کلید می‌تواند یک جدول کامل در یک فروشگاه داده یا فقط ردیف‌های خاص در یک جدول را مشخص کند. در سیستم‌های ذخیره‌سازی ابری، کلید می‌تواند یک ظرف یا فقط یک آیتم خاص را در یک ظرف مشخص کند.

کلید همچنین می تواند توسط برنامه باطل شود. اگر مشتری به سرور اطلاع دهد که عملیات انتقال داده کامل شده است، این یک رویکرد مفید است. سپس سرور می تواند برای جلوگیری از دسترسی بیشتر، آن کلید را باطل کند.

استفاده از این الگو می‌تواند مدیریت دسترسی به منابع را ساده‌تر کند، زیرا نیازی به ایجاد و احراز هویت کاربر، اعطای مجوزها و سپس حذف مجدد کاربر وجود ندارد. همچنین محدود کردن مکان، مجوز و دوره اعتبار را آسان می کند - همه اینها با تولید یک کلید در زمان اجرا. عوامل مهم این است که مدت اعتبار و به ویژه محل منبع را تا حد امکان محدود کنید تا گیرنده فقط بتواند از آن برای هدف مورد نظر استفاده کند.

---------
p1
------------


## Issues and considerations

هنگام تصمیم گیری در مورد نحوه اجرای این الگو به نکات زیر توجه کنید:

وضعیت اعتبار و دوره کلید را مدیریت کنید. در صورت لو رفتن یا به خطر افتادن، کلید به طور موثر مورد هدف را باز می کند و آن را برای استفاده مخرب در طول دوره اعتبار در دسترس قرار می دهد. بسته به نحوه صدور، یک کلید معمولاً می تواند باطل یا غیرفعال شود. خط‌مشی‌های سمت سرور را می‌توان تغییر داد یا کلید سروری که با آن امضا شده است را می‌توان باطل کرد. یک دوره اعتبار کوتاه را برای به حداقل رساندن خطر اجازه دادن به عملیات غیرمجاز در برابر ذخیره داده مشخص کنید. با این حال، اگر مدت اعتبار خیلی کوتاه باشد، مشتری ممکن است نتواند عملیات را قبل از انقضای کلید کامل کند. در صورت نیاز به دسترسی های متعدد به منبع محافظت شده، به کاربران مجاز اجازه دهید تا قبل از پایان دوره اعتبار، کلید را تمدید کنند.

سطح دسترسی کلید را کنترل کنید. به طور معمول، کلید باید به کاربر اجازه دهد که فقط اقدامات لازم برای تکمیل عملیات را انجام دهد، مانند دسترسی فقط خواندنی اگر مشتری نتواند داده‌ها را در فروشگاه داده آپلود کند. برای آپلود فایل، مشخص کردن کلیدی که مجوز فقط نوشتن و همچنین مکان و مدت اعتبار را فراهم می کند، معمول است. تعیین دقیق منبع یا مجموعه منابعی که کلید برای آنها اعمال می شود بسیار مهم است.

نحوه کنترل رفتار کاربران را در نظر بگیرید. اجرای این الگو به معنای از دست دادن کنترل منابعی است که کاربران به آنها دسترسی دارند. سطح کنترلی که می‌تواند اعمال شود، توسط قابلیت‌های خط‌مشی‌ها و مجوزهای موجود برای سرویس یا ذخیره‌گاه داده هدف محدود می‌شود. به عنوان مثال، معمولاً نمی‌توان کلیدی ایجاد کرد که اندازه داده‌هایی را که باید برای ذخیره‌سازی نوشته شوند، یا تعداد دفعاتی که می‌توان از کلید برای دسترسی به یک فایل استفاده کرد، محدود کند. این امر می‌تواند منجر به هزینه‌های غیرمنتظره هنگفتی برای انتقال داده شود، حتی زمانی که مشتری مورد نظر از آن استفاده می‌کند، و ممکن است ناشی از خطا در کد باشد که باعث بارگذاری یا دانلود مکرر می‌شود. برای محدود کردن تعداد دفعاتی که یک فایل می‌تواند آپلود شود، در صورت امکان، مشتری را مجبور کنید که پس از اتمام یک عملیات به برنامه اطلاع دهد. به عنوان مثال، برخی از فروشگاه های داده رویدادهایی را افزایش می دهند که کد برنامه می تواند از آنها برای نظارت بر عملیات و کنترل رفتار کاربر استفاده کند. با این حال، در سناریوی چند مستاجر که در آن همه کاربران از یک مستاجر از یک کلید استفاده می‌کنند، اجرای سهمیه‌ها برای تک تک کاربران سخت است.

تمام داده های آپلود شده را اعتبارسنجی و به صورت اختیاری پاکسازی کنید. یک کاربر مخرب که به کلید دسترسی پیدا می کند می تواند داده هایی را که برای به خطر انداختن سیستم طراحی شده اند بارگذاری کند. از طرف دیگر، کاربران مجاز ممکن است داده‌هایی را آپلود کنند که نامعتبر است و در صورت پردازش، ممکن است منجر به خطا یا خرابی سیستم شود. برای محافظت در برابر این، اطمینان حاصل کنید که تمام داده‌های آپلود شده قبل از استفاده اعتبارسنجی شده و از نظر محتوای مخرب بررسی می‌شوند.

حسابرسی کلیه عملیات بسیاری از مکانیسم‌های مبتنی بر کلید می‌توانند عملیات‌هایی مانند آپلود، دانلود و خرابی را ثبت کنند. این گزارش‌ها معمولاً می‌توانند در یک فرآیند ممیزی گنجانده شوند، و همچنین در صورتی که کاربر بر اساس اندازه فایل یا حجم داده‌ها هزینه دریافت می‌کند، برای صورت‌حساب استفاده شود. از گزارش‌ها برای شناسایی خرابی‌های احراز هویت که ممکن است به دلیل مشکلات ارائه‌دهنده کلید یا حذف تصادفی یک خط‌مشی دسترسی ذخیره‌شده ایجاد شود، استفاده کنید.

کلید را ایمن تحویل دهید. می‌توان آن را در یک URL که کاربر در یک صفحه وب فعال می‌کند جاسازی کرد، یا می‌توان از آن در عملیات تغییر مسیر سرور استفاده کرد تا دانلود به‌طور خودکار انجام شود. همیشه از HTTPS برای تحویل کلید از طریق یک کانال امن استفاده کنید.

محافظت از داده های حساس در حین حمل و نقل داده‌های حساسی که از طریق برنامه ارائه می‌شوند معمولاً با استفاده از TLS انجام می‌شوند و این باید برای مشتریانی که مستقیماً به فروشگاه داده دسترسی دارند اعمال شود.

-------------
p2
-----------------

موارد دیگری که در اجرای این الگو باید از آنها آگاه بود عبارتند از:

اگر کلاینت نتواند یا نتواند به سرور از اتمام عملیات اطلاع دهد و تنها محدودیت آن دوره انقضای کلید باشد، برنامه قادر به انجام عملیات ممیزی مانند شمارش تعداد آپلود یا دانلود، یا جلوگیری از بارگذاری یا دانلود چندگانه.

انعطاف‌پذیری سیاست‌های کلیدی قابل ایجاد ممکن است محدود باشد. به عنوان مثال، برخی مکانیسم ها فقط استفاده از یک دوره انقضای زمان بندی شده را مجاز می دانند. دیگران قادر به تعیین جزئیات کافی از مجوزهای خواندن/نوشتن نیستند.

اگر زمان شروع برای دوره اعتبار کلید یا نشانه مشخص شده است، مطمئن شوید که کمی زودتر از زمان سرور فعلی باشد تا ساعت‌های کلاینت که ممکن است کمی از همگام‌سازی خارج شده باشند. پیش فرض، اگر مشخص نشده باشد، معمولاً زمان فعلی سرور است.

URL حاوی کلید در فایل های گزارش سرور ثبت می شود. در حالی که کلید معمولاً قبل از استفاده از فایل های گزارش برای تجزیه و تحلیل منقضی می شود، اطمینان حاصل کنید که دسترسی به آنها را محدود کرده اید. اگر داده‌های گزارش به یک سیستم مانیتورینگ منتقل می‌شوند یا در مکان دیگری ذخیره می‌شوند، برای جلوگیری از نشت کلیدها تا پایان دوره اعتبار آن‌ها، تاخیری را در نظر بگیرید.

اگر کد مشتری در یک مرورگر وب اجرا می‌شود، ممکن است مرورگر نیاز به پشتیبانی از اشتراک‌گذاری منابع متقاطع (CORS) داشته باشد تا کدی را که در مرورگر وب اجرا می‌شود برای دسترسی به داده‌ها در دامنه‌ای متفاوت از دامنه‌ای که صفحه ارائه می‌کند، فعال کند. برخی از مرورگرهای قدیمی و برخی از فروشگاه‌های داده از CORS پشتیبانی نمی‌کنند و ممکن است کدی که در این مرورگرها اجرا می‌شود، نتواند از کلید نوبت برای دسترسی به داده‌ها در دامنه‌های مختلف، مانند حساب ذخیره‌سازی ابری، استفاده کند.

## When to use this pattern

این الگو برای شرایط زیر مفید است:

برای به حداقل رساندن بارگذاری منابع و به حداکثر رساندن عملکرد و مقیاس پذیری. استفاده از کلید نوکر نیازی به قفل شدن منبع ندارد، نیازی به تماس سرور از راه دور نیست، محدودیتی در تعداد کلیدهای نوبت دهی وجود ندارد و از یک نقطه خرابی ناشی از انجام انتقال داده ها جلوگیری می کند. کد برنامه ایجاد یک کلید نوکر معمولاً یک عملیات رمزنگاری ساده برای امضای یک رشته با یک کلید است.

برای به حداقل رساندن هزینه های عملیاتی فعال کردن دسترسی مستقیم به فروشگاه‌ها و صف‌ها منابع و مقرون به صرفه است، می‌تواند منجر به رفت و برگشت شبکه کمتر شود و ممکن است امکان کاهش تعداد منابع محاسباتی مورد نیاز را فراهم کند.


زمانی که کلاینت ها به طور منظم داده ها را آپلود یا دانلود می کنند، به خصوص در جاهایی که حجم زیادی وجود دارد یا زمانی که هر عملیات شامل فایل های بزرگ است.

زمانی که برنامه دارای منابع محاسباتی محدودی است، چه به دلیل محدودیت های میزبانی یا ملاحظات هزینه. در این سناریو، اگر بارگذاری یا بارگیری همزمان داده های زیادی وجود داشته باشد، الگو حتی مفیدتر است زیرا برنامه را از مدیریت انتقال داده راحت می کند.

هنگامی که داده ها در یک فروشگاه داده از راه دور یا یک مرکز داده دیگر ذخیره می شوند. اگر برنامه لازم بود به عنوان دروازه‌بان عمل کند، ممکن است هزینه‌ای برای پهنای باند اضافی انتقال داده‌ها بین دیتاسنترها، یا از طریق شبکه‌های عمومی یا خصوصی بین مشتری و برنامه، و سپس بین برنامه و ذخیره‌گاه داده، وجود داشته باشد.


--------------
p3
--------------


این الگو ممکن است در شرایط زیر مفید نباشد:

اگر برنامه باید قبل از ذخیره یا قبل از ارسال به مشتری، برخی از کارها را روی داده ها انجام دهد. به عنوان مثال، اگر برنامه نیاز به اعتبار سنجی داشته باشد، دسترسی به گزارش موفقیت آمیز باشد، یا تغییری روی داده ها اجرا کند. با این حال، برخی از فروشگاه های داده و مشتریان قادر به مذاکره و انجام تغییرات ساده مانند فشرده سازی و رفع فشار هستند (به عنوان مثال، یک مرورگر وب معمولاً می تواند فرمت های gzip را مدیریت کند).

اگر طراحی یک برنامه کاربردی موجود، ترکیب الگو را دشوار کند. استفاده از این الگو معمولاً نیازمند یک رویکرد معماری متفاوت برای تحویل و دریافت داده است.

اگر لازم است مسیرهای حسابرسی را حفظ کنید یا تعداد دفعات اجرای عملیات انتقال داده را کنترل کنید، و مکانیسم کلید نوکر در حال استفاده از اعلان‌هایی که سرور می‌تواند برای مدیریت این عملیات استفاده کند، پشتیبانی نمی‌کند.

اگر لازم است اندازه داده ها را محدود کنید، به خصوص در طول عملیات آپلود. تنها راه حل این است که برنامه پس از اتمام عملیات، اندازه داده ها را بررسی کند، یا اندازه آپلودها را پس از یک دوره مشخص یا بر اساس برنامه زمان بندی شده بررسی کند.

## Example

Azure از امضاهای دسترسی مشترک در Azure Storage برای کنترل دسترسی دانه‌ای به داده‌ها در حباب‌ها، جداول و صف‌ها و برای صف‌ها و موضوعات سرویس Bus پشتیبانی می‌کند. یک نشانه امضای دسترسی مشترک را می توان برای ارائه حقوق دسترسی خاص مانند خواندن، نوشتن، به روز رسانی و حذف در یک جدول خاص پیکربندی کرد. یک محدوده کلیدی در یک جدول؛ یک صف؛ یک لکه؛ یا ظرف لکه ای اعتبار می تواند یک دوره زمانی مشخص یا بدون محدودیت زمانی باشد.

امضاهای دسترسی اشتراکی Azure همچنین از سیاست های دسترسی ذخیره شده در سرور پشتیبانی می کنند که می توانند با یک منبع خاص مانند جدول یا حباب مرتبط شوند. این ویژگی در مقایسه با توکن‌های امضای دسترسی اشتراکی تولید شده توسط برنامه، کنترل و انعطاف‌پذیری بیشتری را فراهم می‌کند و باید در صورت امکان استفاده شود. تنظیمات تعریف شده در یک خط مشی ذخیره شده در سرور را می توان تغییر داد و بدون نیاز به صدور توکن جدید در توکن منعکس می شود، اما تنظیمات تعریف شده در توکن بدون صدور توکن جدید قابل تغییر نیستند. این رویکرد همچنین امکان لغو یک نشانه امضای دسترسی مشترک معتبر را قبل از منقضی شدن آن فراهم می‌کند.

در نهایت، ایجاد امضاهای دسترسی مشترک را می توان با یک کلید واگذاری کاربر به جای استفاده از کلید حساب ذخیره سازی انجام داد. این روش از Microsoft Entra ID استفاده می کند و فقط Blob Storage را پشتیبانی می کند. هنگامی که Blob Storage تنها سرویسی است که به آن دسترسی دارید، این راه حل ترجیحی است.

> برای اطلاعات بیشتر، به اعطای دسترسی محدود به منابع ذخیره‌سازی Azure با استفاده از امضاهای دسترسی مشترک (SAS) مراجعه کنید.


کد زیر نحوه ایجاد یک نشانه امضای دسترسی اشتراکی را نشان می دهد که پنج دقیقه معتبر است. متد GetSharedAccessReferenceForUpload یک نشانه امضای دسترسی مشترک را برمی گرداند که می تواند برای آپلود یک فایل در Azure Blob Storage استفاده شود.

```csharp
[ApiController] public class SasController : ControllerBase { private readonly string blobContainer = "valetkeysample"; private readonly string blobEndpoint = "https://<StorageAccountName>.blob.core.windows.net"; ... /// <summary> /// Return a limited access key that allows the caller to upload a file /// to this specific destination for about the next five minutes. /// </summary> private async Task<StorageEntitySas> GetSharedAccessReferenceForUpload(string blobName) { var blobServiceClient = new BlobServiceClient(new Uri(blobEndpoint), new DefaultAzureCredential()); var blobContainerClient = blobServiceClient.GetBlobContainerClient(this.blobContainer); var blobClient = blobContainerClient.GetBlobClient(blobName); UserDelegationKey key = await blobServiceClient.GetUserDelegationKeyAsync(DateTimeOffset.UtcNow, DateTimeOffset.UtcNow.AddDays(1)); var blobSasBuilder = new BlobSasBuilder { BlobContainerName = blobClient.BlobContainerName, BlobName = blobClient.Name, Resource = "b", StartsOn = DateTimeOffset.UtcNow.AddMinutes(-5), ExpiresOn = DateTimeOffset.UtcNow.AddMinutes(5) }; blobSasBuilder.SetPermissions(BlobSasPermissions.Write); var storageSharedKeySignature = blobSasBuilder.ToSasQueryParameters(key, blobServiceClient.AccountName).ToString(); return new StorageEntitySas { BlobUri = blobClient.Uri, Signature = storageSharedKeySignature }; } public class StorageEntitySas { public string? Signature { get; internal set; } public Uri? BlobUri { get; internal set; } } }
```

نمونه کامل در راه حل ValetKey موجود برای دانلود از GitHub موجود است. پروژه ValetKey.Web در این راه حل شامل یک برنامه وب است که شامل کلاس SasController است که در بالا نشان داده شده است. یک نمونه برنامه مشتری که از این برنامه وب برای بازیابی کلید امضاهای دسترسی مشترک و آپلود یک فایل در فضای ذخیره سازی حباب استفاده می کند، در پروژه ValetKey.Client موجود است.

## Next steps

The following guidance might be relevant when implementing this pattern:

- A sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).
- [Grant limited access to Azure Storage resources using shared access signatures (SAS)](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)
- [Shared Access Signature Authentication with Service Bus](https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-sas)
## Related resources
الگوی دروازه بان. این الگو را می توان همراه با الگوی Valet Key برای محافظت از برنامه ها و خدمات با استفاده از یک نمونه میزبان اختصاصی که به عنوان یک واسطه بین مشتریان و برنامه یا سرویس عمل می کند، استفاده کرد. دروازه‌بان درخواست‌ها را اعتبارسنجی و پاکسازی می‌کند و درخواست‌ها و داده‌ها را بین مشتری و برنامه ارسال می‌کند. می تواند یک لایه امنیتی اضافی را فراهم کند و سطح حمله سیستم را کاهش دهد.
الگوی میزبانی محتوای ثابت نحوه استقرار منابع استاتیک در یک سرویس ذخیره سازی مبتنی بر ابر را شرح می دهد که می تواند این منابع را مستقیماً به مشتری تحویل دهد تا نیاز به نمونه های محاسباتی گران قیمت را کاهش دهد. در مواردی که قرار نیست منابع به صورت عمومی در دسترس باشند، می توان از الگوی Valet Key برای ایمن سازی آنها استفاده کرد.

